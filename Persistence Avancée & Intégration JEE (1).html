<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÃ©ances 5-8 FusionnÃ©es : Persistence AvancÃ©e & IntÃ©gration JEE - Guide Complet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.8;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 50px 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.3em;
            opacity: 0.95;
            margin: 10px 0;
        }

        .content {
            padding: 50px;
        }

        .section {
            margin-bottom: 60px;
        }

        h2 {
            color: #667eea;
            font-size: 2.2em;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 4px solid #667eea;
        }

        h3 {
            color: #764ba2;
            font-size: 1.8em;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-left: 15px;
            border-left: 5px solid #764ba2;
        }

        h4 {
            color: #555;
            font-size: 1.4em;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        p {
            margin-bottom: 20px;
            text-align: justify;
            font-size: 1.1em;
            line-height: 1.9;
        }

        . intro-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 30px;
            border-radius: 12px;
            margin: 30px 0;
            border-left: 6px solid #667eea;
        }

        .intro-box h3 {
            margin-top: 0;
            color: #667eea;
            border: none;
            padding: 0;
        }

        .objectifs {
            background: #f0f4ff;
            padding: 30px;
            border-radius: 12px;
            border-left: 6px solid #667eea;
            margin: 30px 0;
        }

        .objectifs h3 {
            margin-top: 0;
            border: none;
            padding: 0;
        }

        . objectifs ul {
            margin-left: 25px;
            margin-top: 15px;
        }

        . objectifs li {
            margin: 12px 0;
            padding-left: 10px;
            font-size: 1.05em;
        }

        .concept-box {
            background: #fff9e6;
            border-left: 6px solid #ffc107;
            padding: 25px;
            margin: 25px 0;
            border-radius: 8px;
        }

        .concept-box h4 {
            color: #f57c00;
            margin-top: 0;
            margin-bottom: 15px;
        }

        . explanation {
            background: #e8f5e9;
            border-left: 6px solid #4caf50;
            padding: 25px;
            margin: 25px 0;
            border-radius: 8px;
        }

        .explanation h4 {
            color: #2e7d32;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .example-box {
            background: #e1f5fe;
            border-left: 6px solid #03a9f4;
            padding: 25px;
            margin: 25px 0;
            border-radius: 8px;
        }

        .example-box h4 {
            color: #0277bd;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .warning-box {
            background: #ffebee;
            border-left: 6px solid #f44336;
            padding: 25px;
            margin: 25px 0;
            border-radius: 8px;
        }

        .warning-box h4 {
            color: #c62828;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .tip-box {
            background: #f3e5f5;
            border-left: 6px solid #9c27b0;
            padding: 25px;
            margin: 25px 0;
            border-radius: 8px;
        }

        .tip-box h4 {
            color: #7b1fa2;
            margin-top: 0;
            margin-bottom: 15px;
        }

        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 25px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 25px 0;
            font-size: 0.95em;
            line-height: 1.6;
            border: 3px solid #667eea;
        }

        code {
            font-family: 'Courier New', Courier, monospace;
        }

        .inline-code {
            background: #f4f4f4;
            padding: 3px 8px;
            border-radius: 4px;
            color: #c7254e;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.95em;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: #667eea;
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
            font-size: 1.05em;
        }

        td {
            padding: 15px 18px;
            border-bottom: 1px solid #ddd;
            font-size: 1.02em;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .comparison-table {
            margin: 35px 0;
        }

        .tp-section {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 40px;
            border-radius: 12px;
            margin: 40px 0;
            border: 3px solid #667eea;
        }

        .tp-section h2 {
            color: #764ba2;
        }

        .step {
            background: white;
            padding: 30px;
            margin: 25px 0;
            border-radius: 10px;
            border-left: 6px solid #667eea;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .step h4 {
            color: #667eea;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .architecture-diagram {
            background: white;
            padding: 35px;
            border-radius: 12px;
            text-align: center;
            margin: 35px 0;
            border: 3px dashed #667eea;
        }

        .quiz {
            background: #f0f4ff;
            padding: 35px;
            border-radius: 12px;
            margin: 40px 0;
        }

        .quiz-question {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 6px solid #764ba2;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .quiz-question h4 {
            color: #764ba2;
            margin-bottom: 18px;
            font-size: 1.2em;
        }

        . quiz-options {
            margin-left: 25px;
            margin-top: 15px;
        }

        .quiz-options label {
            display: block;
            margin: 12px 0;
            cursor: pointer;
            font-size: 1.05em;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .quiz-options label:hover {
            background: #f0f4ff;
        }

        . quiz-options input[type="radio"] {
            margin-right: 12px;
        }

        footer {
            background: #2d2d2d;
            color: white;
            text-align: center;
            padding: 30px;
            margin-top: 60px;
        }

        .highlight {
            background: #ffeb3b;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        ul, ol {
            margin-left: 35px;
            margin-bottom: 20px;
        }

        li {
            margin: 12px 0;
            font-size: 1.05em;
        }

        . tech-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin: 35px 0;
        }

        .tech-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-top: 5px solid #667eea;
        }

        .tech-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .tech-card h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        . tech-card p {
            text-align: center;
            font-size: 1.02em;
        }

        .note {
            background: #fff3e0;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 5px solid #ff9800;
        }

        .note strong {
            color: #e65100;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .content {
                padding: 25px;
            }

            header h1 {
                font-size: 2em;
            }

            h2 {
                font-size: 1.7em;
            }

            h3 {
                font-size: 1.4em;
            }

            pre {
                font-size: 0.85em;
                padding: 15px;
            }
        }

        . code-explanation {
            background: #e8eaf6;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 5px solid #3f51b5;
        }

        .code-explanation h5 {
            color: #3f51b5;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        . step-by-step {
            counter-reset: step-counter;
            list-style: none;
            margin-left: 0;
        }

        .step-by-step li {
            counter-increment: step-counter;
            margin: 20px 0;
            padding-left: 60px;
            position: relative;
        }

        .step-by-step li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .visual-box {
            background: white;
            border: 3px solid #667eea;
            padding: 30px;
            margin: 30px 0;
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <p>Persistence AvancÃ©e & IntÃ©gration JEE ComplÃ¨te</p>
            
        </header>

        <div class="content">
            <!-- Introduction GÃ©nÃ©rale -->
            <div class="intro-box">
               
                <p><strong>Structure du document :</strong></p>
                <ul>
                    <li><strong>Partie 1</strong> : Persistence JPA AvancÃ©e (relations, hÃ©ritage, caching, requÃªtes)</li>
                    <li><strong>Partie 2</strong> : NoSQL & MongoDB (pourquoi, comment, quand l'utiliser)</li>
                    <li><strong>Partie 3</strong> : Polyglot Persistence & Transactions DistribuÃ©es (combiner SQL et NoSQL)</li>
                    <li><strong>Partie 4</strong> : Architecture MVC & IntÃ©gration ComplÃ¨te (assembler tous les composants)</li>
                    <li><strong>TP Final</strong> : Projet pratique complet qui utilise tous ces concepts</li>
                </ul>

              
            </div>

            <!-- Table des matiÃ¨res -->
            <div class="section">
                <h2>ğŸ“š Table des MatiÃ¨res</h2>
                <ol style="font-size: 1.1em; line-height: 2;">
                    <li><a href="#partie1" style="color: #667eea; text-decoration: none; font-weight: 600;">Persistence JPA AvancÃ©e</a></li>
                    <li><a href="#partie2" style="color: #667eea; text-decoration: none; font-weight: 600;">NoSQL & MongoDB</a></li>
                    <li><a href="#partie3" style="color: #667eea; text-decoration: none; font-weight: 600;">Polyglot Persistence & JTA</a></li>
                    <li><a href="#partie4" style="color: #667eea; text-decoration: none; font-weight: 600;">Architecture MVC & IntÃ©gration</a></li>
                    <li><a href="#tp" style="color: #667eea; text-decoration: none; font-weight: 600;">TP Final : Dashboard d'Analyse de Logs</a></li>
                    <li><a href="#quiz" style="color: #667eea; text-decoration: none; font-weight: 600;">Quiz de RÃ©vision</a></li>
                </ol>
            </div>

            <!-- Objectifs Globaux -->
            <div class="objectifs">
                <h3>Objectifs PÃ©dagogiques Globaux</h3>
                <p>Ã€ la fin de ce cours fusionnÃ©, vous serez capable de :</p>
                <ul>
                    <li><strong>Comprendre et implÃ©menter JPA avancÃ©</strong> : gÃ©rer des relations complexes entre entitÃ©s, utiliser l'hÃ©ritage, optimiser les performances avec le caching</li>
                    <li><strong>MaÃ®triser NoSQL avec MongoDB</strong> : savoir quand utiliser MongoDB plutÃ´t qu'une base SQL, Ã©crire des requÃªtes et des agrÃ©gations</li>
                    <li><strong>Concevoir une architecture polyglotte</strong> : combiner PostgreSQL et MongoDB dans une mÃªme application pour tirer parti des forces de chaque technologie</li>
                    <li><strong>Garantir la cohÃ©rence des donnÃ©es</strong> : utiliser JTA pour les transactions distribuÃ©es, comprendre les limites et alternatives (Saga Pattern)</li>
                    <li><strong>Architecturer proprement une application JEE</strong> : sÃ©parer les responsabilitÃ©s avec MVC, DAO, Service Layer</li>
                    <li><strong>IntÃ©grer toutes les technologies</strong> : Servlets, JSP, JSTL, EJB, JPA, MongoDB dans un projet complet</li>
                </ul>
            </div>

            <!-- ============================================ -->
            <!-- PARTIE 1 : JPA AVANCÃ‰ -->
            <!-- ============================================ -->
            <div id="partie1" class="section">
                <h2>1ï¸âƒ£ Persistence JPA AvancÃ©e</h2>

                <div class="intro-box">
                    <h3>ğŸ” Pourquoi "JPA AvancÃ©" ?</h3>
                    <p>Dans les sÃ©ances prÃ©cÃ©dentes, vous avez appris les bases de JPA : crÃ©er des entitÃ©s avec <span class="inline-code">@Entity</span>, les persister avec <span class="inline-code">EntityManager</span>, faire des requÃªtes simples.  Mais dans un projet rÃ©el, vous allez rencontrer des besoins plus complexes :</p>
                    <ul>
                        <li><strong>Relations entre tables</strong> : Comment gÃ©rer un dÃ©partement qui a plusieurs employÃ©s ?  Un Ã©tudiant inscrit Ã  plusieurs cours ?</li>
                        <li><strong>HÃ©ritage</strong> : Comment reprÃ©senter une hiÃ©rarchie de classes (ex: Paiement â†’ PaiementCarte, PaiementPayPal) en base de donnÃ©es ?</li>
                        <li><strong>Performance</strong> : Comment Ã©viter que votre application fasse 1000 requÃªtes SQL au lieu de 10 ?</li>
                        <li><strong>RequÃªtes complexes</strong> : Comment faire des jointures, des agrÃ©gations, des filtres multiples ?</li>
                    </ul>
                    <p>C'est ce qu'on va voir dans cette partie. </p>
                </div>

                <h3>1. 1 Architecture JPA : Rappel et Approfondissement</h3>

                <div class="explanation">
                    <h4>ğŸ“– Qu'est-ce que JPA exactement ?</h4>
                    <p><strong>JPA (Java Persistence API)</strong> est une <strong>spÃ©cification</strong> Java qui dÃ©finit comment les objets Java doivent Ãªtre sauvegardÃ©s dans une base de donnÃ©es relationnelle.  C'est une <strong>abstraction</strong> : vous Ã©crivez du code Java, et JPA se charge de gÃ©nÃ©rer le SQL pour vous.</p>
                    
                    <p><strong>Hibernate</strong> est l'<strong>implÃ©mentation</strong> la plus populaire de JPA.  C'est comme la relation entre une interface et sa classe d'implÃ©mentation : JPA dit "quoi faire", Hibernate dit "comment le faire".</p>

                    <p><strong>Pourquoi c'est important ?</strong> Sans JPA, vous devriez Ã©crire du SQL manuellement pour chaque opÃ©ration (INSERT, SELECT, UPDATE, DELETE), gÃ©rer les connexions JDBC, mapper manuellement les rÃ©sultats vers des objets Java.  JPA automatise tout Ã§a.</p>
                </div>

                <div class="architecture-diagram">
                    <h4 style="color: #667eea; margin-bottom: 20px;">Architecture en Couches de JPA</h4>
                    <pre style="background: transparent; color: #333; text-align: left; font-size: 0.95em;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  APPLICATION JEE                            â”‚
â”‚  (Votre code Java : Servlets, EJB, Services...)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ENTITIES (@Entity)                             â”‚
â”‚  Classes Java annotÃ©es qui reprÃ©sentent vos tables          â”‚
â”‚  Ex: User. java, Order.java, Product.java                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ENTITY MANAGER                                 â”‚
â”‚  API JPA pour faire CRUD : persist(), find(), merge()...     â”‚
â”‚  C'est votre "pont" entre Java et la base de donnÃ©es        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PERSISTENCE UNIT (persistence.xml)                  â”‚
â”‚  Configuration : quelle base ?  quelles entitÃ©s ?  quel driver? â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              JDBC DRIVER                                    â”‚
â”‚  Driver spÃ©cifique Ã  votre base (PostgreSQL, MySQL...)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DATABASE (PostgreSQL, MySQL, Oracle...)             â”‚
â”‚  Stockage physique des donnÃ©es                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    </pre>
                </div>

                <div class="explanation">
                    <h4>ğŸ” Explication de chaque couche</h4>
                    <ul>
                        <li><strong>Entities</strong> : Vos classes Java avec <span class="inline-code">@Entity</span>. Chaque instance d'entitÃ© reprÃ©sente une ligne dans une table.</li>
                        <li><strong>EntityManager</strong> : L'objet principal de JPA. Il gÃ¨re le <strong>contexte de persistence</strong> (les objets chargÃ©s en mÃ©moire) et traduit vos opÃ©rations Java en SQL.</li>
                        <li><strong>Persistence Unit</strong> : DÃ©fini dans <span class="inline-code">persistence.xml</span>, c'est la configuration qui dit Ã  JPA quelle base de donnÃ©es utiliser, quelles entitÃ©s gÃ©rer, etc.</li>
                        <li><strong>JDBC Driver</strong> : BibliothÃ¨que Java qui sait parler Ã  votre base de donnÃ©es spÃ©cifique (chaque base a son propre protocole).</li>
                    </ul>
                </div>

                <h3>1.2 Relations AvancÃ©es Entre EntitÃ©s</h3>

                <div class="intro-box">
                    <h3>ğŸ¤” Pourquoi les relations sont compliquÃ©es ?</h3>
                    <p>Dans une base de donnÃ©es relationnelle, les tables sont liÃ©es entre elles par des <strong>clÃ©s Ã©trangÃ¨res</strong>. Par exemple, une table <span class="inline-code">employees</span> a une colonne <span class="inline-code">department_id</span> qui rÃ©fÃ©rence la table <span class="inline-code">departments</span>.</p>
                    
                    <p>En Java orientÃ© objet, on veut reprÃ©senter Ã§a avec des <strong>objets</strong> : un objet <span class="inline-code">Employee</span> devrait avoir un attribut <span class="inline-code">department</span> de type <span class="inline-code">Department</span>, et vice-versa.</p>

                    <p>JPA doit donc faire le <strong>mapping</strong> entre ces deux mondes : le monde relationnel (tables, clÃ©s) et le monde objet (classes, rÃ©fÃ©rences).  C'est lÃ  que les annotations comme <span class="inline-code">@OneToMany</span>, <span class="inline-code">@ManyToOne</span>, etc. entrent en jeu.</p>
                </div>

                <h4>A.  Relation One-to-Many Bidirectionnelle</h4>

                <div class="concept-box">
                    <h4>ğŸ’¡ Concept : Qu'est-ce qu'une relation One-to-Many ?</h4>
                    <p><strong>One-to-Many</strong> signifie qu'une entitÃ© (le "One") peut Ãªtre associÃ©e Ã  plusieurs instances d'une autre entitÃ© (le "Many"). Exemple classique : <strong>un dÃ©partement a plusieurs employÃ©s</strong>, mais <strong>un employÃ© appartient Ã  un seul dÃ©partement</strong>.</p>

                    <p><strong>Bidirectionnelle</strong> signifie qu'on peut naviguer dans les deux sens :</p>
                    <ul>
                        <li>Depuis un <span class="inline-code">Department</span>, je peux accÃ©der Ã  la liste de ses <span class="inline-code">Employee</span></li>
                        <li>Depuis un <span class="inline-code">Employee</span>, je peux accÃ©der Ã  son <span class="inline-code">Department</span></li>
                    </ul>
                </div>

                <div class="explanation">
                    <h4>ğŸ› ï¸ Comment JPA gÃ¨re Ã§a ?</h4>
                    <p>En base de donnÃ©es, il n'y a qu'<strong>une seule</strong> clÃ© Ã©trangÃ¨re : dans la table <span class="inline-code">employees</span>, une colonne <span class="inline-code">department_id</span>. </p>

                    <p>En Java, on veut deux rÃ©fÃ©rences :</p>
                    <ul>
                        <li><span class="inline-code">Employee</span> a un attribut <span class="inline-code">Department department</span></li>
                        <li><span class="inline-code">Department</span> a un attribut <span class="inline-code">List&lt;Employee&gt; employees</span></li>
                    </ul>

                    <p>Pour Ã©viter la confusion, JPA demande de dÃ©signer le <strong>"propriÃ©taire"</strong> de la relation (celui qui a la clÃ© Ã©trangÃ¨re) avec <span class="inline-code">@ManyToOne</span>, et l'<strong>"inverse"</strong> avec <span class="inline-code">@OneToMany(mappedBy="...")</span>.</p>
                </div>

<pre><code>// ====================================
// CÃ”TÃ‰ PARENT : Department (le "One")
// ====================================
@Entity
@Table(name = "departments")
public class Department {
    
    @Id
    @GeneratedValue(strategy = GenerationType. IDENTITY)
    private Long id;
    
    @Column(nullable = false, length = 100)
    private String name;
    
    // â­ RELATION ONE-TO-MANY
    // "mappedBy" indique que Employee est le propriÃ©taire de la relation
    // (c'est Employee qui a la clÃ© Ã©trangÃ¨re department_id)
    @OneToMany(
        mappedBy = "department",  // â† nom de l'attribut dans Employee
        cascade = CascadeType.ALL,  // â† si on supprime le dÃ©partement, supprimer les employÃ©s
        fetch = FetchType.LAZY,  // â† charger les employÃ©s seulement quand nÃ©cessaire
        orphanRemoval = true  // â† si on retire un employÃ© de la liste, le supprimer de la DB
    )
    private List&lt;Employee&gt; employees = new ArrayList&lt;&gt;();
    
    // â­ MÃ‰THODES HELPER pour maintenir la cohÃ©rence bidirectionnelle
    public void addEmployee(Employee employee) {
        employees.add(employee);
        employee.setDepartment(this);  // â† synchroniser l'autre cÃ´tÃ©
    }
    
    public void removeEmployee(Employee employee) {
        employees.remove(employee);
        employee.setDepartment(null);  // â† synchroniser l'autre cÃ´tÃ©
    }
    
    // Constructeurs, Getters, Setters
    public Department() {}
    
    public Department(String name) {
        this.name = name;
    }
    
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public List&lt;Employee&gt; getEmployees() { return employees; }
    public void setEmployees(List&lt;Employee&gt; employees) { this.employees = employees; }
}

// ======================================
// CÃ”TÃ‰ ENFANT : Employee (le "Many")
// ======================================
@Entity
@Table(name = "employees")
public class Employee {
    
    @Id
    @GeneratedValue(strategy = GenerationType. IDENTITY)
    private Long id;
    
    @Column(nullable = false, length = 100)
    private String name;
    
    @Column(nullable = false)
    private Double salary;
    
    // â­ RELATION MANY-TO-ONE
    // C'est ICI que se trouve la clÃ© Ã©trangÃ¨re en base de donnÃ©es
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "department_id")  // â† nom de la colonne FK en DB
    private Department department;
    
    // Constructeurs, Getters, Setters
    public Employee() {}
    
    public Employee(String name, Double salary) {
        this.name = name;
        this.salary = salary;
    }
    
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public Double getSalary() { return salary; }
    public void setSalary(Double salary) { this.salary = salary; }
    
    public Department getDepartment() { return department; }
    public void setDepartment(Department department) { this.department = department; }
}</code></pre>

                <div class="code-explanation">
                    <h5>ğŸ“ Explication ligne par ligne</h5>
                    <ul>
                        <li><strong>@OneToMany(mappedBy = "department")</strong> : Dit Ã  JPA "cette liste d'employÃ©s est gÃ©rÃ©e par l'attribut 'department' dans la classe Employee"</li>
                        <li><strong>cascade = CascadeType.ALL</strong> : Propage les opÃ©rations.  Si je fais <span class="inline-code">em.persist(department)</span>, les employÃ©s seront aussi sauvegardÃ©s automatiquement</li>
                        <li><strong>fetch = FetchType.LAZY</strong> : Ne charge pas les employÃ©s immÃ©diatement.  Ils seront chargÃ©s seulement quand on fait <span class="inline-code">department.getEmployees()</span></li>
                        <li><strong>orphanRemoval = true</strong> : Si je fais <span class="inline-code">department.getEmployees().remove(emp)</span>, l'employÃ© sera supprimÃ© de la base</li>
                        <li><strong>@ManyToOne</strong> : Indique que plusieurs employÃ©s peuvent avoir le mÃªme dÃ©partement</li>
                        <li><strong>@JoinColumn(name = "department_id")</strong> : SpÃ©cifie le nom exact de la colonne clÃ© Ã©trangÃ¨re en base</li>
                    </ul>
                </div>

                <div class="example-box">
                    <h4>âœ… Exemple d'utilisation</h4>
<pre><code>// CrÃ©er un dÃ©partement
Department it = new Department("IT");

// CrÃ©er des employÃ©s
Employee alice = new Employee("Alice", 50000.0);
Employee bob = new Employee("Bob", 55000.0);

// Ajouter les employÃ©s au dÃ©partement (en utilisant la mÃ©thode helper)
it.addEmployee(alice);
it.addEmployee(bob);

// Sauvegarder le dÃ©partement (les employÃ©s seront sauvegardÃ©s automatiquement grÃ¢ce Ã  cascade)
EntityManager em = ... ;
em.getTransaction().begin();
em.persist(it);
em.getTransaction().commit();

// Plus tard, rÃ©cupÃ©rer le dÃ©partement et ses employÃ©s
Department dept = em.find(Department.class, it.getId());
List&lt;Employee&gt; employees = dept. getEmployees();  // â† Charge les employÃ©s de la DB
System.out.println("Le dÃ©partement " + dept.getName() + " a " + employees.size() + " employÃ©s");</code></pre>
                </div>

                <div class="warning-box">
                    <h4>âš ï¸ PiÃ¨ges courants</h4>
                    <ul>
                        <li><strong>Oublier de synchroniser les deux cÃ´tÃ©s</strong> : Si vous faites <span class="inline-code">employee.setDepartment(dept)</span> sans faire <span class="inline-code">dept.getEmployees(). add(employee)</span>, la relation ne sera pas cohÃ©rente en mÃ©moire (mÃªme si en base de donnÃ©es Ã§a marchera).  Utilisez toujours les mÃ©thodes helper (<span class="inline-code">addEmployee()</span>).</li>
                        <li><strong>Boucle infinie dans toString()</strong> : Si <span class="inline-code">Department.toString()</span> affiche ses employÃ©s, et <span class="inline-code">Employee.toString()</span> affiche son dÃ©partement, vous aurez une boucle infinie.  Solution : n'incluez pas la relation dans <span class="inline-code">toString()</span>.</li>
                        <li><strong>LazyInitializationException</strong> : Si vous fermez l'EntityManager avant d'accÃ©der Ã  <span class="inline-code">dept.getEmployees()</span>, vous aurez une exception. Solution : utiliser <span class="inline-code">JOIN FETCH</span> (voir plus loin) ou accÃ©der aux employÃ©s avant de fermer l'EntityManager.</li>
                    </ul>
                </div>

                <h4>B. Relation Many-to-Many avec Table de Jointure</h4>

                <div class="concept-box">
                    <h4>ğŸ’¡ Concept : Many-to-Many</h4>
                    <p>Parfois, la relation est dans <strong>les deux sens</strong> "Many" :</p>
                    <ul>
                        <li>Un <strong>Ã©tudiant</strong> peut Ãªtre inscrit Ã  <strong>plusieurs cours</strong></li>
                        <li>Un <strong>cours</strong> peut avoir <strong>plusieurs Ã©tudiants</strong></li>
                    </ul>
                    <p>En base de donnÃ©es, on ne peut pas stocker Ã§a avec une simple clÃ© Ã©trangÃ¨re. On doit crÃ©er une <strong>table de jointure</strong> (aussi appelÃ©e "table d'association") qui stocke les paires (Ã©tudiant, cours).</p>
                </div>

                <div class="visual-box">
                    <h4 style="color: #667eea;">Structure en Base de DonnÃ©es</h4>
<pre style="background: #f5f5f5; color: #333; padding: 20px; border-radius: 8px;">
Table: students               Table: student_course          Table: courses
+-----------+---------+       +-----------+-----------+      +----------+-----------+
| id (PK)   | name    |       | student_id| course_id |      | id (PK)  | title     |
+-----------+---------+       | (FK)      | (FK)      |      +----------+-----------+
| 1         | Alice   |       +-----------+-----------+      | 1        | Math      |
| 2         | Bob     |       | 1         | 1         |      | 2        | Physics   |
| 3         | Charlie |       | 1         | 2         |      | 3        | Chemistry |
+-----------+---------+       | 2         | 1         |      +----------+-----------+
                              | 3         | 3         |
                              +-----------+-----------+

Lecture : Alice (1) est inscrite Ã  Math (1) et Physics (2)
          Bob (2) est inscrit Ã  Math (1)
          Charlie (3) est inscrit Ã  Chemistry (3)
</pre>
                </div>

<pre><code>// =====================================
// CLASSE STUDENT (CÃ´tÃ© propriÃ©taire)
// =====================================
@Entity
@Table(name = "students")
public class Student {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, length = 100)
    private String name;
    
    // â­ RELATION MANY-TO-MANY
    @ManyToMany(cascade = {CascadeType. PERSIST, CascadeType. MERGE})
    @JoinTable(
        name = "student_course",  // â† nom de la table de jointure
        joinColumns = @JoinColumn(name = "student_id"),  // â† colonne qui rÃ©fÃ©rence Student
        inverseJoinColumns = @JoinColumn(name = "course_id")  // â† colonne qui rÃ©fÃ©rence Course
    )
    private List&lt;Course&gt; courses = new ArrayList&lt;&gt;();
    
    // MÃ©thodes helper
    public void enrollInCourse(Course course) {
        courses.add(course);
        course.getStudents(). add(this);
    }
    
    public void dropCourse(Course course) {
        courses.remove(course);
        course.getStudents().remove(this);
    }
    
    // Constructeurs, Getters, Setters
    public Student() {}
    
    public Student(String name) {
        this.name = name;
    }
    
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public List&lt;Course&gt; getCourses() { return courses; }
    public void setCourses(List&lt;Course&gt; courses) { this.courses = courses; }
}

// ==================================
// CLASSE COURSE (CÃ´tÃ© inverse)
// ==================================
@Entity
@Table(name = "courses")
public class Course {
    
    @Id
    @GeneratedValue(strategy = GenerationType. IDENTITY)
    private Long id;
    
    @Column(nullable = false, length = 200)
    private String title;
    
    @Column(nullable = false)
    private Integer credits;
    
    // â­ RELATION MANY-TO-MANY (cÃ´tÃ© inverse)
    // "mappedBy" indique que Student gÃ¨re la relation
    @ManyToMany(mappedBy = "courses")
    private List&lt;Student&gt; students = new ArrayList&lt;&gt;();
    
    // Constructeurs, Getters, Setters
    public Course() {}
    
    public Course(String title, Integer credits) {
        this.title = title;
        this.credits = credits;
    }
    
    public Long getId() { return id; }
    public void setId(Long id) { this. id = id; }
    
    public String getTitle() { return title; }
    public void setTitle(String title) { this. title = title; }
    
    public Integer getCredits() { return credits; }
    public void setCredits(Integer credits) { this.credits = credits; }
    
    public List&lt;Student&gt; getStudents() { return students; }
    public void setStudents(List&lt;Student&gt; students) { this.students = students; }
}</code></pre>

                <div class="code-explanation">
                    <h5>ğŸ“ Explication dÃ©taillÃ©e</h5>
                    <ul>
                        <li><strong>@JoinTable</strong> : CrÃ©e la table de jointure.  JPA crÃ©era automatiquement une table <span class="inline-code">student_course</span> avec deux colonnes : <span class="inline-code">student_id</span> et <span class="inline-code">course_id</span></li>
                        <li><strong>joinColumns</strong> : Colonne qui rÃ©fÃ©rence l'entitÃ© "owner" (Student)</li>
                        <li><strong>inverseJoinColumns</strong> : Colonne qui rÃ©fÃ©rence l'autre entitÃ© (Course)</li>
                        <li><strong>cascade = {PERSIST, MERGE}</strong> : Propage seulement persist et merge (pas remove, car si on supprime un Ã©tudiant, on ne veut pas supprimer tous ses cours)</li>
                        <li><strong>mappedBy = "courses"</strong> : Dans Course, indique que Student gÃ¨re la relation (c'est Student qui a l'annotation @JoinTable)</li>
                    </ul>
                </div>

                <div class="example-box">
                    <h4>âœ… Exemple d'utilisation</h4>
<pre><code>// CrÃ©er des cours
Course math = new Course("Mathematics", 5);
Course physics = new Course("Physics", 4);
Course chemistry = new Course("Chemistry", 3);

// CrÃ©er des Ã©tudiants
Student alice = new Student("Alice");
Student bob = new Student("Bob");

// Inscrire Alice Ã  Math et Physics
alice.enrollInCourse(math);
alice.enrollInCourse(physics);

// Inscrire Bob Ã  Math
bob.enrollInCourse(math);

// Sauvegarder
EntityManager em = ...;
em. getTransaction().begin();
em. persist(math);
em.persist(physics);
em.persist(chemistry);
em.persist(alice);
em.persist(bob);
em.getTransaction(). commit();

// VÃ©rifier
System.out.println(alice.getName() + " est inscrit Ã  " + alice.getCourses().size() + " cours");
System.out. println("Le cours de " + math.getTitle() + " a " + math.getStudents().size() + " Ã©tudiants");</code></pre>
                </div>

                <h3>1. 3 StratÃ©gies d'HÃ©ritage JPA</h3>

                <div class="intro-box">
                    <h3>ğŸ¤” Le problÃ¨me de l'hÃ©ritage</h3>
                    <p>En Java, l'hÃ©ritage est naturel : vous pouvez avoir une classe <span class="inline-code">Payment</span> et des sous-classes <span class="inline-code">CreditCardPayment</span>, <span class="inline-code">PayPalPayment</span>, etc.</p>

                    <p>Mais en base de donnÃ©es relationnelle, <strong>il n'y a pas d'hÃ©ritage</strong> !  Il n'y a que des tables avec des colonnes.  Alors comment reprÃ©senter une hiÃ©rarchie de classes ?</p>

                    <p>JPA propose <strong>trois stratÃ©gies</strong> diffÃ©rentes.  Chacune a ses avantages et inconvÃ©nients selon votre cas d'usage. </p>
                </div>

                <div class="comparison-table">
                    <h4 style="margin-bottom: 20px; color: #667eea;">Comparaison des StratÃ©gies d'HÃ©ritage</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>StratÃ©gie</th>
                                <th>Comment Ã§a marche ? </th>
                                <th>Avantages</th>
                                <th>InconvÃ©nients</th>
                                <th>Quand l'utiliser ? </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>SINGLE_TABLE</strong></td>
                                <td>Une seule table pour toute la hiÃ©rarchie, avec une colonne "discriminateur" qui indique le type</td>
                                <td>
                                    â€¢ Excellentes performances<br>
                                    â€¢ RequÃªtes simples (pas de jointures)<br>
                                    â€¢ Polymorphisme facile
                                </td>
                                <td>
                                    â€¢ Beaucoup de colonnes NULL<br>
                                    â€¢ Pas de contraintes NOT NULL sur les colonnes spÃ©cifiques<br>
                                    â€¢ Table peut devenir trÃ¨s large
                                </td>
                                <td>
                                    â€¢ HiÃ©rarchie simple<br>
                                    â€¢ Performance critique<br>
                                    â€¢ Peu de diffÃ©rences entre sous-classes
                                </td>
                            </tr>
                            <tr>
                                <td><strong>JOINED</strong></td>
                                <td>Une table pour la classe parente, une table pour chaque sous-classe.  Jointure pour rÃ©cupÃ©rer les donnÃ©es complÃ¨tes</td>
                                <td>
                                    â€¢ NormalisÃ© (pas de NULL inutiles)<br>
                                    â€¢ Contraintes NOT NULL possibles<br>
                                    â€¢ Structure propre
                                </td>
                                <td>
                                    â€¢ Jointures coÃ»teuses<br>
                                    â€¢ Performances moyennes<br>
                                    â€¢ RequÃªtes complexes
                                </td>
                                <td>
                                    â€¢ HiÃ©rarchie complexe<br>
                                    â€¢ Sous-classes trÃ¨s diffÃ©rentes<br>
                                    â€¢ IntÃ©gritÃ© des donnÃ©es importante
                                </td>
                            </tr>
                            <tr>
                                <td><strong>TABLE_PER_CLASS</strong></td>
                                <td>Une table complÃ¨te pour chaque classe concrÃ¨te (chaque table a toutes les colonnes, y compris celles du parent)</td>
                                <td>
                                    â€¢ Simple Ã  comprendre<br>
                                    â€¢ Pas de jointures pour une classe spÃ©cifique<br>
                                    â€¢ Chaque table est autonome
                                </td>
                                <td>
                                    â€¢ Duplication des colonnes parentes<br>
                                    â€¢ RequÃªtes polymorphiques difficiles (UNION)<br>
                                    â€¢ Difficile Ã  maintenir
                                </td>
                                <td>
                                    â€¢ Rarement recommandÃ©<br>
                                    â€¢ Classes complÃ¨tement indÃ©pendantes<br>
                                    â€¢ Pas de requÃªtes polymorphiques
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h4>StratÃ©gie SINGLE_TABLE (RecommandÃ©e pour la performance)</h4>

                <div class="explanation">
                    <h4>ğŸ“– Comment fonctionne SINGLE_TABLE ? </h4>
                    <p>Avec cette stratÃ©gie, JPA crÃ©e <strong>une seule table</strong> qui contient toutes les colonnes de toutes les classes de la hiÃ©rarchie. Une colonne spÃ©ciale appelÃ©e <strong>"discriminateur"</strong> indique quel type d'objet chaque ligne reprÃ©sente.</p>

                    <p><strong>Exemple</strong> : Pour une hiÃ©rarchie Payment â†’ CreditCardPayment, PayPalPayment, la table ressemblera Ã  Ã§a :</p>
                </div>

                <div class="visual-box">
                    <h4 style="color: #667eea;">Table "payments" avec SINGLE_TABLE</h4>
<pre style="background: #f5f5f5; color: #333; padding: 20px; border-radius: 8px;">
+----+--------------+--------+--------+-------------+------+---------+
| id | payment_type | amount | date   | card_number | cvv  | email   |
+----+--------------+--------+--------+-------------+------+---------+
| 1  | CREDIT_CARD  | 100.00 | ...     | 1234****    | 123  | NULL    |
| 2  | PAYPAL       | 50.00  | ...    | NULL        | NULL | a@b.com |
| 3  | CREDIT_CARD  | 200. 00 | ...    | 5678****    | 456  | NULL    |
+----+--------------+--------+--------+-------------+------+---------+

Colonne "payment_type" = discriminateur (indique le type)
Colonnes card_number, cvv = spÃ©cifiques Ã  CreditCardPayment (NULL pour PayPal)
Colonne email = spÃ©cifique Ã  PayPalPayment (NULL pour CreditCard)
</pre>
                </div>

<pre><code>// =========================================
// CLASSE PARENTE ABSTRAITE
// =========================================
@Entity
@Table(name = "payments")
// â­ StratÃ©gie SINGLE_TABLE : une seule table pour tout
@Inheritance(strategy = InheritanceType.SINGLE_TABLE)
// â­ Colonne discriminateur : indique quel type de paiement
@DiscriminatorColumn(
    name = "payment_type",  // â† nom de la colonne en DB
    discriminatorType = DiscriminatorType.STRING  // â† type de la colonne (STRING, INTEGER, CHAR)
)
public abstract class Payment {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private BigDecimal amount;
    
    @Column(nullable = false)
    private LocalDateTime paymentDate;
    
    @Column(length = 100)
    private String customerName;
    
    // Constructeurs
    public Payment() {}
    
    public Payment(BigDecimal amount, String customerName) {
        this.amount = amount;
        this.customerName = customerName;
        this.paymentDate = LocalDateTime.now();
    }
    
    // Getters et Setters
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public BigDecimal getAmount() { return amount; }
    public void setAmount(BigDecimal amount) { this. amount = amount; }
    
    public LocalDateTime getPaymentDate() { return paymentDate; }
    public void setPaymentDate(LocalDateTime paymentDate) { this.paymentDate = paymentDate; }
    
    public String getCustomerName() { return customerName; }
    public void setCustomerName(String customerName) { this.customerName = customerName; }
}

// =========================================
// SOUS-CLASSE : Paiement par Carte
// =========================================
@Entity
// â­ Valeur du discriminateur pour cette classe
@DiscriminatorValue("CREDIT_CARD")
public class CreditCardPayment extends Payment {
    
    // Attributs spÃ©cifiques Ã  la carte de crÃ©dit
    @Column(name = "card_number", length = 16)
    private String cardNumber;
    
    @Column(name = "cvv", length = 3)
    private String cvv;
    
    @Column(name = "expiration_date", length = 5)
    private String expirationDate;  // Format: MM/YY
    
    // Constructeurs
    public CreditCardPayment() {}
    
    public CreditCardPayment(BigDecimal amount, String customerName, 
                             String cardNumber, String cvv, String expirationDate) {
        super(amount, customerName);
        this.cardNumber = cardNumber;
        this.cvv = cvv;
        this. expirationDate = expirationDate;
    }
    
    // Getters et Setters
    public String getCardNumber() { return cardNumber; }
    public void setCardNumber(String cardNumber) { this.cardNumber = cardNumber; }
    
    public String getCvv() { return cvv; }
    public void setCvv(String cvv) { this.cvv = cvv; }
    
    public String getExpirationDate() { return expirationDate; }
    public void setExpirationDate(String expirationDate) { this.expirationDate = expirationDate; }
}

// =========================================
// SOUS-CLASSE : Paiement PayPal
// =========================================
@Entity
@DiscriminatorValue("PAYPAL")
public class PayPalPayment extends Payment {
    
    // Attribut spÃ©cifique Ã  PayPal
    @Column(name = "paypal_email", length = 100)
    private String paypalEmail;
    
    // Constructeurs
    public PayPalPayment() {}
    
    public PayPalPayment(BigDecimal amount, String customerName, String paypalEmail) {
        super(amount, customerName);
        this.paypalEmail = paypalEmail;
    }
    
    // Getters et Setters
    public String getPaypalEmail() { return paypalEmail; }
    public void setPaypalEmail(String paypalEmail) { this.paypalEmail = paypalEmail; }
}

// =========================================
// SOUS-CLASSE : Paiement par Virement
// =========================================
@Entity
@DiscriminatorValue("BANK_TRANSFER")
public class BankTransferPayment extends Payment {
    
    @Column(name = "bank_account", length = 34)
    private String bankAccount;  // IBAN
    
    @Column(name = "bank_name", length = 100)
    private String bankName;
    
    // Constructeurs
    public BankTransferPayment() {}
    
    public BankTransferPayment(BigDecimal amount, String customerName, 
                               String bankAccount, String bankName) {
        super(amount, customerName);
        this.bankAccount = bankAccount;
        this.bankName = bankName;
    }
    
    // Getters et Setters
    public String getBankAccount() { return bankAccount; }
    public void setBankAccount(String bankAccount) { this.bankAccount = bankAccount; }
    
    public String getBankName() { return bankName; }
    public void setBankName(String bankName) { this.bankName = bankName; }
}</code></pre>

                <div class="code-explanation">
                    <h5>ğŸ“ Explications dÃ©taillÃ©es</h5>
                    <ul>
                        <li><strong>@Inheritance(strategy = InheritanceType.SINGLE_TABLE)</strong> : Dit Ã  JPA d'utiliser une seule table pour toute la hiÃ©rarchie</li>
                        <li><strong>@DiscriminatorColumn(name = "payment_type")</strong> : DÃ©finit le nom de la colonne qui contiendra le type de paiement ("CREDIT_CARD", "PAYPAL", etc.)</li>
                        <li><strong>@DiscriminatorValue("CREDIT_CARD")</strong> : DÃ©finit la valeur que payment_type aura pour cette sous-classe</li>
                        <li><strong>Colonnes spÃ©cifiques</strong> : card_number, cvv pour CreditCard ; paypal_email pour PayPal.  Ces colonnes seront NULL pour les autres types</li>
                    </ul>
                </div>

                <div class="example-box">
                    <h4>âœ… Exemple d'utilisation</h4>
<pre><code>EntityManager em = ...;
em. getTransaction().begin();

// CrÃ©er diffÃ©rents types de paiements
Payment payment1 = new CreditCardPayment(
    new BigDecimal("100.50"), 
    "Alice", 
    "1234567812345678", 
    "123", 
    "12/25"
);

Payment payment2 = new PayPalPayment(
    new BigDecimal("50.00"), 
    "Bob", 
    "bob@paypal.com"
);

Payment payment3 = new BankTransferPayment(
    new BigDecimal("200.00"), 
    "Charlie", 
    "FR7612345678901234567890123", 
    "BNP Paribas"
);

// Persister
em.persist(payment1);
em.persist(payment2);
em.persist(payment3);
em.getTransaction().commit();

// â­ POLYMORPHISME : RÃ©cupÃ©rer tous les paiements (tous types confondus)
List&lt;Payment&gt; allPayments = em.createQuery("SELECT p FROM Payment p", Payment. class)
                               .getResultList();

System.out.println("Total : " + allPayments.size() + " paiements");

// Parcourir et identifier le type avec instanceof
for (Payment p : allPayments) {
    System.out.print("Paiement de " + p.getAmount() + "â‚¬ par " + p.getCustomerName() + " via ");
    
    if (p instanceof CreditCardPayment) {
        CreditCardPayment cc = (CreditCardPayment) p;
        System.out. println("Carte ****" + cc.getCardNumber(). substring(12));
    } else if (p instanceof PayPalPayment) {
        PayPalPayment pp = (PayPalPayment) p;
        System.out. println("PayPal (" + pp.getPaypalEmail() + ")");
    } else if (p instanceof BankTransferPayment) {
        BankTransferPayment bt = (BankTransferPayment) p;
        System.out.println("Virement (" + bt.getBankName() + ")");
    }
}

// â­ RequÃªte spÃ©cifique Ã  un type
List&lt;CreditCardPayment&gt; creditCardPayments = 
    em.createQuery("SELECT p FROM CreditCardPayment p", CreditCardPayment.class)
      .getResultList();

System. out.println("Paiements par carte : " + creditCardPayments.size());</code></pre>
                </div>

                <div class="tip-box">
                    <h4>ğŸ’¡ Bonnes Pratiques avec SINGLE_TABLE</h4>
                    <ul>
                        <li><strong>Utiliser des valeurs de discriminateur explicites</strong> : PrÃ©fÃ©rez "CREDIT_CARD" plutÃ´t que laisser JPA utiliser le nom de la classe</li>
                        <li><strong>Ne pas mettre NOT NULL sur les colonnes spÃ©cifiques</strong> : Elles seront NULL pour les autres types</li>
                        <li><strong>Documenter la hiÃ©rarchie</strong> : Expliquez dans un commentaire quelles colonnes correspondent Ã  quel type</li>
                        <li><strong>Limiter le nombre de sous-classes</strong> : Si vous avez 20 sous-classes avec chacune 10 colonnes, vous aurez une table avec 200+ colonnes, ce qui devient ingÃ©rable</li>
                    </ul>
                </div>

                <h3>1. 4 Caching JPA : Optimiser les Performances</h3>

                <div class="intro-box">
                    <h3>ğŸš€ Pourquoi le caching est crucial ?</h3>
                    <p>Imaginez une application e-commerce qui affiche 1000 fois par seconde la liste des produits. Si Ã  chaque fois vous interrogez la base de donnÃ©es, vous allez :</p>
                    <ul>
                        <li>Surcharger votre base de donnÃ©es</li>
                        <li>Avoir des temps de rÃ©ponse lents (les requÃªtes rÃ©seau prennent du temps)</li>
                        <li>Gaspiller des ressources serveur</li>
                    </ul>
                    <p><strong>Solution : le caching</strong>. Au lieu d'interroger la base Ã  chaque fois, on stocke les donnÃ©es en <strong>mÃ©moire</strong> (beaucoup plus rapide) et on ne va en base que quand c'est nÃ©cessaire. </p>
                </div>

                <div class="concept-box">
                    <h4>ğŸ’¡ Les deux niveaux de cache JPA</h4>
                    <p>JPA/Hibernate propose deux niveaux de cache :</p>
                    <ul>
                        <li><strong>First-Level Cache (L1)</strong> : Cache de la <strong>session</strong> EntityManager.   Automatique, toujours actif, pas configurable.   Dure le temps de vie de l'EntityManager. </li>
                        <li><strong>Second-Level Cache (L2)</strong> : Cache <strong>partagÃ©</strong> entre toutes les sessions EntityManager de l'application. Optionnel, configurable, persiste tant que l'application tourne.</li>
                    </ul>
                </div>

                <div class="visual-box">
                    <h4 style="color: #667eea;">Architecture du Cache JPA</h4>
<pre style="background: #f5f5f5; color: #333; padding: 20px; border-radius: 8px;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              APPLICATION JEE                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         â”‚
    â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚EntityManagerâ”‚         â”‚EntityManagerâ”‚
â”‚   Session 1 â”‚         â”‚   Session 2 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚
       â”‚  First-Level Cache    â”‚  First-Level Cache
       â”‚  (L1 - Automatique)   â”‚  (L1 - Automatique)
       â”‚                       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   Second-Level Cache    â”‚
       â”‚   (L2 - Optionnel)      â”‚
       â”‚   EHCache, Infinispan   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     DATABASE      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Flux de lecture :
1. EntityManager cherche d'abord dans son cache L1
2. Si pas trouvÃ©, cherche dans le cache L2 partagÃ©
3. Si toujours pas trouvÃ©, interroge la base de donnÃ©es
4.  Stocke le rÃ©sultat dans L1 et L2 pour les prochaines fois
</pre>
                </div>

                <h4>A.  First-Level Cache (L1) - Automatique</h4>

                <div class="explanation">
                    <h4>ğŸ“– Comment fonctionne le cache L1 ? </h4>
                    <p>Le cache L1 est un <strong>Map</strong> en mÃ©moire gÃ©rÃ© par l'EntityManager.  Quand vous faites <span class="inline-code">em.find(User.class, 1)</span>, JPA :</p>
                    <ol>
                        <li>Cherche d'abord dans le cache L1 (la Map en mÃ©moire)</li>
                        <li>Si l'objet est lÃ , le retourne <strong>immÃ©diatement</strong> (pas de requÃªte SQL)</li>
                        <li>Sinon, interroge la base, et <strong>stocke le rÃ©sultat dans L1</strong></li>
                    </ol>
                    <p><strong>PortÃ©e</strong> : Le cache L1 est liÃ© Ã  l'EntityManager.   Quand vous fermez l'EntityManager, le cache est vidÃ©.</p>
                </div>

                <div class="example-box">
                    <h4>âœ… DÃ©monstration du Cache L1</h4>
<pre><code>EntityManager em = emf.createEntityManager();
em.getTransaction().begin();

// â­ PREMIÃˆRE lecture : va en base de donnÃ©es
System.out.println("=== PremiÃ¨re lecture ===");
User user1 = em.find(User. class, 1L);
// SQL exÃ©cutÃ© : SELECT * FROM users WHERE id = 1
System.out.println("User : " + user1.getName());

// â­ DEUXIÃˆME lecture : vient du cache L1 (AUCUNE requÃªte SQL)
System.out.println("=== DeuxiÃ¨me lecture ===");
User user2 = em.find(User.class, 1L);
// Aucun SQL exÃ©cutÃ© !   user2 est le MÃŠME OBJET que user1 (mÃªme rÃ©fÃ©rence en mÃ©moire)
System.out.println("User : " + user2.getName());

// Preuve que c'est le mÃªme objet
System.out.println("user1 == user2 ?  " + (user1 == user2));  // true

em.getTransaction().commit();
em.close();

// â­ NOUVELLE session : cache L1 vidÃ©
EntityManager em2 = emf. createEntityManager();
System.out.println("=== Nouvelle session ===");
User user3 = em2.find(User.class, 1L);
// SQL exÃ©cutÃ© Ã  nouveau (nouveau cache L1)
System.out. println("User : " + user3.getName());

em2.close();</code></pre>
                </div>

                <div class="tip-box">
                    <h4>ğŸ’¡ Bonnes pratiques avec le cache L1</h4>
                    <ul>
                        <li><strong>Profiter de la mÃªme session</strong> : Si vous devez accÃ©der plusieurs fois au mÃªme objet, faites-le dans la mÃªme transaction</li>
                        <li><strong>Attention aux sessions longues</strong> : Si vous gardez un EntityManager ouvert trop longtemps, le cache L1 peut devenir obsolÃ¨te (les donnÃ©es en mÃ©moire ne reflÃ¨tent plus la base)</li>
                        <li><strong>RafraÃ®chir si nÃ©cessaire</strong> : Utilisez <span class="inline-code">em. refresh(entity)</span> pour forcer la relecture depuis la base</li>
                        <li><strong>Vider le cache</strong> : <span class="inline-code">em.clear()</span> vide tout le cache L1 ; <span class="inline-code">em.detach(entity)</span> retire un objet spÃ©cifique du cache</li>
                    </ul>
                </div>

                <h4>B. Second-Level Cache (L2) - Configuration</h4>

                <div class="explanation">
                    <h4>ğŸ“– Pourquoi un cache de niveau 2 ? </h4>
                    <p>Le cache L1 est limitÃ© Ã  une session EntityManager.   Si 1000 utilisateurs accÃ¨dent Ã  votre application, vous aurez 1000 EntityManager diffÃ©rents, donc 1000 caches L1 diffÃ©rents.   Chacun ira en base de donnÃ©es pour charger les mÃªmes donnÃ©es !</p>

                    <p>Le <strong>cache L2</strong> rÃ©sout ce problÃ¨me : c'est un cache <strong>partagÃ© au niveau de l'application</strong>.  Tous les EntityManager y accÃ¨dent, donc si l'utilisateur A charge un produit, l'utilisateur B bÃ©nÃ©ficiera du cache. </p>

                    <p><strong>ImplÃ©mentations populaires</strong> : EHCache, Infinispan, Hazelcast.</p>
                </div>

                <div class="warning-box">
                    <h4>âš ï¸ Le cache L2 n'est PAS activÃ© par dÃ©faut !</h4>
                    <p>Contrairement au cache L1, le cache L2 doit Ãªtre :</p>
                    <ol>
                        <li>ActivÃ© dans <span class="inline-code">persistence. xml</span></li>
                        <li>ConfigurÃ© (quelle librairie utiliser ?)</li>
                        <li>ActivÃ© sur chaque entitÃ© avec <span class="inline-code">@Cacheable</span></li>
                    </ol>
                </div>

                <div class="step">
                    <h4>Configuration du Cache L2 avec EHCache</h4>

                    <p><strong>Ã‰tape 1 : Ajouter la dÃ©pendance Maven</strong></p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
    &lt;artifactId&gt;hibernate-jcache&lt;/artifactId&gt;
    &lt;version&gt;5.6.15.Final&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.ehcache&lt;/groupId&gt;
    &lt;artifactId&gt;ehcache&lt;/artifactId&gt;
    &lt;version&gt;3.10.8&lt;/version&gt;
&lt;/dependency&gt;</code></pre>

                    <p><strong>Ã‰tape 2 : Activer dans persistence.xml</strong></p>
<pre><code>&lt;persistence-unit name="MyPU" transaction-type="JTA"&gt;
    &lt;provider&gt;org.hibernate.jpa.HibernatePersistenceProvider&lt;/provider&gt;
    
    &lt;properties&gt;
        &lt;! -- Activer le cache L2 --&gt;
        &lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;
        
        &lt;!-- Activer le cache de requÃªtes (optionnel mais recommandÃ©) --&gt;
        &lt;property name="hibernate.cache.use_query_cache" value="true"/&gt;
        
        &lt;!-- SpÃ©cifier l'implÃ©mentation du cache --&gt;
        &lt;property name="hibernate.cache.region.factory_class" 
                  value="org.hibernate.cache.jcache.JCacheRegionFactory"/&gt;
        
        &lt;! -- Provider JCache (EHCache) --&gt;
        &lt;property name="hibernate.javax.cache.provider" 
                  value="org.ehcache.jsr107.EhcacheCachingProvider"/&gt;
        
        &lt;!-- Configuration EHCache --&gt;
        &lt;property name="hibernate. javax.cache.uri" 
                  value="classpath:ehcache.xml"/&gt;
    &lt;/properties&gt;
&lt;/persistence-unit&gt;</code></pre>

                    <p><strong>Ã‰tape 3 : CrÃ©er ehcache.xml (dans src/main/resources)</strong></p>
<pre><code>&lt;config xmlns="http://www.ehcache. org/v3"&gt;
    
    &lt;! -- Configuration par dÃ©faut --&gt;
    &lt;cache-template name="default"&gt;
        &lt;expiry&gt;
            &lt;ttl unit="minutes"&gt;10&lt;/ttl&gt;  &lt;!-- Time To Live : 10 minutes --&gt;
        &lt;/expiry&gt;
        &lt;heap unit="entries"&gt;1000&lt;/heap&gt;  &lt;!-- Max 1000 objets en mÃ©moire --&gt;
    &lt;/cache-template&gt;
    
    &lt;!-- Cache spÃ©cifique pour les User --&gt;
    &lt;cache alias="com.example.entity.User" uses-template="default"&gt;
        &lt;expiry&gt;
            &lt;ttl unit="minutes"&gt;30&lt;/ttl&gt;  &lt;!-- Les users restent 30 min en cache --&gt;
        &lt;/expiry&gt;
        &lt;heap unit="entries"&gt;5000&lt;/heap&gt;
    &lt;/cache&gt;
    
    &lt;!-- Cache pour les Product --&gt;
    &lt;cache alias="com.example. entity.Product" uses-template="default"&gt;
        &lt;expiry&gt;
            &lt;ttl unit="hours"&gt;1&lt;/ttl&gt;  &lt;!-- Les produits changent peu, 1h de cache --&gt;
        &lt;/expiry&gt;
        &lt;heap unit="entries"&gt;10000&lt;/heap&gt;
    &lt;/cache&gt;
    
&lt;/config&gt;</code></pre>

                    <p><strong>Ã‰tape 4 : Activer le cache sur les entitÃ©s</strong></p>
<pre><code>import org.hibernate.annotations.Cache;
import org.hibernate.annotations. CacheConcurrencyStrategy;

@Entity
@Table(name = "users")
// â­ Activer le cache L2 pour cette entitÃ©
@Cacheable
@Cache(usage = CacheConcurrencyStrategy.READ_WRITE)
public class User {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    @Column(nullable = false, unique = true)
    private String email;
    
    // Getters, Setters... 
}

@Entity
@Table(name = "products")
@Cacheable
@Cache(usage = CacheConcurrencyStrategy. READ_ONLY)  // Lecture seule si les produits ne changent jamais
public class Product {
    
    @Id
    @GeneratedValue(strategy = GenerationType. IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    @Column(nullable = false)
    private BigDecimal price;
    
    // Getters, Setters... 
}</code></pre>
                </div>

                <div class="code-explanation">
                    <h5>ğŸ“ StratÃ©gies de concurrence du cache</h5>
                    <table style="margin-top: 15px;">
                        <thead>
                            <tr>
                                <th>StratÃ©gie</th>
                                <th>Description</th>
                                <th>Quand l'utiliser ? </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>READ_ONLY</strong></td>
                                <td>Les donnÃ©es ne sont jamais modifiÃ©es aprÃ¨s crÃ©ation</td>
                                <td>DonnÃ©es de rÃ©fÃ©rence (pays, catÃ©gories... )</td>
                            </tr>
                            <tr>
                                <td><strong>READ_WRITE</strong></td>
                                <td>Lecture et Ã©criture.  Synchronisation stricte du cache</td>
                                <td>DonnÃ©es modifiÃ©es mais pas trÃ¨s souvent</td>
                            </tr>
                            <tr>
                                <td><strong>NONSTRICT_READ_WRITE</strong></td>
                                <td>Lecture/Ã©criture mais moins strict (peut avoir donnÃ©es obsolÃ¨tes courtes)</td>
                                <td>DonnÃ©es oÃ¹ un lÃ©ger dÃ©calage est acceptable</td>
                            </tr>
                            <tr>
                                <td><strong>TRANSACTIONAL</strong></td>
                                <td>Support complet des transactions (coÃ»teux)</td>
                                <td>DonnÃ©es critiques nÃ©cessitant ACID strict</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="example-box">
                    <h4>âœ… Test du cache L2</h4>
<pre><code>// Session 1
EntityManager em1 = emf. createEntityManager();
System.out.println("=== Session 1 : PremiÃ¨re lecture ===");
User user1 = em1.find(User.class, 1L);
// SQL exÃ©cutÃ© : SELECT * FROM users WHERE id = 1
// Objet stockÃ© dans cache L1 de em1 ET cache L2 partagÃ©
System.out.println("User : " + user1.getName());
em1.close();  // Cache L1 vidÃ©

// Session 2 (diffÃ©rent EntityManager)
EntityManager em2 = emf.createEntityManager();
System.out.println("=== Session 2 : Lecture depuis cache L2 ===");
User user2 = em2.find(User.class, 1L);
// â­ AUCUN SQL exÃ©cutÃ© !  DonnÃ©es viennent du cache L2
// user2 est une COPIE de l'objet en cache (pas la mÃªme rÃ©fÃ©rence que user1)
System.out. println("User : " + user2.getName());
em2.close();

// Session 3 (encore diffÃ©rent)
EntityManager em3 = emf.createEntityManager();
System.out.println("=== Session 3 : Toujours depuis cache L2 ===");
User user3 = em3. find(User.class, 1L);
// â­ Toujours aucun SQL !  Cache L2 encore actif
System.out.println("User : " + user3. getName());
em3.close();

// Vider le cache L2 manuellement (si nÃ©cessaire)
Cache cache = emf.unwrap(SessionFactory. class).getCache();
cache.evictAllRegions();  // Vide tout le cache L2
System.out.println("Cache L2 vidÃ©");

// Session 4
EntityManager em4 = emf.createEntityManager();
System. out.println("=== Session 4 : AprÃ¨s vidage du cache ===");
User user4 = em4.find(User.class, 1L);
// SQL exÃ©cutÃ© Ã  nouveau (cache vidÃ©)
System.out.println("User : " + user4. getName());
em4.close();</code></pre>
                </div>

                <div class="tip-box">
                    <h4>ğŸ’¡ Bonnes pratiques avec le cache L2</h4>
                    <ul>
                        <li><strong>Ne pas tout cacher</strong> : Le cache consomme de la mÃ©moire.   Cachez seulement les donnÃ©es frÃ©quemment lues et peu modifiÃ©es</li>
                        <li><strong>Configurer le TTL</strong> : DÃ©finissez un Time To Live adaptÃ©.  DonnÃ©es statiques = TTL long ; donnÃ©es dynamiques = TTL court</li>
                        <li><strong>Monitorer le cache</strong> : Utilisez des outils (JMX, Metrics) pour voir le taux de hit/miss du cache</li>
                        <li><strong>Ã‰viter pour les donnÃ©es sensibles</strong> : Si les donnÃ©es changent souvent ou doivent Ãªtre absolument Ã  jour, ne les cachez pas</li>
                        <li><strong>Vider le cache si nÃ©cessaire</strong> : AprÃ¨s une modification importante en base, videz le cache avec <span class="inline-code">cache.evict()</span></li>
                    </ul>
                </div>

                <h3>1.5 JPQL AvancÃ© : RequÃªtes Complexes</h3>

                <div class="intro-box">
                    <h3>ğŸ” Au-delÃ  du find() simple</h3>
                    <p><span class="inline-code">em.find(User.class, 1)</span> est pratique pour rÃ©cupÃ©rer une entitÃ© par son ID, mais dans la vraie vie, vous aurez besoin de requÃªtes plus complexes :</p>
                    <ul>
                        <li>Trouver tous les utilisateurs dont le nom commence par "A"</li>
                        <li>Compter le nombre de commandes par statut</li>
                        <li>RÃ©cupÃ©rer un dÃ©partement avec tous ses employÃ©s (Ã©viter le problÃ¨me N+1)</li>
                        <li>Faire des jointures, des tris, des agrÃ©gations...</li>
                    </ul>
                    <p><strong>JPQL (Java Persistence Query Language)</strong> est un langage de requÃªte similaire Ã  SQL, mais orientÃ© <strong>objets</strong> : vous Ã©crivez des requÃªtes sur des <strong>classes Java</strong> et leurs attributs, pas sur des tables et colonnes.</p>
                </div>

                <h4>A.  JPQL avec Jointures (Ã‰viter le ProblÃ¨me N+1)</h4>

                <div class="warning-box">
                    <h4>âš ï¸ Le ProblÃ¨me N+1 (TrÃ¨s Important ! )</h4>
                    <p>C'est un des bugs de performance les plus courants avec JPA.  Voici ce qui se passe :</p>
<pre><code>// RÃ©cupÃ©rer tous les dÃ©partements
List&lt;Department&gt; departments = em.createQuery("SELECT d FROM Department d", Department. class)
                                  .getResultList();
// â¬† 1 requÃªte SQL : SELECT * FROM departments

// Parcourir et afficher les employÃ©s de chaque dÃ©partement
for (Department dept : departments) {
    System.out.println(dept.getName() + " a " + dept.getEmployees().size() + " employÃ©s");
    // â¬† Pour CHAQUE dÃ©partement, une requÃªte SQL : SELECT * FROM employees WHERE department_id = ?
}

// RÃ©sultat : si vous avez 100 dÃ©partements, vous exÃ©cutez 1 + 100 = 101 requÃªtes ! 
// C'est le "N+1 problem" : 1 requÃªte pour les dÃ©partements + N requÃªtes pour leurs employÃ©s
</code></pre>
                    <p><strong>ConsÃ©quences</strong> : Application trÃ¨s lente, base de donnÃ©es surchargÃ©e, timeouts... </p>
                </div>

                <div class="explanation">
                    <h4>âœ… Solution : JOIN FETCH</h4>
                    <p><strong>JOIN FETCH</strong> dit Ã  JPA de charger les relations <strong>dans la mÃªme requÃªte SQL</strong> avec une jointure. Au lieu de N+1 requÃªtes, vous n'en aurez qu'<strong>une seule</strong>.</p>
                </div>

<pre><code>// â­ MAUVAISE mÃ©thode (N+1 problem)
List&lt;Department&gt; departments = em.createQuery(
    "SELECT d FROM Department d", 
    Department.class
). getResultList();
// 1 requÃªte + N requÃªtes pour les employÃ©s

// âœ… BONNE mÃ©thode (JOIN FETCH)
List&lt;Department&gt; departmentsWithEmployees = em.createQuery(
    "SELECT d FROM Department d JOIN FETCH d.employees", 
    Department.class
).getResultList();
// UNE SEULE requÃªte SQL avec jointure :
// SELECT d.*, e.* FROM departments d LEFT JOIN employees e ON d.id = e.department_id

for (Department dept : departmentsWithEmployees) {
    System. out.println(dept.getName() + " a " + dept.getEmployees().size() + " employÃ©s");
    // Aucune requÃªte supplÃ©mentaire !  Les employÃ©s sont dÃ©jÃ  chargÃ©s en mÃ©moire
}

// â­ JOIN FETCH avec condition
List&lt;Department&gt; itDepartmentsWithEmployees = em.createQuery(
    "SELECT d FROM Department d JOIN FETCH d.employees WHERE d.name = :name", 
    Department.class
)
.setParameter("name", "IT")
.getResultList();

// â­ Plusieurs JOIN FETCH (charger plusieurs relations en une requÃªte)
String jpql = "SELECT d FROM Department d " +
              "JOIN FETCH d.employees e " +
              "JOIN FETCH e.projects";  // Si Employee a aussi des projets
List&lt;Department&gt; departments = em.createQuery(jpql, Department.class)
                                  .getResultList();</code></pre>

                <div class="tip-box">
                    <h4>ğŸ’¡ Quand utiliser JOIN FETCH ? </h4>
                    <ul>
                        <li><strong>Utilisez JOIN FETCH</strong> quand vous SAVEZ que vous allez accÃ©der aux relations (Ã©vite N+1)</li>
                        <li><strong>N'utilisez PAS JOIN FETCH</strong> si vous ne comptez pas accÃ©der aux relations (charge des donnÃ©es inutiles)</li>
                        <li><strong>Attention aux collections multiples</strong> : JOIN FETCH sur deux collections simultanÃ©ment peut crÃ©er un produit cartÃ©sien (explosion du nombre de lignes)</li>
                    </ul>
                </div>

                <h4>B. AgrÃ©gations en JPQL</h4>

                <div class="explanation">
                    <h4>ğŸ“– Fonctions d'agrÃ©gation</h4>
                    <p>Comme en SQL, JPQL supporte les fonctions d'agrÃ©gation pour calculer des statistiques :</p>
                    <ul>
                        <li><strong>COUNT</strong> : Compter le nombre d'Ã©lÃ©ments</li>
                        <li><strong>SUM</strong> : Somme</li>
                        <li><strong>AVG</strong> : Moyenne</li>
                        <li><strong>MAX / MIN</strong> : Maximum / Minimum</li>
                    </ul>
                </div>

<pre><code>// â­ Compter le nombre total d'employÃ©s
Long totalEmployees = em.createQuery(
    "SELECT COUNT(e) FROM Employee e", 
    Long.class
). getSingleResult();
System.out.println("Total employÃ©s : " + totalEmployees);

// â­ Salaire moyen
Double avgSalary = em.createQuery(
    "SELECT AVG(e.salary) FROM Employee e", 
    Double.class
). getSingleResult();
System.out.println("Salaire moyen : " + avgSalary + "â‚¬");

// â­ Salaire maximum et minimum
Object[] salaryStats = em.createQuery(
    "SELECT MAX(e.salary), MIN(e.salary) FROM Employee e", 
    Object[]. class
).getSingleResult();
System.out.println("Salaire max : " + salaryStats[0] + "â‚¬, min : " + salaryStats[1] + "â‚¬");

// â­ Compter les employÃ©s par dÃ©partement (GROUP BY)
String jpql = "SELECT d.name, COUNT(e) FROM Department d " +
              "LEFT JOIN d.employees e " +
              "GROUP BY d.name " +
              "HAVING COUNT(e) > 5 " +  // Seulement les dÃ©partements avec plus de 5 employÃ©s
              "ORDER BY COUNT(e) DESC";

List&lt;Object[]&gt; results = em.createQuery(jpql, Object[].class). getResultList();

for (Object[] row : results) {
    String deptName = (String) row[0];
    Long employeeCount = (Long) row[1];
    System.out. println(deptName + " : " + employeeCount + " employÃ©s");
}

// â­ Somme des salaires par dÃ©partement
jpql = "SELECT d.name, SUM(e.salary) FROM Department d " +
       "JOIN d.employees e " +
       "GROUP BY d.name";

List&lt;Object[]&gt; salaryByDept = em.createQuery(jpql, Object[]. class).getResultList();

for (Object[] row : salaryByDept) {
    String deptName = (String) row[0];
    Double totalSalary = (Double) row[1];
    System.out.println(deptName + " : " + totalSalary + "â‚¬ de masse salariale");
}</code></pre>

                <h4>C. Criteria API : RequÃªtes Type-Safe</h4>

                <div class="concept-box">
                    <h4>ğŸ’¡ ProblÃ¨me avec JPQL en String</h4>
                    <p>JPQL est Ã©crit en <strong>String</strong>.  ProblÃ¨me : si vous faites une faute de frappe, vous ne le saurez qu'Ã  l'<strong>exÃ©cution</strong> (pas Ã  la compilation).  Exemple :</p>
<pre><code>"SELECT u FROM User u WHERE u.namee = :name"  // âŒ Faute : "namee" au lieu de "name"
// Le code compile, mais plante Ã  l'exÃ©cution ! 
</code></pre>
                    <p><strong>Criteria API</strong> rÃ©sout ce problÃ¨me : vous construisez des requÃªtes avec du code Java pur, donc les erreurs sont dÃ©tectÃ©es Ã  la <strong>compilation</strong>.</p>
                </div>

<pre><code>// â­ Exemple simple : SELECT u FROM User u WHERE u.name LIKE '%John%' AND u.salary > 50000

// Ã‰tape 1 : CrÃ©er un CriteriaBuilder
CriteriaBuilder cb = em.getCriteriaBuilder();

// Ã‰tape 2 : CrÃ©er une CriteriaQuery pour le type User
CriteriaQuery&lt;User&gt; cq = cb.createQuery(User. class);

// Ã‰tape 3 : DÃ©finir la "racine" (FROM User)
Root&lt;User&gt; user = cq.from(User. class);

// Ã‰tape 4 : Construire la requÃªte (SELECT, WHERE)
cq.select(user)
  .where(
      cb.and(  // AND entre les conditions
          cb.like(user.get("name"), "%John%"),  // name LIKE '%John%'
          cb.gt(user.get("salary"), 50000)  // salary > 50000
      )
  );

// Ã‰tape 5 : ExÃ©cuter
List&lt;User&gt; results = em.createQuery(cq).getResultList();

for (User u : results) {
    System.out.println(u.getName() + " - " + u.getSalary() + "â‚¬");
}

// â­ Exemple avec jointure : DÃ©partements avec plus de 5 employÃ©s
CriteriaQuery&lt;Department&gt; cqDept = cb.createQuery(Department.class);
Root&lt;Department&gt; dept = cqDept.from(Department. class);
Join&lt;Department, Employee&gt; employees = dept.join("employees");

cqDept.select(dept)
      .groupBy(dept.get("id"))
      .having(cb. gt(cb.count(employees), 5L));

List&lt;Department&gt; largeDepartments = em.createQuery(cqDept).getResultList();

// â­ Exemple avec tri dynamique
CriteriaQuery&lt;User&gt; cqSorted = cb.createQuery(User. class);
Root&lt;User&gt; userRoot = cqSorted.from(User.class);

cqSorted.select(userRoot)
        .orderBy(cb.desc(userRoot.get("salary")));  // ORDER BY salary DESC

List&lt;User&gt; sortedUsers = em.createQuery(cqSorted).getResultList();</code></pre>

                <div class="tip-box">
                    <h4>ğŸ’¡ JPQL vs Criteria API : Quand utiliser quoi ?</h4>
                    <ul>
                        <li><strong>JPQL</strong> : Plus simple, plus lisible, pour des requÃªtes <strong>statiques</strong> (vous connaissez la requÃªte Ã  l'avance)</li>
                        <li><strong>Criteria API</strong> : Pour des requÃªtes <strong>dynamiques</strong> (construites Ã  la volÃ©e selon des conditions), ou si vous voulez la vÃ©rification de type Ã  la compilation</li>
                        <li><strong>MÃ©tamodÃ¨le statique</strong> : Pour Ã©viter les Strings mÃªme avec Criteria API, JPA peut gÃ©nÃ©rer des classes <span class="inline-code">User_</span> avec des attributs typÃ©s (avancÃ©)</li>
                    </ul>
                </div>

            </div>

            <!-- ============================================ -->
            <!-- PARTIE 2 : NoSQL & MONGODB -->
            <!-- ============================================ -->
            <div id="partie2" class="section">
                <h2>2ï¸âƒ£ NoSQL & MongoDB</h2>

                <div class="intro-box">
                    <h3>ğŸŒ Pourquoi NoSQL existe-t-il ?</h3>
                    <p>Depuis des dÃ©cennies, les bases de donnÃ©es relationnelles (SQL) dominent : Oracle, MySQL, PostgreSQL...   Elles sont excellentes pour les donnÃ©es <strong>structurÃ©es</strong> et les transactions <strong>ACID</strong>.</p>

                    <p>Mais dans les annÃ©es 2000-2010, de nouveaux besoins sont apparus :</p>
                    <ul>
                        <li><strong>DonnÃ©es massives</strong> : Google, Facebook, Amazon stockent des pÃ©taoctets de donnÃ©es.  Les bases SQL classiques ne "scalent" pas horizontalement facilement</li>
                        <li><strong>DonnÃ©es flexibles</strong> : Logs, Ã©vÃ©nements, contenus utilisateur (posts, tweets) ont des structures variables.  Imposer un schÃ©ma rigide est contraignant</li>
                        <li><strong>Performance en lecture</strong> : Pour des cas comme l'analytics, on veut lire trÃ¨s vite, quitte Ã  sacrifier un peu de cohÃ©rence</li>
                        <li><strong>ScalabilitÃ© horizontale</strong> : Ajouter des serveurs facilement (sharding) plutÃ´t que d'acheter un serveur plus puissant (scalabilitÃ© verticale)</li>
                    </ul>

                    <p><strong>NoSQL</strong> = "Not Only SQL" (pas "No SQL"). Ce sont des bases de donnÃ©es qui complÃ¨tent (et non remplacent) SQL pour des cas d'usage spÃ©cifiques.</p>
                </div>

                <h3>2. 1 Types de Bases NoSQL</h3>

                <div class="comparison-table">
                    <h4 style="margin-bottom: 20px; color: #667eea;">Les 4 Grandes Familles NoSQL</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>ModÃ¨le de DonnÃ©es</th>
                                <th>Exemples</th>
                                <th>Cas d'Usage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Document</strong></td>
                                <td>Documents JSON/BSON avec structure flexible</td>
                                <td>MongoDB, CouchDB</td>
                                <td>Catalogues produits, CMS, profils utilisateurs</td>
                            </tr>
                            <tr>
                                <td><strong>ClÃ©-Valeur</strong></td>
                                <td>Map simple : une clÃ© â†’ une valeur</td>
                                <td>Redis, DynamoDB</td>
                                <td>Cache, sessions, compteurs temps rÃ©el</td>
                            </tr>
                            <tr>
                                <td><strong>Colonnes</strong></td>
                                <td>Tables avec colonnes dynamiques par ligne</td>
                                <td>Cassandra, HBase</td>
                                <td>Analytics, time-series, big data</td>
                            </tr>
                            <tr>
                                <td><strong>Graphe</strong></td>
                                <td>Noeuds et relations (graphe)</td>
                                <td>Neo4j, ArangoDB</td>
                                <td>RÃ©seaux sociaux, recommandations, fraude</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="concept-box">
                    <h4>ğŸ’¡ Pourquoi MongoDB dans ce cours ?</h4>
                    <p><strong>MongoDB</strong> est la base NoSQL la plus populaire pour les applications web.  C'est une base de type <strong>document</strong> :</p>
                    <ul>
                        <li>Stocke les donnÃ©es en <strong>JSON</strong> (en rÃ©alitÃ© BSON = Binary JSON)</li>
                        <li><strong>SchÃ©ma flexible</strong> : chaque document peut avoir des champs diffÃ©rents</li>
                        <li><strong>Facile Ã  apprendre</strong> : si vous connaissez JSON, vous connaissez 80% de MongoDB</li>
                        <li><strong>Puissante</strong> : agrÃ©gations complexes, indexation, rÃ©plication, sharding</li>
                        <li><strong>Bien intÃ©grÃ©e avec Java</strong> : driver officiel MongoDB Java</li>
                    </ul>
                </div>

                <h3>2.2 SQL vs NoSQL : Comparaison DÃ©taillÃ©e</h3>

                <div class="comparison-table">
                    <table>
                        <thead>
                            <tr>
                                <th>CritÃ¨re</th>
                                <th>SQL (PostgreSQL, MySQL)</th>
                                <th>NoSQL (MongoDB)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>SchÃ©ma</strong></td>
                                <td>Rigide, dÃ©fini Ã  l'avance (CREATE TABLE)</td>
                                <td>Flexible, peut changer dynamiquement</td>
                            </tr>
                            <tr>
                                <td><strong>Structure</strong></td>
                                <td>Tables avec lignes et colonnes</td>
                                <td>Collections de documents JSON</td>
                            </tr>
                            <tr>
                                <td><strong>Relations</strong></td>
                                <td>JOIN SQL entre tables</td>
                                <td>Embedding (imbrication) ou Referencing (IDs)</td>
                            </tr>
                            <tr>
                                <td><strong>ScalabilitÃ©</strong></td>
                                <td>Verticale (CPU/RAM plus puissants)</td>
                                <td>Horizontale (ajouter des serveurs, sharding)</td>
                            </tr>
                            <tr>
                                <td><strong>Transactions</strong></td>
                                <td>ACID complet, natif</td>
                                <td>ACID depuis v4. 0 mais limitÃ© (1 document natif, multi-docs possible)</td>
                            </tr>
                            <tr>
                                <td><strong>Performance</strong></td>
                                <td>Excellente pour transactions complexes, jointures</td>
                                <td>Excellente pour lectures massives, donnÃ©es dÃ©normalisÃ©es</td>
                            </tr>
                            <tr>
                                <td><strong>RequÃªtes</strong></td>
                                <td>SQL (langage standardisÃ©)</td>
                                <td>API MongoDB ou MQL (MongoDB Query Language)</td>
                            </tr>
                            <tr>
                                <td><strong>Cas d'usage typiques</strong></td>
                                <td>Banques, e-commerce (transactions), ERP, CRM</td>
                                <td>Logs, analytics, catalogues, IoT, contenus variables</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="tip-box">
                    <h4>ğŸ’¡ Ne pas opposer SQL et NoSQL !</h4>
                    <p>Ce n'est <strong>pas</strong> "SQL OU NoSQL".   Dans une vraie application, vous pouvez (et devriez) utiliser <strong>les deux</strong> selon les besoins :</p>
                    <ul>
                        <li><strong>PostgreSQL</strong> pour les donnÃ©es transactionnelles (users, orders, payments) â†’ intÃ©gritÃ©, ACID</li>
                        <li><strong>MongoDB</strong> pour les logs, analytics, contenus flexibles â†’ rapiditÃ©, volume</li>
                        <li><strong>Redis</strong> pour le cache, sessions â†’ ultra-rapide</li>
                    </ul>
                    <p>C'est ce qu'on appelle <strong>Polyglot Persistence</strong> (qu'on verra en Partie 3).</p>
                </div>

                <h3>2.3 MongoDB : Concepts Fondamentaux</h3>

                <div class="visual-box">
                    <h4 style="color: #667eea;">Structure MongoDB vs SQL</h4>
<pre style="background: #f5f5f5; color: #333; padding: 20px; border-radius: 8px;">
SQL                          MongoDB
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Database                  â†â†’ Database
Table                     â†â†’ Collection
Row (ligne)               â†â†’ Document
Column (colonne)          â†â†’ Field (champ)
Primary Key               â†â†’ _id (auto-gÃ©nÃ©rÃ©)
Index                     â†â†’ Index
JOIN                      â†â†’ Embedding ou $lookup
Transaction               â†â†’ Transaction (depuis v4.0)

Exemple Visuel :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

SQL Table "users":
+----+---------+------------------+-----+
| id | name    | email            | age |
+----+---------+------------------+-----+
| 1  | Alice   | alice@email.com  | 25  |
| 2  | Bob     | bob@email.com    | 30  |
+----+---------+------------------+-----+

MongoDB Collection "users":
{
  "_id": ObjectId("507f1f77bcf86cd799439011"),
  "name": "Alice",
  "email": "alice@email.com",
  "age": 25
}
{
  "_id": ObjectId("507f1f77bcf86cd799439012"),
  "name": "Bob",
  "email": "bob@email.com",
  "age": 30,
  "address": {  â† Champ supplÃ©mentaire que Alice n'a pas ! 
    "city": "Paris",
    "zipcode": "75001"
  }
}
</pre>
                </div>

                <div class="explanation">
                    <h4>ğŸ“– Explication des concepts</h4>
                    <ul>
                        <li><strong>Database</strong> : Conteneur de collections.   Ex: "ecommerce_db", "logs_db"</li>
                        <li><strong>Collection</strong> : Groupe de documents (Ã©quivalent d'une table SQL). Ex: "users", "products", "orders"</li>
                        <li><strong>Document</strong> : Un objet JSON.   Ã‰quivalent d'une ligne SQL, MAIS peut avoir une structure diffÃ©rente d'un document Ã  l'autre</li>
                        <li><strong>_id</strong> : Chaque document a un <span class="inline-code">_id</span> unique (clÃ© primaire).   Si vous ne le spÃ©cifiez pas, MongoDB gÃ©nÃ¨re automatiquement un <span class="inline-code">ObjectId</span></li>
                        <li><strong>ObjectId</strong> : Identifiant unique de 12 bytes, contient un timestamp (donc tri chronologique naturel)</li>
                    </ul>
                </div>

                <div class="example-box">
                    <h4>âœ… Exemple de Document MongoDB</h4>
<pre><code>{
  "_id": ObjectId("65a1b2c3d4e5f6789abc1234"),
  "timestamp": ISODate("2025-12-07T10:30:45.123Z"),
  "level": "ERROR",
  "service": "payment-api",
  "message": "Database connection timeout after 5000ms",
  "metadata": {
    "user_id": "U12345",
    "ip_address": "192.168. 1.100",
    "request_id": "req_xyz789",
    "duration_ms": 5023
  },
  "stack_trace": "java.sql.SQLException: Connection timeout.. .",
  "tags": ["critical", "database", "timeout", "production"],
  "resolved": false,
  "resolved_at": null
}</code></pre>
                    <p><strong>Points Ã  noter :</strong></p>
                    <ul>
                        <li>Champs <strong>imbriquÃ©s</strong> : <span class="inline-code">metadata</span> est un objet dans l'objet</li>
                        <li><strong>Array</strong> : <span class="inline-code">tags</span> est un tableau</li>
                        <li><strong>Types variÃ©s</strong> : String, Number, Date, Boolean, Object, Array, null</li>
                        <li><strong>Pas de schÃ©ma fixe</strong> : Vous pourriez avoir un autre log avec des champs complÃ¨tement diffÃ©rents</li>
                    </ul>
                </div>

                <h3>2.4 OpÃ©rations CRUD avec MongoDB Java Driver</h3>

                <div class="intro-box">
                    <h3>ğŸ”Œ Connexion Ã  MongoDB depuis Java</h3>
                    <p>Pour utiliser MongoDB en Java, vous avez besoin du <strong>MongoDB Java Driver</strong>.   C'est une bibliothÃ¨que officielle qui fournit une API Java pour communiquer avec MongoDB.</p>
                </div>

                <div class="step">
                    <h4>Installation du Driver MongoDB</h4>

                    <p><strong>Ajoutez la dÃ©pendance Maven :</strong></p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
    &lt;artifactId&gt;mongodb-driver-sync&lt;/artifactId&gt;
    &lt;version&gt;4.11.1&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
                </div>

<pre><code>import com.mongodb.client.*;
import org.bson.Document;
import org.bson.types.ObjectId;
import static com.mongodb.client.model. Filters.*;
import static com.mongodb.client.model.Updates.*;
import static com.mongodb.client.model. Sorts.*;
import java.util.Date;
import java.util.ArrayList;
import java.util.List;

/**
 * Classe dÃ©montrant toutes les opÃ©rations CRUD avec MongoDB
 */
public class MongoDBCRUDExample {
    
    private MongoClient mongoClient;
    private MongoDatabase database;
    private MongoCollection&lt;Document&gt; logsCollection;
    
    /**
     * Connexion Ã  MongoDB
     * URL format : mongodb://[username:password@]host:port/[database]
     */
    public void connect() {
        // Connexion locale (MongoDB sur localhost:27017)
        mongoClient = MongoClients.create("mongodb://localhost:27017");
        
        // SÃ©lectionner (ou crÃ©er si n'existe pas) la base de donnÃ©es
        database = mongoClient.getDatabase("application_db");
        
        // SÃ©lectionner (ou crÃ©er) la collection
        logsCollection = database.getCollection("logs");
        
        System.out.println("âœ… ConnectÃ© Ã  MongoDB !");
    }
    
    // =========================================
    // CREATE : InsÃ©rer des documents
    // =========================================
    
    /**
     * InsÃ©rer UN document
     */
    public void insertOneLog() {
        Document log = new Document("timestamp", new Date())
            .append("level", "INFO")
            .append("service", "user-service")
            .append("message", "User logged in successfully")
            .append("metadata", new Document()
                .append("user_id", "U001")
                .append("ip", "192.168.1.50"))
            .append("tags", List.of("login", "success"));
        
        logsCollection. insertOne(log);
        
        // L'_id est automatiquement gÃ©nÃ©rÃ©
        System.out.println("âœ… Log insÃ©rÃ© avec _id : " + log.getObjectId("_id"));
    }
    
    /**
     * InsÃ©rer PLUSIEURS documents en une fois
     */
    public void insertManyLogs() {
        List&lt;Document&gt; logs = new ArrayList&lt;&gt;();
        
        logs.add(new Document("timestamp", new Date())
            . append("level", "WARNING")
            .append("service", "payment-api")
            .append("message", "Payment processing slow")
            .append("metadata", new Document("duration_ms", 3500)));
        
        logs.add(new Document("timestamp", new Date())
            .append("level", "ERROR")
            .append("service", "email-service")
            .append("message", "Failed to send email")
            .append("metadata", new Document("recipient", "user@example.com")));
        
        logs.add(new Document("timestamp", new Date())
            .append("level", "INFO")
            . append("service", "user-service")
            .append("message", "User registered")
            .append("metadata", new Document("user_id", "U002")));
        
        logsCollection.insertMany(logs);
        
        System.out.println("âœ… InsÃ©rÃ© " + logs.size() + " logs");
    }
    
    // =========================================
    // READ : Lire des documents
    // =========================================
    
    /**
     * Trouver TOUS les documents
     */
    public void findAllLogs() {
        System.out.println("\n=== Tous les logs ===");
        
        FindIterable&lt;Document&gt; results = logsCollection.find();
        
        for (Document doc : results) {
            System.out.println(doc. toJson());  // Affiche en JSON
        }
    }
    
    /**
     * Trouver avec un FILTRE
     */
    public void findErrorLogs() {
        System. out.println("\n=== Logs de niveau ERROR ===");
        
        // MÃ©thode 1 : avec un Document
        Document filter = new Document("level", "ERROR");
        FindIterable&lt;Document&gt; results1 = logsCollection.find(filter);
        
        // MÃ©thode 2 : avec Filters (plus lisible, recommandÃ©)
        FindIterable&lt;Document&gt; results2 = logsCollection.find(eq("level", "ERROR"));
        
        for (Document doc : results2) {
            System.out.println("- " + doc.getString("service") + ": " + doc.getString("message"));
        }
    }
    
    /**
     * Trouver avec PLUSIEURS conditions (AND, OR)
     */
    public void findWithComplexFilters() {
        System.out.println("\n=== Logs ERROR du service payment-api ===");
        
        // AND : level = "ERROR" AND service = "payment-api"
        FindIterable&lt;Document&gt; results = logsCollection.find(
            and(
                eq("level", "ERROR"),
                eq("service", "payment-api")
            )
        );
        
        for (Document doc : results) {
            System.out.println(doc.toJson());
        }
        
        // OR : level = "ERROR" OR level = "WARNING"
        FindIterable&lt;Document&gt; warningsOrErrors = logsCollection.find(
            or(
                eq("level", "ERROR"),
                eq("level", "WARNING")
            )
        );
        
        // Comparaisons : duration_ms > 3000
        FindIterable&lt;Document&gt; slowLogs = logsCollection.find(
            gt("metadata.duration_ms", 3000)  // gt = greater than
        );
        
        // IN : service IN ("user-service", "payment-api")
        FindIterable&lt;Document&gt; specificServices = logsCollection.find(
            in("service", "user-service", "payment-api")
        );
        
        // EXISTS : vÃ©rifie qu'un champ existe
        FindIterable&lt;Document&gt; logsWithStackTrace = logsCollection.find(
            exists("stack_trace", true)
        );
    }
    
    /**
     * Trouver UN SEUL document
     */
    public void findOneLog() {
        Document log = logsCollection.find(eq("level", "ERROR")).first();
        
        if (log != null) {
            System.out.println("Premier log ERROR : " + log.toJson());
        } else {
            System.out.println("Aucun log ERROR trouvÃ©");
        }
    }
    
    /**
     * Trouver par _id
     */
    public void findById(String id) {
        Document log = logsCollection.find(eq("_id", new ObjectId(id))).first();
        
        if (log != null) {
            System.out.println("Log trouvÃ© : " + log.toJson());
        }
    }
    
    /**
     * Trier, limiter, sauter (pagination)
     */
    public void findWithSortLimitSkip() {
        System. out.println("\n=== 10 logs les plus rÃ©cents ===");
        
        FindIterable&lt;Document&gt; recent = logsCollection.find()
            .sort(descending("timestamp"))  // Tri dÃ©croissant par timestamp
            .limit(10);  // Limiter Ã  10 rÃ©sultats
        
        for (Document doc : recent) {
            System. out.println(doc.getDate("timestamp") + " - " + doc.getString("message"));
        }
        
        // Pagination : page 2 (skip 10, limit 10)
        FindIterable&lt;Document&gt; page2 = logsCollection.find()
            .sort(descending("timestamp"))
            .skip(10)   // Sauter les 10 premiers
            .limit(10); // Prendre les 10 suivants
    }
    
    /**
     * Projection : rÃ©cupÃ©rer seulement certains champs
     */
    public void findWithProjection() {
        System. out.println("\n=== Seulement level et message ===");
        
        FindIterable&lt;Document&gt; results = logsCollection.find()
            .projection(new Document("level", 1).append("message", 1). append("_id", 0));
        // 1 = inclure, 0 = exclure
        // Par dÃ©faut _id est toujours inclus, sauf si on le met explicitement Ã  0
        
        for (Document doc : results) {
            System.out. println(doc.toJson());  // Ne contient que level et message
        }
    }
    
    // =========================================
    // UPDATE : Modifier des documents
    // =========================================
    
    /**
     * Mettre Ã  jour UN document
     */
    public void updateOneLog() {
        // Trouver un log ERROR et le marquer comme rÃ©solu
        logsCollection.updateOne(
            eq("level", "ERROR"),  // Filtre : quel document modifier
            combine(                // Modifications Ã  appliquer
                set("resolved", true),
                set("resolved_at", new Date())
            )
        );
        
        System.out.println("âœ… Log mis Ã  jour");
    }
    
    /**
     * Mettre Ã  jour PLUSIEURS documents
     */
    public void updateManyLogs() {
        // Marquer tous les logs INFO comme "archived"
        logsCollection.updateMany(
            eq("level", "INFO"),
            set("archived", true)
        );
        
        System.out.println("âœ… Logs INFO archivÃ©s");
    }
    
    /**
     * OpÃ©rateurs de mise Ã  jour avancÃ©s
     */
    public void advancedUpdates() {
        // IncrÃ©menter un compteur
        logsCollection.updateOne(
            eq("_id", new ObjectId("...")),
            inc("retry_count", 1)  // IncrÃ©mente retry_count de 1
        );
        
        // Ajouter un Ã©lÃ©ment Ã  un tableau
        logsCollection. updateOne(
            eq("_id", new ObjectId("...")),
            addToSet("tags", "investigated")  // Ajoute "investigated" au tableau tags (si pas dÃ©jÃ  prÃ©sent)
        );
        
        // Retirer un Ã©lÃ©ment d'un tableau
        logsCollection.updateOne(
            eq("_id", new ObjectId("...")),
            pull("tags", "temporary")  // Retire "temporary" du tableau tags
        );
        
        // Renommer un champ
        logsCollection.updateOne(
            eq("_id", new ObjectId("...")),
            rename("old_field_name", "new_field_name")
        );
        
        // Supprimer un champ
        logsCollection.updateOne(
            eq("_id", new ObjectId("...")),
            unset("field_to_remove")
        );
    }
    
    /**
     * Upsert : UPDATE si existe, INSERT sinon
     */
    public void upsertExample() {
        logsCollection.updateOne(
            eq("service", "new-service"),
            set("last_check", new Date()),
            new com.mongodb.client.model.UpdateOptions().upsert(true)  // â­ upsert
        );
        
        // Si un document avec service="new-service" existe â†’ UPDATE
        // Sinon â†’ INSERT un nouveau document
    }
    
    // =========================================
    // DELETE : Supprimer des documents
    // =========================================
    
    /**
     * Supprimer UN document
     */
    public void deleteOneLog() {
        logsCollection.deleteOne(eq("level", "INFO"));
        System.out.println("âœ… Un log INFO supprimÃ©");
    }
    
    /**
     * Supprimer PLUSIEURS documents
     */
    public void deleteManyLogs() {
        // Supprimer tous les logs de plus de 30 jours
        Date thirtyDaysAgo = new Date(System.currentTimeMillis() - (30L * 24 * 60 * 60 * 1000));
        
        logsCollection.deleteMany(
            lt("timestamp", thirtyDaysAgo)  // lt = less than
        );
        
        System.out.println("âœ… Logs de plus de 30 jours supprimÃ©s");
    }
    
    /**
     * Supprimer TOUS les documents d'une collection
     */
    public void deleteAllLogs() {
        logsCollection.deleteMany(new Document());  // Filtre vide = tous les documents
        System.out.println("âš ï¸ Tous les logs supprimÃ©s !");
    }
    
    // =========================================
    // COMPTER
    // =========================================
    
    /**
     * Compter les documents
     */
    public void countLogs() {
        long totalLogs = logsCollection.countDocuments();
        System.out.println("Total logs : " + totalLogs);
        
        long errorLogs = logsCollection.countDocuments(eq("level", "ERROR"));
        System.out.println("Logs ERROR : " + errorLogs);
    }
    
    /**
     * Fermer la connexion
     */
    public void close() {
        mongoClient.close();
        System.out.println("âœ… Connexion MongoDB fermÃ©e");
    }
    
    // =========================================
    // MAIN : Test de toutes les opÃ©rations
    // =========================================
    
    public static void main(String[] args) {
        MongoDBCRUDExample example = new MongoDBCRUDExample();
        
        try {
            example.connect();
            
            // INSERT
            example.insertOneLog();
            example.insertManyLogs();
            
            // READ
            example.findAllLogs();
            example.findErrorLogs();
            example.findWithComplexFilters();
            example.findWithProjection();
            
            // UPDATE
            example.updateOneLog();
            example.updateManyLogs();
            
            // DELETE
            // example.deleteOneLog();  // DÃ©commentez pour tester
            
            // COUNT
            example.countLogs();
            
        } finally {
            example.close();
        }
    }
}</code></pre>

                <div class="code-explanation">
                    <h5>ğŸ“ Points clÃ©s du code</h5>
                    <ul>
                        <li><strong>MongoClient</strong> : Objet de connexion Ã  MongoDB.   CrÃ©ez-le une fois, rÃ©utilisez-le (thread-safe)</li>
                        <li><strong>MongoDatabase</strong> : ReprÃ©sente une base de donnÃ©es.   CrÃ©Ã©e automatiquement si n'existe pas</li>
                        <li><strong>MongoCollection&lt;Document&gt;</strong> : ReprÃ©sente une collection.   CrÃ©Ã©e automatiquement au premier insert</li>
                        <li><strong>Document</strong> : Classe Java qui reprÃ©sente un document MongoDB (essentiellement une Map)</li>
                        <li><strong>Filters</strong> : Classe utilitaire pour construire des filtres de requÃªtes (eq, gt, lt, and, or... )</li>
                        <li><strong>Updates</strong> : Classe utilitaire pour les opÃ©rations de mise Ã  jour (set, inc, push... )</li>
                    </ul>
                </div>

                <div class="tip-box">
                    <h4>ğŸ’¡ Bonnes pratiques MongoDB en Java</h4>
                    <ul>
                        <li><strong>RÃ©utilisez MongoClient</strong> : Ne crÃ©ez pas un nouveau client Ã  chaque requÃªte, c'est coÃ»teux.  CrÃ©ez-le au dÃ©marrage de l'application</li><li><strong>Utilisez des index</strong> : Pour les champs frÃ©quemment recherchÃ©s (ex: level, service, timestamp), crÃ©ez des index pour accÃ©lÃ©rer les requÃªtes</li>
                        <li><strong>Fermez les connexions</strong> : Appelez <span class="inline-code">mongoClient.close()</span> Ã  l'arrÃªt de l'application</li>
                        <li><strong>Gestion d'erreurs</strong> : Entourez les opÃ©rations avec try-catch pour gÃ©rer les exceptions (MongoException)</li>
                        <li><strong>Connection pooling</strong> : MongoClient gÃ¨re automatiquement un pool de connexions, pas besoin de le faire manuellement</li>
                    </ul>
                </div>

                <h3>2. 5 Aggregation Pipeline : La Puissance de MongoDB</h3>

                <div class="intro-box">
                    <h3>ğŸš€ Qu'est-ce que l'Aggregation Pipeline ?</h3>
                    <p>L'<strong>Aggregation Pipeline</strong> est la fonctionnalitÃ© la plus puissante de MongoDB.  Elle permet de traiter les donnÃ©es en plusieurs <strong>Ã©tapes</strong> successives, comme un pipeline Unix :</p>
                    
                    <p><strong>Analogie</strong> : Imaginez une usine avec une chaÃ®ne de production :</p>
                    <ul>
                        <li><strong>Ã‰tape 1</strong> : Filtrer les matiÃ¨res premiÃ¨res (ne garder que certains documents)</li>
                        <li><strong>Ã‰tape 2</strong> : Transformer les piÃ¨ces (modifier les documents, ajouter des champs calculÃ©s)</li>
                        <li><strong>Ã‰tape 3</strong> : Regrouper par type (grouper les documents et calculer des statistiques)</li>
                        <li><strong>Ã‰tape 4</strong> : Trier par qualitÃ© (trier les rÃ©sultats)</li>
                        <li><strong>Ã‰tape 5</strong> : Emballer les 10 meilleurs (limiter le nombre de rÃ©sultats)</li>
                    </ul>
                    
                    <p>Chaque Ã©tape prend les documents de l'Ã©tape prÃ©cÃ©dente, les traite, et passe le rÃ©sultat Ã  l'Ã©tape suivante.</p>
                </div>

                <div class="visual-box">
                    <h4 style="color: #667eea;">SchÃ©ma d'un Aggregation Pipeline</h4>
<pre style="background: #f5f5f5; color: #333; padding: 20px; border-radius: 8px;">
Collection initiale (1000 documents)
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  $match (Filtrer)      â”‚  â†’  Garde seulement level="ERROR" (100 docs)
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  $group (Regrouper)    â”‚  â†’  Groupe par "service", compte les erreurs (10 groupes)
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  $sort (Trier)         â”‚  â†’  Trie par nombre d'erreurs dÃ©croissant (10 groupes triÃ©s)
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  $limit (Limiter)      â”‚  â†’  Garde les 5 premiers (5 groupes)
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   RÃ©sultat final : Top 5 services avec le plus d'erreurs
</pre>
                </div>

                <div class="explanation">
                    <h4>ğŸ“– Principales Ã‰tapes (Stages) du Pipeline</h4>
                    <table style="margin-top: 15px;">
                        <thead>
                            <tr>
                                <th>Stage</th>
                                <th>Description</th>
                                <th>Ã‰quivalent SQL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>$match</strong></td>
                                <td>Filtre les documents (comme find())</td>
                                <td>WHERE</td>
                            </tr>
                            <tr>
                                <td><strong>$group</strong></td>
                                <td>Regroupe par un champ et calcule des agrÃ©gations</td>
                                <td>GROUP BY</td>
                            </tr>
                            <tr>
                                <td><strong>$sort</strong></td>
                                <td>Trie les rÃ©sultats</td>
                                <td>ORDER BY</td>
                            </tr>
                            <tr>
                                <td><strong>$limit</strong></td>
                                <td>Limite le nombre de rÃ©sultats</td>
                                <td>LIMIT</td>
                            </tr>
                            <tr>
                                <td><strong>$skip</strong></td>
                                <td>Saute N rÃ©sultats (pagination)</td>
                                <td>OFFSET</td>
                            </tr>
                            <tr>
                                <td><strong>$project</strong></td>
                                <td>SÃ©lectionne/transforme les champs Ã  retourner</td>
                                <td>SELECT</td>
                            </tr>
                            <tr>
                                <td><strong>$unwind</strong></td>
                                <td>DÃ©compose un tableau en plusieurs documents</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td><strong>$lookup</strong></td>
                                <td>Jointure avec une autre collection</td>
                                <td>JOIN</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h4>Exemples Pratiques d'Aggregation</h4>

<pre><code>/**
 * Exemples d'Aggregation Pipeline
 */
public class MongoAggregationExamples {
    
    private MongoCollection&lt;Document&gt; logsCollection;
    
    /**
     * Exemple 1 : Compter les erreurs par service dans les derniÃ¨res 24h
     */
    public void countErrorsByService() {
        System.out.println("\n=== Erreurs par service (24h) ===");
        
        // Date d'il y a 24h
        Date twentyFourHoursAgo = new Date(System.currentTimeMillis() - (24 * 60 * 60 * 1000));
        
        List&lt;Document&gt; pipeline = Arrays.asList(
            // Ã‰tape 1 : Filtrer les logs des derniÃ¨res 24h avec level=ERROR
            new Document("$match", new Document()
                .append("timestamp", new Document("$gte", twentyFourHoursAgo))
                .append("level", "ERROR")),
            
            // Ã‰tape 2 : Regrouper par service et compter
            new Document("$group", new Document()
                .append("_id", "$service")  // Grouper par le champ "service"
                .append("error_count", new Document("$sum", 1))  // Compter : +1 pour chaque doc
                .append("last_error", new Document("$max", "$timestamp"))),  // DerniÃ¨re erreur
            
            // Ã‰tape 3 : Trier par nombre d'erreurs (dÃ©croissant)
            new Document("$sort", new Document("error_count", -1)),
            
            // Ã‰tape 4 : Limiter aux 10 premiers
            new Document("$limit", 10)
        );
        
        AggregateIterable&lt;Document&gt; results = logsCollection.aggregate(pipeline);
        
        for (Document doc : results) {
            System. out.println(String.format(
                "Service: %s | Erreurs: %d | DerniÃ¨re: %s",
                doc.getString("_id"),
                doc. getInteger("error_count"),
                doc.getDate("last_error")
            ));
        }
    }
    
    /**
     * Exemple 2 : Statistiques avancÃ©es (moyenne, min, max)
     */
    public void computeStatistics() {
        System.out.println("\n=== Statistiques de durÃ©e par service ===");
        
        List&lt;Document&gt; pipeline = Arrays.asList(
            // Filtrer : seulement les logs qui ont metadata.duration_ms
            new Document("$match", new Document("metadata.duration_ms", 
                new Document("$exists", true))),
            
            // Grouper par service et calculer des stats
            new Document("$group", new Document()
                .append("_id", "$service")
                .append("avg_duration", new Document("$avg", "$metadata.duration_ms"))
                .append("min_duration", new Document("$min", "$metadata.duration_ms"))
                .append("max_duration", new Document("$max", "$metadata. duration_ms"))
                .append("total_requests", new Document("$sum", 1))),
            
            // Trier par durÃ©e moyenne dÃ©croissante
            new Document("$sort", new Document("avg_duration", -1))
        );
        
        AggregateIterable&lt;Document&gt; results = logsCollection.aggregate(pipeline);
        
        for (Document doc : results) {
            System.out. println(String.format(
                "Service: %s | Avg: %.2fms | Min: %dms | Max: %dms | RequÃªtes: %d",
                doc.getString("_id"),
                doc.getDouble("avg_duration"),
                doc.getInteger("min_duration"),
                doc.getInteger("max_duration"),
                doc.getInteger("total_requests")
            ));
        }
    }
    
    /**
     * Exemple 3 : $unwind - DÃ©composer un tableau
     * Cas d'usage : chaque log a un tableau "tags", on veut compter la frÃ©quence de chaque tag
     */
    public void countTagsFrequency() {
        System.out.println("\n=== FrÃ©quence des tags ===");
        
        List&lt;Document&gt; pipeline = Arrays. asList(
            // Ã‰tape 1 : "DÃ©rouler" le tableau tags
            // Si un doc a tags=["error", "critical"], Ã§a crÃ©e 2 documents sÃ©parÃ©s
            new Document("$unwind", "$tags"),
            
            // Ã‰tape 2 : Grouper par tag et compter
            new Document("$group", new Document()
                .append("_id", "$tags")  // Grouper par chaque tag
                .append("count", new Document("$sum", 1))),
            
            // Ã‰tape 3 : Trier par frÃ©quence
            new Document("$sort", new Document("count", -1)),
            
            // Ã‰tape 4 : Top 20
            new Document("$limit", 20)
        );
        
        AggregateIterable&lt;Document&gt; results = logsCollection.aggregate(pipeline);
        
        for (Document doc : results) {
            System. out.println(String.format(
                "Tag: %s â†’ utilisÃ© %d fois",
                doc. getString("_id"),
                doc.getInteger("count")
            ));
        }
    }
    
    /**
     * Exemple 4 : $project - Transformer les documents
     */
    public void projectExample() {
        System.out.println("\n=== Logs avec champs calculÃ©s ===");
        
        List&lt;Document&gt; pipeline = Arrays.asList(
            new Document("$match", new Document("level", "ERROR")),
            
            // $project : sÃ©lectionner et transformer des champs
            new Document("$project", new Document()
                . append("service", 1)  // Inclure le champ service
                . append("message", 1)  // Inclure le champ message
                . append("short_message", new Document("$substr", 
                    Arrays.asList("$message", 0, 50)))  // CrÃ©er un champ calculÃ© : 50 premiers chars
                .append("hour", new Document("$hour", "$timestamp"))  // Extraire l'heure du timestamp
                .append("_id", 0))  // Exclure _id
        );
        
        AggregateIterable&lt;Document&gt; results = logsCollection. aggregate(pipeline);
        
        for (Document doc : results) {
            System.out.println(doc.toJson());
        }
    }
    
    /**
     * Exemple 5 : $lookup - Jointure entre collections
     * Supposons qu'on a une collection "users" et on veut joindre avec les logs
     */
    public void lookupExample() {
        // Pipeline sur la collection logs
        List&lt;Document&gt; pipeline = Arrays.asList(
            new Document("$match", new Document("metadata.user_id", 
                new Document("$exists", true))),
            
            // Jointure avec la collection "users"
            new Document("$lookup", new Document()
                .append("from", "users")  // Collection Ã  joindre
                .append("localField", "metadata.user_id")  // Champ dans logs
                .append("foreignField", "user_id")  // Champ dans users
                .append("as", "user_info")),  // Nom du champ qui contiendra le rÃ©sultat
            
            // Limiter
            new Document("$limit", 10)
        );
        
        AggregateIterable&lt;Document&gt; results = logsCollection.aggregate(pipeline);
        
        for (Document doc : results) {
            System. out.println(doc.toJson());
            // Le document aura maintenant un champ "user_info" avec les donnÃ©es de l'utilisateur
        }
    }
    
    /**
     * Exemple 6 : Pipeline complexe - Logs par heure avec moyenne de durÃ©e
     */
    public void logsByHour() {
        System.out. println("\n=== Logs par heure avec durÃ©e moyenne ===");
        
        List&lt;Document&gt; pipeline = Arrays.asList(
            // Filtrer les derniÃ¨res 24h
            new Document("$match", new Document("timestamp", 
                new Document("$gte", new Date(System.currentTimeMillis() - 86400000)))),
            
            // Ajouter un champ calculÃ© : l'heure
            new Document("$addFields", new Document("hour", 
                new Document("$hour", "$timestamp"))),
            
            // Grouper par service ET heure
            new Document("$group", new Document()
                .append("_id", new Document()
                    .append("service", "$service")
                    .append("hour", "$hour"))
                .append("log_count", new Document("$sum", 1))
                .append("avg_duration", new Document("$avg", "$metadata.duration_ms"))),
            
            // Restructurer le rÃ©sultat
            new Document("$project", new Document()
                .append("service", "$_id. service")
                .append("hour", "$_id.hour")
                .append("log_count", 1)
                .append("avg_duration", 1)
                .append("_id", 0)),
            
            // Trier
            new Document("$sort", new Document()
                .append("service", 1)
                .append("hour", 1))
        );
        
        AggregateIterable&lt;Document&gt; results = logsCollection.aggregate(pipeline);
        
        for (Document doc : results) {
            System.out. println(String.format(
                "%s Ã  %dh : %d logs, durÃ©e moy: %.2fms",
                doc.getString("service"),
                doc.getInteger("hour"),
                doc.getInteger("log_count"),
                doc.getDouble("avg_duration")
            ));
        }
    }
}</code></pre>

                <div class="code-explanation">
                    <h5>ğŸ“ Comprendre les OpÃ©rateurs d'AgrÃ©gation</h5>
                    <ul>
                        <li><strong>$sum: 1</strong> : Compte le nombre de documents (+1 pour chaque doc)</li>
                        <li><strong>$sum: "$field"</strong> : Somme les valeurs du champ</li>
                        <li><strong>$avg</strong> : Calcule la moyenne</li>
                        <li><strong>$min / $max</strong> : Minimum / Maximum</li>
                        <li><strong>$first / $last</strong> : Premier / Dernier document du groupe</li>
                        <li><strong>$push</strong> : CrÃ©e un tableau avec toutes les valeurs du groupe</li>
                        <li><strong>$addToSet</strong> : Comme $push mais sans doublons</li>
                    </ul>
                </div>

                <div class="tip-box">
                    <h4>ğŸ’¡ Bonnes pratiques Aggregation Pipeline</h4>
                    <ul>
                        <li><strong>Filtrer tÃ´t</strong> : Mettez $match au dÃ©but pour rÃ©duire le nombre de documents Ã  traiter</li>
                        <li><strong>Utiliser des index</strong> : $match peut utiliser les index si c'est la premiÃ¨re Ã©tape</li>
                        <li><strong>Limiter tÃ´t</strong> : Si vous n'avez besoin que de 10 rÃ©sultats, mettez $limit aprÃ¨s $sort</li>
                        <li><strong>Ã‰viter $unwind sur de gros tableaux</strong> : Ã‡a peut crÃ©er beaucoup de documents temporaires</li>
                        <li><strong>explain()</strong> : Utilisez . explain() pour voir comment MongoDB exÃ©cute le pipeline</li>
                        <li><strong>Monitorer les performances</strong> : Les pipelines complexes peuvent Ãªtre lents, surveillez avec MongoDB Profiler</li>
                    </ul>
                </div>

                <h3>2.6 ModÃ©lisation : Embedding vs Referencing</h3>

                <div class="intro-box">
                    <h3>ğŸ¤” Le dilemme de la modÃ©lisation NoSQL</h3>
                    <p>En SQL, les relations entre entitÃ©s sont claires : vous utilisez des clÃ©s Ã©trangÃ¨res et des JOIN. En MongoDB (NoSQL orientÃ© document), vous avez <strong>deux approches</strong> pour gÃ©rer les relations :</p>
                    <ul>
                        <li><strong>Embedding (Imbrication)</strong> : Mettre les donnÃ©es liÃ©es directement dans le document parent</li>
                        <li><strong>Referencing (RÃ©fÃ©rence)</strong> : Stocker l'ID de l'autre document (comme une clÃ© Ã©trangÃ¨re SQL)</li>
                    </ul>
                    <p><strong>Quelle approche choisir ? </strong> Ã‡a dÃ©pend de votre cas d'usage.   C'est LA dÃ©cision la plus importante en modÃ©lisation MongoDB.</p>
                </div>

                <h4>A.  Embedding (DonnÃ©es ImbriquÃ©es)</h4>

                <div class="concept-box">
                    <h4>ğŸ’¡ Qu'est-ce que l'Embedding ?</h4>
                    <p>Au lieu de sÃ©parer les donnÃ©es en plusieurs collections, vous les <strong>imbriquez</strong> dans un seul document.  C'est la <strong>dÃ©normalisation</strong> : vous dupliquez des donnÃ©es pour les avoir en un seul endroit.</p>
                </div>

                <div class="example-box">
                    <h4>âœ… Exemple : Blog avec articles et commentaires</h4>
<pre><code>// ========================================
// APPROCHE EMBEDDING
// ========================================

// Collection "articles"
{
  "_id": ObjectId("65a1b2c3d4e5f6789abc1234"),
  "title": "Introduction Ã  MongoDB",
  "author": "Ahmed",
  "content": "MongoDB est une base NoSQL.. .",
  "published_date": ISODate("2025-12-01T10:00:00Z"),
  "views": 1500,
  
  // â­ Commentaires IMBRIQUÃ‰S dans l'article
  "comments": [
    {
      "comment_id": 1,
      "user": "Alice",
      "text": "Super article, merci !",
      "date": ISODate("2025-12-02T14:30:00Z"),
      "likes": 5
    },
    {
      "comment_id": 2,
      "user": "Bob",
      "text": "TrÃ¨s instructif",
      "date": ISODate("2025-12-03T09:15:00Z"),
      "likes": 3
    },
    {
      "comment_id": 3,
      "user": "Charlie",
      "text": "J'ai une question...",
      "date": ISODate("2025-12-03T16:45:00Z"),
      "likes": 1
    }
  ],
  
  "tags": ["mongodb", "nosql", "database", "tutorial"]
}</code></pre>

                    <p><strong>âœ… Avantages :</strong></p>
                    <ul>
                        <li><strong>Une seule requÃªte</strong> : Pour rÃ©cupÃ©rer un article avec tous ses commentaires, une seule lecture en base</li>
                        <li><strong>CohÃ©rence atomique</strong> : Mise Ã  jour de l'article et de ses commentaires en une transaction</li>
                        <li><strong>Performance</strong> : Pas de jointures, donnÃ©es co-localisÃ©es sur le disque</li>
                        <li><strong>ModÃ¨le simple</strong> : Tout est au mÃªme endroit, facile Ã  comprendre</li>
                    </ul>

                    <p><strong>âŒ InconvÃ©nients :</strong></p>
                    <ul>
                        <li><strong>Limitation de taille</strong> : Un document MongoDB ne peut pas dÃ©passer 16 MB.  Si un article a 10 000 commentaires, problÃ¨me !</li>
                        <li><strong>Duplication</strong> : Si un utilisateur "Alice" change de nom, il faut mettre Ã  jour tous les articles oÃ¹ elle a commentÃ©</li>
                        <li><strong>AccÃ¨s partiel difficile</strong> : Si vous voulez seulement les commentaires rÃ©cents d'un article, vous chargez tout l'article</li>
                        <li><strong>Concurrence</strong> : Si deux utilisateurs commentent en mÃªme temps, risque de conflit</li>
                    </ul>
                </div>

                <div class="tip-box">
                    <h4>âœ… Utiliser Embedding quand :</h4>
                    <ul>
                        <li>Relation <strong>One-to-Few</strong> (un parent, peu d'enfants : 1 article, 5-50 commentaires)</li>
                        <li>Les donnÃ©es sont <strong>toujours accÃ©dÃ©es ensemble</strong> (article + commentaires affichÃ©s ensemble)</li>
                        <li>Les donnÃ©es enfants <strong>n'ont pas de sens sans le parent</strong> (un commentaire sans article n'existe pas)</li>
                        <li>Les donnÃ©es changent <strong>rarement</strong> ou <strong>toujours ensemble</strong></li>
                        <li>Vous avez besoin de <strong>performance en lecture</strong></li>
                    </ul>
                </div>

                <h4>B. Referencing (RÃ©fÃ©rences)</h4>

                <div class="concept-box">
                    <h4>ğŸ’¡ Qu'est-ce que le Referencing ?</h4>
                    <p>Comme en SQL, vous stockez les donnÃ©es dans des <strong>collections sÃ©parÃ©es</strong> et vous reliez avec des <strong>IDs</strong>. C'est la <strong>normalisation</strong> : chaque donnÃ©e n'existe qu'une fois.</p>
                </div>

                <div class="example-box">
                    <h4>âœ… Exemple : E-commerce avec utilisateurs et commandes</h4>
<pre><code>// ========================================
// APPROCHE REFERENCING
// ========================================

// Collection "users"
{
  "_id": ObjectId("user_001"),
  "name": "Ahmed",
  "email": "ahmed@example.com",
  "phone": "+33612345678",
  "address": {
    "street": "123 Rue de la Paix",
    "city": "Paris",
    "zipcode": "75001"
  },
  "registration_date": ISODate("2024-01-15T10:00:00Z")
}

// Collection "orders"
{
  "_id": ObjectId("order_001"),
  "user_id": ObjectId("user_001"),  // â­ RÃ©fÃ©rence vers users
  "order_date": ISODate("2025-12-07T14:30:00Z"),
  "status": "delivered",
  "total_amount": 150.50,
  "items": [
    {
      "product_id": ObjectId("product_123"),  // â­ RÃ©fÃ©rence vers products
      "name": "Laptop",
      "quantity": 1,
      "price": 899.99
    },
    {
      "product_id": ObjectId("product_456"),
      "name": "Mouse",
      "quantity": 2,
      "price": 25.00
    }
  ],
  "shipping_address": {
    "street": "123 Rue de la Paix",
    "city": "Paris",
    "zipcode": "75001"
  }
}

// Collection "products"
{
  "_id": ObjectId("product_123"),
  "name": "Laptop Dell XPS 15",
  "category": "Electronics",
  "price": 899.99,
  "stock": 45,
  "description": "Powerful laptop for developers"
}</code></pre>

                    <p><strong>âœ… Avantages :</strong></p>
                    <ul>
                        <li><strong>Pas de duplication</strong> : Les donnÃ©es utilisateur n'existent qu'une fois.  Si Ahmed change d'email, une seule mise Ã  jour</li>
                        <li><strong>Pas de limite de taille</strong> : Un utilisateur peut avoir 10 000 commandes, aucun problÃ¨me</li>
                        <li><strong>AccÃ¨s flexible</strong> : Vous pouvez rÃ©cupÃ©rer seulement les commandes, ou seulement l'utilisateur</li>
                        <li><strong>Relation Many-to-Many</strong> : Facilite les relations complexes (un produit dans plusieurs commandes)</li>
                    </ul>

                    <p><strong>âŒ InconvÃ©nients :</strong></p>
                    <ul>
                        <li><strong>Plusieurs requÃªtes</strong> : Pour afficher une commande avec les infos utilisateur, vous devez faire 2 requÃªtes (ou utiliser $lookup)</li>
                        <li><strong>Pas de jointures natives rapides</strong> : $lookup existe mais est plus lent que les JOIN SQL</li>
                        <li><strong>CohÃ©rence</strong> : Pas de clÃ©s Ã©trangÃ¨res automatiques, vous devez gÃ©rer manuellement les rÃ©fÃ©rences</li>
                    </ul>
                </div>

                <div class="tip-box">
                    <h4>âœ… Utiliser Referencing quand :</h4>
                    <ul>
                        <li>Relation <strong>One-to-Many</strong> ou <strong>Many-to-Many</strong> (un utilisateur, beaucoup de commandes)</li>
                        <li>Les donnÃ©es sont <strong>volumineuses</strong> (risque de dÃ©passer 16 MB)</li>
                        <li>Les donnÃ©es sont souvent <strong>accÃ©dÃ©es sÃ©parÃ©ment</strong> (liste des utilisateurs sans leurs commandes)</li>
                        <li>Les donnÃ©es enfants ont un <strong>sens indÃ©pendant</strong> (une commande peut Ãªtre consultÃ©e sans l'utilisateur)</li>
                        <li>Vous voulez Ã©viter la <strong>duplication</strong> (mise Ã  jour en un seul endroit)</li>
                    </ul>
                </div>

                <h4>C. Approche Hybride (RecommandÃ© !  )</h4>

                <div class="concept-box">
                    <h4>ğŸ’¡ Le meilleur des deux mondes</h4>
                    <p>Dans la pratique, vous allez souvent <strong>combiner</strong> les deux approches : imbriquer certaines donnÃ©es, rÃ©fÃ©rencer d'autres.  C'est ce qu'on appelle l'<strong>approche hybride</strong>.</p>
                </div>

                <div class="example-box">
                    <h4>âœ… Exemple Hybride : Commande avec infos utilisateur dupliquÃ©es</h4>
<pre><code>// Collection "orders" - Approche HYBRIDE
{
  "_id": ObjectId("order_001"),
  
  // â­ RÃ©fÃ©rence vers l'utilisateur (pour accÃ¨s complet si besoin)
  "user_id": ObjectId("user_001"),
  
  // â­ MAIS aussi donnÃ©es utilisateur DUPLIQUÃ‰ES (snapshot au moment de la commande)
  "user_snapshot": {
    "name": "Ahmed",
    "email": "ahmed@example.com"
  },
  
  "order_date": ISODate("2025-12-07T14:30:00Z"),
  "status": "delivered",
  "total_amount": 150. 50,
  
  // â­ Items IMBRIQUÃ‰S (car toujours affichÃ©s avec la commande)
  "items": [
    {
      "product_id": ObjectId("product_123"),  // RÃ©fÃ©rence vers products
      "name": "Laptop",  // Nom dupliquÃ© (pour ne pas avoir Ã  chercher product Ã  chaque fois)
      "quantity": 1,
      "price": 899.99
    }
  ],
  
  // â­ Adresse de livraison IMBRIQUÃ‰E (snapshot, mÃªme si l'utilisateur dÃ©mÃ©nage)
  "shipping_address": {
    "street": "123 Rue de la Paix",
    "city": "Paris",
    "zipcode": "75001"
  }
}</code></pre>

                    <p><strong>Pourquoi cette approche est intelligente :</strong></p>
                    <ul>
                        <li><strong>user_id</strong> : Permet de retrouver l'utilisateur complet si besoin (ex: pour le service client)</li>
                        <li><strong>user_snapshot</strong> : DonnÃ©es figÃ©es au moment de la commande.  MÃªme si Ahmed change d'email, la commande garde l'ancien email (important pour l'historique)</li>
                        <li><strong>product_id</strong> : RÃ©fÃ©rence vers le produit complet (stock, description... )</li>
                        <li><strong>name dupliquÃ©</strong> : Pour afficher la liste des commandes sans interroger la collection products Ã  chaque fois</li>
                        <li><strong>shipping_address</strong> : Snapshot de l'adresse au moment de la commande (important si l'utilisateur dÃ©mÃ©nage)</li>
                    </ul>
                </div>

                <div class="visual-box">
                    <h4 style="color: #667eea;">Arbre de DÃ©cision : Embedding vs Referencing</h4>
<pre style="background: #f5f5f5; color: #333; padding: 20px; border-radius: 8px; text-align: left;">
Posez-vous ces questions :

1. Les donnÃ©es sont-elles TOUJOURS accÃ©dÃ©es ensemble ? 
   OUI â†’ Penchez pour Embedding
   NON â†’ Penchez pour Referencing

2. La relation est One-to-Few (< 100 Ã©lÃ©ments) ? 
   OUI â†’ Embedding possible
   NON â†’ Referencing obligatoire (limite 16 MB)

3. Les donnÃ©es changent souvent ? 
   OUI â†’ Referencing (Ã©vite duplication)
   NON â†’ Embedding possible

4. Avez-vous besoin d'intÃ©gritÃ© rÃ©fÃ©rentielle stricte ?
   OUI â†’ Referencing + validation applicative
   NON â†’ Embedding plus simple

5. Performance critique en lecture ?
   OUI â†’ Embedding (une seule requÃªte)
   NON â†’ Referencing acceptable

RÃ©sultat :
- Cas typiques Embedding : Articles + Commentaires, Commande + Items
- Cas typiques Referencing : Users + Orders, Products + Categories
- Hybride : Orders avec user_snapshot + user_id
</pre>
                </div>

            </div>

            <!-- ============================================ -->
            <!-- PARTIE 3 : POLYGLOT PERSISTENCE & JTA -->
            <!-- ============================================ -->
            <div id="partie3" class="section">
                <h2>3ï¸âƒ£ Polyglot Persistence & Transactions DistribuÃ©es</h2>

                <div class="intro-box">
                    <h3>ğŸŒ Qu'est-ce que Polyglot Persistence ?</h3>
                    <p><strong>Polyglot Persistence</strong> signifie littÃ©ralement "Persistance Polyglotte" (plusieurs langues). En informatique, Ã§a veut dire : <strong>utiliser plusieurs types de bases de donnÃ©es dans une mÃªme application</strong>, chacune pour ce qu'elle fait de mieux.</p>

                    <p><strong>Analogie</strong> : Imaginez une boÃ®te Ã  outils :</p>
                    <ul>
                        <li>Un <strong>marteau</strong> pour planter des clous (SQL pour transactions)</li>
                        <li>Un <strong>tournevis</strong> pour visser (NoSQL pour documents flexibles)</li>
                        <li>Une <strong>scie</strong> pour couper (Cache pour vitesse)</li>
                    </ul>
                    <p>Vous n'utilisez pas le marteau pour tout !  Chaque outil a son usage optimal.</p>

                    <p><strong>Dans une application JEE moderne :</strong></p>
                    <ul>
                        <li><strong>PostgreSQL (SQL)</strong> : DonnÃ©es transactionnelles critiques (users, orders, payments) â†’ ACID, intÃ©gritÃ©</li>
                        <li><strong>MongoDB (NoSQL Document)</strong> : Logs, analytics, catalogues produits â†’ FlexibilitÃ©, volume</li>
                        <li><strong>Redis (NoSQL ClÃ©-Valeur)</strong> : Cache, sessions utilisateur â†’ Vitesse extrÃªme</li>
                        <li><strong>Elasticsearch</strong> : Recherche full-text â†’ Recherche puissante</li>
                    </ul>
                </div>

                <div class="visual-box">
                    <h4 style="color: #667eea;">Architecture Polyglot Persistence Typique</h4>
<pre style="background: #f5f5f5; color: #333; padding: 20px; border-radius: 8px;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   APPLICATION JEE                               â”‚
â”‚           (Servlets, EJB, Services, Controllers)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚                â”‚                â”‚
         â–¼                â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL   â”‚  â”‚   MongoDB    â”‚  â”‚    Redis     â”‚  â”‚Elasticsearch â”‚
â”‚   (JPA)      â”‚  â”‚ (Java Driver)â”‚  â”‚   (Jedis)    â”‚  â”‚  (REST API)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                â”‚                â”‚                â”‚
â”‚ Tables:        â”‚ Collections:   â”‚ Keys:          â”‚ Indexes:
â”‚ - users        â”‚ - logs         â”‚ - session:*    â”‚ - products
â”‚ - orders       â”‚ - analytics    â”‚ - cache:*      â”‚ - articles
â”‚ - payments     â”‚ - events       â”‚                â”‚
â”‚ - products     â”‚                â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Cas d'usage par technologie :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PostgreSQL : 
  âœ“ DonnÃ©es structurÃ©es, transactions ACID
  âœ“ Relations complexes (FK, JOIN)
  âœ“ IntÃ©gritÃ© rÃ©fÃ©rentielle critique
  Ex: users, orders, invoices, payments

MongoDB :
  âœ“ DonnÃ©es semi-structurÃ©es, schÃ©ma flexible
  âœ“ Gros volumes, lecture intensive
  âœ“ Analytics, time-series
  Ex: logs applicatifs, Ã©vÃ©nements, metrics, catalogues

Redis :
  âœ“ Cache ultra-rapide (mÃ©moire)
  âœ“ Sessions utilisateur
  âœ“ Compteurs temps rÃ©el
  Ex: cache pages, session tokens, rate limiting

Elasticsearch :
  âœ“ Recherche full-text
  âœ“ Autocomplete, suggestions
  âœ“ Analytics de logs
  Ex: search bar, product search, log analysis
</pre>
                </div>

                <h3>3. 1 Pourquoi Polyglot Persistence ?</h3>

                <div class="explanation">
                    <h4>ğŸ“– Avantages</h4>
                    <ul>
                        <li><strong>Performance optimale</strong> : Chaque base fait ce qu'elle fait de mieux
                            <ul>
                                <li>PostgreSQL excelle en transactions complexes avec JOIN</li>
                                <li>MongoDB excelle en lectures massives de documents</li>
                                <li>Redis excelle en vitesse brute (toutes les donnÃ©es en RAM)</li>
                            </ul>
                        </li>
                        <li><strong>ScalabilitÃ© ciblÃ©e</strong> : Vous pouvez scaler chaque base indÃ©pendamment
                            <ul>
                                <li>Si vos logs explosent â†’ Scaler seulement MongoDB</li>
                                <li>Si votre cache est surchargÃ© â†’ Ajouter des instances Redis</li>
                            </ul>
                        </li>
                        <li><strong>FlexibilitÃ©</strong> : Choisir la bonne structure pour chaque besoin
                            <ul>
                                <li>SchÃ©ma rigide pour les commandes (SQL)</li>
                                <li>SchÃ©ma flexible pour les logs (NoSQL)</li>
                            </ul>
                        </li>
                        <li><strong>RÃ©silience</strong> : Si une base tombe, les autres continuent de fonctionner (avec dÃ©gradation gracieuse)</li>
                    </ul>
                </div>

                <div class="warning-box">
                    <h4>âš ï¸ InconvÃ©nients et DÃ©fis</h4>
                    <ul>
                        <li><strong>ComplexitÃ©</strong> : GÃ©rer plusieurs bases = plusieurs connexions, configurations, sauvegardes... </li>
                        <li><strong>CohÃ©rence des donnÃ©es</strong> : Comment garantir que PostgreSQL et MongoDB restent synchronisÃ©s ?</li>
                        <li><strong>Transactions distribuÃ©es</strong> : Si une opÃ©ration doit toucher deux bases, comment garantir l'atomicitÃ© ?</li>
                        <li><strong>Courbe d'apprentissage</strong> : L'Ã©quipe doit maÃ®triser plusieurs technologies</li>
                        <li><strong>CoÃ»t opÃ©rationnel</strong> : Plus de serveurs, plus de monitoring, plus de maintenance</li>
                    </ul>
                </div>

                <h3>3.2 Le ProblÃ¨me de la CohÃ©rence</h3>

                <div class="warning-box">
                    <h4>ğŸ”¥ ScÃ©nario ProblÃ©matique</h4>
                    <p>Imaginez cette sÃ©quence d'opÃ©rations dans votre application e-commerce :</p>
                    <ol class="step-by-step">
                        <li><strong>CrÃ©er une commande en PostgreSQL</strong>
<pre><code>Order order = new Order(user, 150.00, "PENDING");
entityManager.persist(order);  // âœ… SuccÃ¨s : order_id = 123</code></pre>
                        </li>
                        <li><strong>Logger l'Ã©vÃ©nement en MongoDB</strong>
<pre><code>Document log = new Document("event", "ORDER_CREATED")
    .append("order_id", order.getId())
    .append("timestamp", new Date());
mongoCollection.insertOne(log);  // âŒ Ã‰CHEC : MongoDB est down !</code></pre>
                        </li>
                    </ol>

                    <p><strong>RÃ©sultat catastrophique :</strong></p>
                    <ul>
                        <li>âœ… La commande existe en PostgreSQL</li>
                        <li>âŒ Aucun log en MongoDB</li>
                        <li>ğŸ’¥ <strong>IncohÃ©rence</strong> : Votre systÃ¨me d'analytics ne voit pas la commande, les rapports sont faux, l'audit est incomplet</li>
                    </ul>

                    <p><strong>Autre scÃ©nario :</strong></p>
                    <p>L'insertion MongoDB rÃ©ussit, PUIS PostgreSQL plante. Maintenant vous avez un log pour une commande qui n'existe pas !</p>
                </div>

                <div class="concept-box">
                    <h4>ğŸ’¡ La Solution : Transactions DistribuÃ©es</h4>
                    <p>Une <strong>transaction distribuÃ©e</strong> est une transaction qui englobe plusieurs systÃ¨mes (bases de donnÃ©es, message queues.. .). Elle garantit que <strong>toutes les opÃ©rations rÃ©ussissent, ou aucune</strong> (principe du "tout ou rien").</p>

                    <p><strong>En Java/JEE, on utilise JTA (Java Transaction API)</strong> pour coordonner ces transactions.</p>
                </div>

                <h3>3.3 JTA : Java Transaction API</h3>

                <div class="explanation">
                    <h4>ğŸ“– Qu'est-ce que JTA ?</h4>
                    <p><strong>JTA</strong> est une API Java (incluse dans JEE) qui permet de gÃ©rer des transactions impliquant plusieurs ressources transactionnelles (bases de donnÃ©es, JMS queues...). </p>

                    <p><strong>Concepts clÃ©s :</strong></p>
                    <ul>
                        <li><strong>Transaction Manager</strong> : Coordonne la transaction distribuÃ©e (fourni par le serveur d'applications : WildFly, GlassFish... )</li>
                        <li><strong>XA Resource</strong> : Ressource qui supporte le protocole XA (PostgreSQL, Oracle...  MongoDB ne le supporte PAS nativement)</li>
                        <li><strong>Two-Phase Commit (2PC)</strong> : Protocole utilisÃ© par JTA pour garantir l'atomicitÃ©
                            <ul>
                                <li><strong>Phase 1 (Prepare)</strong> : Le Transaction Manager demande Ã  chaque ressource "Es-tu prÃªte Ã  commiter ?"</li>
                                <li><strong>Phase 2 (Commit/Rollback)</strong> : Si toutes disent OUI â†’ COMMIT partout.  Si une dit NON â†’ ROLLBACK partout</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div class="visual-box">
                    <h4 style="color: #667eea;">Two-Phase Commit (2PC) - SchÃ©ma</h4>
<pre style="background: #f5f5f5; color: #333; padding: 20px; border-radius: 8px;">
Application demande une transaction distribuÃ©e
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Transaction Manager (JTA)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚
           â†“                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚PostgreSQL  â”‚        â”‚  MongoDB   â”‚
    â”‚ XA Resourceâ”‚        â”‚(pas XA)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PHASE 1 : PREPARE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Transaction Manager â†’ PostgreSQL : "PrÃªt Ã  commiter ?"
PostgreSQL : "OUI" (prÃ©pare, verrouille, mais ne commit pas encore)

Transaction Manager â†’ MongoDB : "PrÃªt Ã  commiter ?"
MongoDB : "Je ne supporte pas XA" âŒ

PHASE 2 : ROLLBACK (car MongoDB ne peut pas participer)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Transaction Manager â†’ PostgreSQL : "ROLLBACK !"
PostgreSQL : Annule tout

RÃ©sultat : AUCUNE modification n'est commitÃ©e
           CohÃ©rence prÃ©servÃ©e ! 

Si MongoDB supportait XA et rÃ©pondait OUI :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PHASE 2 : COMMIT
Transaction Manager â†’ PostgreSQL : "COMMIT !"
Transaction Manager â†’ MongoDB : "COMMIT !"
Les deux commitent en mÃªme temps

RÃ©sultat : Modifications atomiques sur les deux bases
</pre>
                </div>

                <h4>A.  Utiliser JTA avec EJB</h4>

                <div class="explanation">
                    <h4>ğŸ“– Comment activer JTA ? </h4>
                    <p>Dans un serveur d'applications JEE (WildFly, GlassFish, WebLogic...), JTA est dÃ©jÃ  configurÃ©.  Vous devez juste :</p>
                    <ol>
                        <li>Utiliser des <strong>EJB</strong> (Session Beans) pour votre logique mÃ©tier</li>
                        <li>Annoter avec <strong>@TransactionAttribute</strong></li>
                        <li>Configurer vos DataSources en mode <strong>JTA</strong> dans persistence.xml</li>
                    </ol>
                </div>

<pre><code>/**
 * Service qui crÃ©e une commande en PostgreSQL ET un log en MongoDB
 * de maniÃ¨re transactionnelle (tout ou rien)
 */
@Stateless  // â­ EJB : gÃ¨re automatiquement les transactions JTA
public class OrderService {
    
    // â­ EntityManager JPA (PostgreSQL) gÃ©rÃ© par JTA
    @PersistenceContext(unitName = "PostgresPU")
    private EntityManager postgresEM;
    
    // â­ DAO MongoDB (injectÃ© via CDI)
    @Inject
    private LogDAO logDAO;
    
    /**
     * CrÃ©e une commande avec transaction JTA
     * Si MongoDB Ã©choue, PostgreSQL fait automatiquement un rollback
     */
    @TransactionAttribute(TransactionAttributeType.REQUIRED)
    public Order createOrderWithLog(Long userId, BigDecimal amount) {
        
        // Ã‰tape 1 : CrÃ©er la commande en PostgreSQL
        User user = postgresEM.find(User.class, userId);
        if (user == null) {
            throw new IllegalArgumentException("User not found");
        }
        
        Order order = new Order();
        order.setUser(user);
        order.setTotalAmount(amount);
        order.setOrderDate(LocalDateTime.now());
        order.setStatus(OrderStatus.PENDING);
        
        postgresEM.persist(order);  // INSERT dans PostgreSQL
        postgresEM.flush();  // Force l'exÃ©cution immÃ©diate (pour avoir l'ID)
        
        System.out.println("âœ… Commande crÃ©Ã©e en PostgreSQL : ID " + order.getId());
        
        // Ã‰tape 2 : Logger l'Ã©vÃ©nement en MongoDB
        try {
            logDAO.logOrderCreation(order. getId(), user.getEmail(), amount);
            System.out.println("âœ… Log crÃ©Ã© en MongoDB");
            
        } catch (Exception e) {
            System.err.println("âŒ Ã‰chec du log MongoDB : " + e.getMessage());
            // â­ Lancer une exception pour dÃ©clencher le rollback JTA
            throw new EJBException("Failed to log order creation", e);
        }
        
        // Si on arrive ici sans exception, JTA va commiter PostgreSQL ET MongoDB
        return order;
    }
    
    /**
     * Exemple avec gestion manuelle de UserTransaction
     * (si vous n'utilisez pas EJB)
     */
    @Resource
    private UserTransaction userTransaction;
    
    public void createOrderManualTransaction(Long userId, BigDecimal amount) throws Exception {
        try {
            // DÃ©marrer la transaction manuellement
            userTransaction.begin();
            
            // OpÃ©rations PostgreSQL
            Order order = new Order();
            // ... 
            postgresEM.persist(order);
            
            // OpÃ©rations MongoDB
            logDAO.logOrderCreation(order.getId(), "", amount);
            
            // Commiter
            userTransaction.commit();
            System.out.println("âœ… Transaction commitÃ©e");
            
        } catch (Exception e) {
            // Rollback en cas d'erreur
            try {
                userTransaction.rollback();
                System.err.println("âš ï¸ Transaction rollback");
            } catch (Exception rollbackEx) {
                System. err.println("âŒ Erreur lors du rollback : " + rollbackEx. getMessage());
            }
            throw e;
        }
    }
}</code></pre>

                <div class="code-explanation">
                    <h5>ğŸ“ Explications dÃ©taillÃ©es</h5>
                    <ul>
                        <li><strong>@Stateless</strong> : DÃ©clare un EJB Session Bean.  Le conteneur JEE gÃ¨re automatiquement les transactions JTA</li>
                        <li><strong>@TransactionAttribute(REQUIRED)</strong> : 
                            <ul>
                                <li>Si une transaction existe dÃ©jÃ  â†’ S'y joindre</li>
                                <li>Sinon â†’ CrÃ©er une nouvelle transaction</li>
                                <li>Autres valeurs : REQUIRES_NEW (toujours crÃ©er une nouvelle), MANDATORY (transaction obligatoire), NOT_SUPPORTED (suspend la transaction)...  </li>
                            </ul>
                        </li>
                        <li><strong>@PersistenceContext</strong> : Injecte un EntityManager gÃ©rÃ© par JTA</li>
                        <li><strong>postgresEM. flush()</strong> : Force l'exÃ©cution immÃ©diate des requÃªtes SQL (pour avoir l'ID de la commande avant de logger)</li>
                        <li><strong>throw new EJBException()</strong> : DÃ©clenche le rollback de la transaction JTA.  Toutes les modifications (PostgreSQL ET MongoDB si supportÃ©) sont annulÃ©es</li>
                    </ul>
                </div>

                <div class="warning-box">
                    <h4>âš ï¸ MongoDB ne supporte PAS nativement XA/JTA !</h4>
                    <p><strong>ProblÃ¨me majeur</strong> : MongoDB n'implÃ©mente pas le protocole XA Two-Phase Commit.  Donc mÃªme si vous utilisez JTA, MongoDB ne participera PAS vraiment Ã  la transaction distribuÃ©e.</p>

                    <p><strong>ConsÃ©quences :</strong></p>
                    <ul>
                        <li>Si PostgreSQL commit et MongoDB Ã©choue â†’ PostgreSQL ne fait PAS automatiquement de rollback</li>
                        <li>Vous devez gÃ©rer manuellement la cohÃ©rence</li>
                    </ul>

                    <p><strong>Solutions :</strong></p>
                    <ol>
                        <li><strong>Saga Pattern</strong> (voir section suivante)</li>
                        <li><strong>Event Sourcing</strong> : Stocker tous les Ã©vÃ©nements, reconstruire l'Ã©tat</li>
                        <li><strong>CohÃ©rence Ã©ventuelle</strong> : Accepter un lÃ©ger dÃ©calage temporaire</li>
                        <li><strong>MongoDB Transactions</strong> (depuis v4.0) : Transactions ACID sur replica sets, mais pas XA</li>
                    </ul>
                </div>

                <h3>3.4 Saga Pattern : Alternative Ã  JTA</h3>

                <div class="concept-box">
                    <h4>ğŸ’¡ Qu'est-ce qu'une Saga ?</h4>
                    <p>Le <strong>Saga Pattern</strong> est un pattern pour gÃ©rer les transactions distribuÃ©es SANS utiliser Two-Phase Commit (qui ne marche pas avec MongoDB).  </p>

                    <p><strong>Principe :</strong></p>
                    <ul>
                        <li>DÃ©couper la transaction en plusieurs <strong>transactions locales</strong> (une par base de donnÃ©es)</li>
                        <li>Chaque transaction locale commit immÃ©diatement</li>
                        <li>Si une transaction Ã©choue, exÃ©cuter des <strong>transactions compensatoires</strong> pour annuler les prÃ©cÃ©dentes</li>
                    </ul>

                    <p><strong>Analogie :</strong> RÃ©server un voyage (vol + hÃ´tel + voiture)</p>
                    <ul>
                        <li>Ã‰tape 1 : RÃ©server le vol âœ…</li>
                        <li>Ã‰tape 2 : RÃ©server l'hÃ´tel âœ…</li>
                        <li>Ã‰tape 3 : RÃ©server la voiture âŒ Ã‰CHEC</li>
                        <li>Compensation : Annuler l'hÃ´tel, annuler le vol</li>
                    </ul>
                </div>

                <div class="visual-box">
                    <h4 style="color: #667eea;">Saga Pattern - Diagramme</h4>
<pre style="background: #f5f5f5; color: #333; padding: 20px; border-radius: 8px;">
CAS 1 : Tout rÃ©ussit
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PostgreSQL : INSERT order    [COMMIT] âœ…
MongoDB    : INSERT log      [COMMIT] âœ…
Redis      : SET cache       [COMMIT] âœ…

RÃ©sultat : SUCCESS, tout est cohÃ©rent


CAS 2 : MongoDB Ã©choue
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PostgreSQL : INSERT order    [COMMIT] âœ…
MongoDB    : INSERT log      [Ã‰CHEC] âŒ

âš ï¸ COMPENSATION nÃ©cessaire ! 

Compensation :
PostgreSQL : DELETE order    [COMMIT] âœ…

RÃ©sultat : Tout annulÃ©, cohÃ©rence prÃ©servÃ©e


CAS 3 : Compensation Ã©choue (pire cas)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PostgreSQL : INSERT order    [COMMIT] âœ…
MongoDB    : INSERT log      [Ã‰CHEC] âŒ
Compensation:
PostgreSQL : DELETE order    [Ã‰CHEC] âŒâŒ

RÃ©sultat : INCOHÃ‰RENCE ! 
Solution : 
  - Retry automatique de la compensation
  - Logger l'incident pour intervention manuelle
  - Processus de rÃ©conciliation asynchrone
</pre>
                </div>

<pre><code>/**
 * ImplÃ©mentation du Saga Pattern pour crÃ©er une commande
 */
@Stateless
public class OrderSagaService {
    
    @PersistenceContext(unitName = "PostgresPU")
    private EntityManager postgresEM;
    
    @Inject
    private LogDAO logDAO;
    
    @Inject
    private CacheService cacheService;
    
    /**
     * CrÃ©e une commande avec Saga Pattern
     * GÃ¨re manuellement les compensations en cas d'Ã©chec
     */
    public Order createOrderWithSaga(Long userId, BigDecimal amount) throws Exception {
        
        // Variables pour tracker les Ã©tapes rÃ©ussies
        boolean step1Success = false;  // PostgreSQL
        boolean step2Success = false;  // MongoDB
        boolean step3Success = false;  // Redis
        
        Order order = null;
        
        try {
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Ã‰TAPE 1 : CrÃ©er la commande en PostgreSQL
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            System.out.println("ğŸ”¹ SAGA Step 1 : CrÃ©ation commande PostgreSQL");
            
            postgresEM.getTransaction().begin();
            
            User user = postgresEM.find(User.class, userId);
            if (user == null) {
                throw new IllegalArgumentException("User not found");
            }
            
            order = new Order();
            order.setUser(user);
            order.setTotalAmount(amount);
            order.setOrderDate(LocalDateTime.now());
            order.setStatus(OrderStatus.PENDING);
            
            postgresEM.persist(order);
            postgresEM.getTransaction().commit();
            
            step1Success = true;  // âœ… Marquer l'Ã©tape comme rÃ©ussie
            System.out.println("âœ… SAGA Step 1 : Commande crÃ©Ã©e (ID: " + order.getId() + ")");
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Ã‰TAPE 2 : Logger en MongoDB
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            System. out.println("ğŸ”¹ SAGA Step 2 : Log MongoDB");
            
            logDAO.logOrderCreation(order.getId(), user.getEmail(), amount);
            
            step2Success = true;  // âœ…
            System.out.println("âœ… SAGA Step 2 : Log crÃ©Ã©");
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Ã‰TAPE 3 : Mettre en cache (Redis)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            System.out.println("ğŸ”¹ SAGA Step 3 : Cache Redis");
            
            cacheService.cacheOrder(order);
            
            step3Success = true;  // âœ…
            System.out.println("âœ… SAGA Step 3 : Cache mis Ã  jour");
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // SUCCESS : Toutes les Ã©tapes ont rÃ©ussi ! 
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            System.out.println("ğŸ‰ SAGA SUCCESS : Commande crÃ©Ã©e avec succÃ¨s");
            return order;
            
        } catch (Exception e) {
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Ã‰CHEC : ExÃ©cuter les compensations
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            System. err.println("âŒ SAGA FAILED : " + e.getMessage());
            System.err.println("âš ï¸ ExÃ©cution des compensations.. .");
            
            // Compensation Step 3 : Retirer du cache
            if (step3Success) {
                try {
                    System.out.println("ğŸ”„ Compensation Step 3 : Retrait du cache");
                    cacheService.removeOrder(order.getId());
                    System.out.println("âœ… Compensation Step 3 : OK");
                } catch (Exception compEx) {
                    System.err.println("âŒ Compensation Step 3 FAILED : " + compEx.getMessage());
                    // Logger pour intervention manuelle
                    logCompensationFailure("cache", order.getId(), compEx);
                }
            }
            
            // Compensation Step 2 : Supprimer le log MongoDB
            if (step2Success) {
                try {
                    System.out.println("ğŸ”„ Compensation Step 2 : Suppression log MongoDB");
                    logDAO. deleteLog(order.getId());
                    System.out.println("âœ… Compensation Step 2 : OK");
                } catch (Exception compEx) {
                    System.err.println("âŒ Compensation Step 2 FAILED : " + compEx.getMessage());
                    logCompensationFailure("mongodb", order.getId(), compEx);
                }
            }
            
            // Compensation Step 1 : Supprimer la commande PostgreSQL
            if (step1Success && order != null) {
                try {
                    System.out.println("ğŸ”„ Compensation Step 1 : Suppression commande PostgreSQL");
                    
                    postgresEM.getTransaction().begin();
                    Order orderToDelete = postgresEM.find(Order.class, order.getId());
                    if (orderToDelete != null) {
                        postgresEM.remove(orderToDelete);
                    }
                    postgresEM. getTransaction().commit();
                    
                    System.out.println("âœ… Compensation Step 1 : OK");
                } catch (Exception compEx) {
                    System.err.println("âŒ Compensation Step 1 FAILED : " + compEx.getMessage());
                    logCompensationFailure("postgresql", order.getId(), compEx);
                    
                    // âš ï¸ Si la compensation PostgreSQL Ã©choue, c'est critique ! 
                    // Il faut une intervention manuelle ou un processus de rÃ©conciliation
                }
            }
            
            System.err.println("âš ï¸ SAGA compensations terminÃ©es");
            throw new RuntimeException("Order creation failed, compensations executed", e);
        }    }
    
        /**
         * Logger les Ã©checs de compensation pour intervention manuelle
         */
        private void logCompensationFailure(String system, Long orderId, Exception ex) {
            // En production, ceci devrait :
            // 1. Logger dans un systÃ¨me de monitoring (Splunk, ELK, etc.)
            // 2.  Envoyer une alerte (email, Slack, PagerDuty)
            // 3. Stocker dans une table "failed_compensations" pour traitement manuel
            
            System.err.println("ğŸš¨ CRITICAL: Compensation failed for " + system + 
                             ", order_id=" + orderId + ", error=" + ex.getMessage());
            
            // Exemple : InsÃ©rer dans une table d'incidents
            try {
                Document incident = new Document()
                    .append("type", "COMPENSATION_FAILURE")
                    . append("system", system)
                    .append("order_id", orderId)
                    .append("error", ex. getMessage())
                    .append("timestamp", new Date())
                    .append("status", "PENDING_MANUAL_INTERVENTION");
                
                logDAO.logIncident(incident);
            } catch (Exception logEx) {
                // Si mÃªme le logging Ã©choue, au moins afficher dans les logs serveur
                System.err.println("Failed to log compensation failure: " + logEx.getMessage());
            }
        }
        
        /**
         * Processus de rÃ©conciliation asynchrone
         * Ã€ exÃ©cuter pÃ©riodiquement (ex: toutes les 5 minutes)
         * pour dÃ©tecter et corriger les incohÃ©rences
         */
        @Schedule(hour = "*", minute = "*/5")  // Toutes les 5 minutes
        public void reconciliationProcess() {
            System.out.println("ğŸ” DÃ©marrage du processus de rÃ©conciliation...");
            
            try {
                // 1. RÃ©cupÃ©rer les incidents en attente
                List<Document> pendingIncidents = logDAO. getPendingIncidents();
                
                for (Document incident : pendingIncidents) {
                    String system = incident.getString("system");
                    Long orderId = incident. getLong("order_id");
                    
                    System.out.println("ğŸ”„ Tentative de rÃ©solution : " + system + ", order=" + orderId);
                    
                    // Retry la compensation
                    boolean success = retryCompensation(system, orderId);
                    
                    if (success) {
                        // Marquer comme rÃ©solu
                        logDAO.markIncidentResolved(incident. getObjectId("_id"));
                        System. out.println("âœ… Incident rÃ©solu : " + orderId);
                    } else {
                        // IncrÃ©menter le compteur de retry
                        logDAO.incrementRetryCount(incident.getObjectId("_id"));
                        
                        // Si trop de retry, escalader
                        if (incident.getInteger("retry_count", 0) > 10) {
                            System.err.println("ğŸš¨ ESCALATION: Incident " + orderId + 
                                             " nÃ©cessite intervention manuelle");
                            // Envoyer alerte Ã  l'Ã©quipe ops
                        }
                    }
                }
                
            } catch (Exception e) {
                System.err. println("âŒ Erreur dans le processus de rÃ©conciliation: " + e.getMessage());
            }
        }
        
        private boolean retryCompensation(String system, Long orderId) {
            try {
                switch (system) {
                    case "postgresql":
                        postgresEM.getTransaction().begin();
                        Order order = postgresEM.find(Order.class, orderId);
                        if (order != null) {
                            postgresEM.remove(order);
                        }
                        postgresEM. getTransaction().commit();
                        return true;
                        
                    case "mongodb":
                        logDAO.deleteLog(orderId);
                        return true;
                        
                    case "cache":
                        cacheService. removeOrder(orderId);
                        return true;
                        
                    default:
                        return false;
                }
            } catch (Exception e) {
                System.err.println("Retry failed: " + e.getMessage());
                return false;
            }
        }
    }</code></pre>
    
                    <div class="code-explanation">
                        <h5>ğŸ“ Explications du Pattern Saga</h5>
                        <ul>
                            <li><strong>Ã‰tapes sÃ©quentielles</strong> : Chaque Ã©tape commit immÃ©diatement sa transaction locale</li>
                            <li><strong>Tracking d'Ã©tat</strong> : Variables boolÃ©ennes (step1Success, step2Success.. .) pour savoir quelles Ã©tapes ont rÃ©ussi</li>
                            <li><strong>Compensations en ordre inverse</strong> : On annule dans l'ordre inverse de l'exÃ©cution (Step 3 â†’ 2 â†’ 1)</li>
                            <li><strong>Gestion des Ã©checs de compensation</strong> : Si une compensation Ã©choue, on log pour intervention manuelle</li>
                            <li><strong>RÃ©conciliation asynchrone</strong> : Processus pÃ©riodique qui retry les compensations Ã©chouÃ©es</li>
                        </ul>
                    </div>
    
                    <div class="tip-box">
                        <h4>ğŸ’¡ Bonnes Pratiques Saga Pattern</h4>
                        <ul>
                            <li><strong>Idempotence</strong> : Les opÃ©rations (et compensations) doivent Ãªtre idempotentes (exÃ©cutables plusieurs fois avec le mÃªme rÃ©sultat)</li>
                            <li><strong>Monitoring</strong> : Logger chaque Ã©tape et compensation pour traÃ§abilitÃ©</li>
                            <li><strong>Timeout</strong> : DÃ©finir des timeouts pour Ã©viter de bloquer indÃ©finiment</li>
                            <li><strong>Statut intermÃ©diaires</strong> : Utiliser des statuts comme "PENDING_COMPENSATION" pour identifier les transactions en cours</li>
                            <li><strong>Process asynchrone</strong> : Pour les cas non critiques, utiliser des message queues (RabbitMQ, Kafka) pour les compensations</li>
                            <li><strong>Documentation</strong> : Documenter clairement la sÃ©quence d'opÃ©rations et les compensations</li>
                        </ul>
                    </div>
    
                    <div class="comparison-table">
                        <h4 style="margin-bottom: 20px; color: #667eea;">JTA vs Saga : Comparaison</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>CritÃ¨re</th>
                                    <th>JTA (Two-Phase Commit)</th>
                                    <th>Saga Pattern</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>AtomicitÃ©</strong></td>
                                    <td>Garantie stricte (tout ou rien)</td>
                                    <td>CohÃ©rence Ã©ventuelle (avec compensations)</td>
                                </tr>
                                <tr>
                                    <td><strong>Support</strong></td>
                                    <td>NÃ©cessite XA (PostgreSQL, Oracle... )</td>
                                    <td>Fonctionne avec TOUTES les bases</td>
                                </tr>
                                <tr>
                                    <td><strong>ComplexitÃ©</strong></td>
                                    <td>Simple (gÃ©rÃ© par le serveur JEE)</td>
                                    <td>Complexe (code manuel de compensation)</td>
                                </tr>
                                <tr>
                                    <td><strong>Performance</strong></td>
                                    <td>Lente (verrouillages, 2 phases)</td>
                                    <td>Rapide (commits locaux immÃ©diats)</td>
                                </tr>
                                <tr>
                                    <td><strong>DisponibilitÃ©</strong></td>
                                    <td>Bloquante (attend toutes les ressources)</td>
                                    <td>Non-bloquante (Ã©chec gÃ©rÃ© asynchrone)</td>
                                </tr>
                                <tr>
                                    <td><strong>ScalabilitÃ©</strong></td>
                                    <td>LimitÃ©e (coordination centralisÃ©e)</td>
                                    <td>Excellente (pas de coordination globale)</td>
                                </tr>
                                <tr>
                                    <td><strong>CohÃ©rence</strong></td>
                                    <td>ImmÃ©diate</td>
                                    <td>Ã‰ventuelle (court dÃ©lai possible)</td>
                                </tr>
                                <tr>
                                    <td><strong>Cas d'usage</strong></td>
                                    <td>Transactions critiques (banque, paiement)</td>
                                    <td>Transactions volumineuses, microservices</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
    
                </div>
    
                <!-- ============================================ -->
                <!-- PARTIE 4 : ARCHITECTURE MVC & INTÃ‰GRATION -->
                <!-- ============================================ -->
                <div id="partie4" class="section">
                    <h2>4ï¸âƒ£ Architecture MVC & IntÃ©gration ComplÃ¨te</h2>
    
                    <div class="intro-box">
                        <h3>ğŸ—ï¸ Assembler tous les morceaux</h3>
                        <p>Jusqu'ici, nous avons vu des technologies isolÃ©es : JPA, MongoDB, JTA...  Mais dans une vraie application JEE, il faut <strong>architecturer proprement</strong> pour que tout fonctionne ensemble de maniÃ¨re maintenable.</p>
    
                        <p><strong>L'architecture MVC (Model-View-Controller)</strong> est le pattern standard pour organiser une application web.   Mais en JEE d'entreprise, on va plus loin avec une <strong>architecture en couches</strong> :</p>
                        <ul>
                            <li><strong>Presentation Layer</strong> : JSP, JSTL, HTML, CSS (ce que voit l'utilisateur)</li>
                            <li><strong>Controller Layer</strong> : Servlets (gÃ¨rent les requÃªtes HTTP)</li>
                            <li><strong>Service Layer</strong> : EJB (logique mÃ©tier, transactions)</li>
                            <li><strong>DAO Layer</strong> : Data Access Objects (accÃ¨s bases de donnÃ©es)</li>
                            <li><strong>Model Layer</strong> : EntitÃ©s JPA, POJOs (reprÃ©sentation des donnÃ©es)</li>
                            <li><strong>Persistence Layer</strong> : JPA, MongoDB, Redis (stockage physique)</li>
                        </ul>
                    </div>
    
                    <div class="architecture-diagram">
                        <h4 style="color: #667eea; margin-bottom: 20px;">Architecture ComplÃ¨te d'une Application JEE</h4>
                        <pre style="background: transparent; color: #333; text-align: left;">
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         BROWSER                                   â”‚
    â”‚  (Client web : Firefox, Chrome, Safari...)                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ HTTP Request (GET /orders? action=list)
                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   PRESENTATION LAYER                              â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  JSP + JSTL (orderList.jsp, orderDetail.jsp)              â”‚  â”‚
    â”‚  â”‚  â€¢ Affiche HTML                                             â”‚  â”‚
    â”‚  â”‚  â€¢ Boucles &lt;c:forEach&gt;, conditions &lt;c:if&gt;                 â”‚  â”‚
    â”‚  â”‚  â€¢ Formatage &lt;fmt:formatDate&gt;, &lt;fmt:formatNumber&gt;         â”‚  â”‚
    â”‚  â”‚  â€¢ AUCUNE logique mÃ©tier (juste prÃ©sentation)              â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ request.setAttribute("orders", list)
                               â”‚ forward to JSP
                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    CONTROLLER LAYER                               â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  SERVLETS (@WebServlet)                                     â”‚  â”‚
    â”‚  â”‚  â€¢ OrderServlet, UserServlet, ProductServlet...              â”‚  â”‚
    â”‚  â”‚  â€¢ ReÃ§oit requÃªtes HTTP (doGet, doPost)                     â”‚  â”‚
    â”‚  â”‚  â€¢ Parse paramÃ¨tres (req.getParameter("id"))               â”‚  â”‚
    â”‚  â”‚  â€¢ Appelle Service Layer                                    â”‚  â”‚
    â”‚  â”‚  â€¢ Choisit la vue (JSP) Ã  afficher                          â”‚  â”‚
    â”‚  â”‚  â€¢ GÃ¨re navigation (redirect, forward)                      â”‚  â”‚
    â”‚  â”‚  â€¢ PAS de logique mÃ©tier                                    â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ @EJB injection
                               â”‚ orderService. createOrder(...)
                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     SERVICE LAYER                                 â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  EJB (@Stateless)                                           â”‚  â”‚
    â”‚  â”‚  â€¢ OrderService, UserService, PaymentService...             â”‚  â”‚
    â”‚  â”‚  â€¢ LOGIQUE MÃ‰TIER (business logic)                          â”‚  â”‚
    â”‚  â”‚  â€¢ Validation des donnÃ©es                                   â”‚  â”‚
    â”‚  â”‚  â€¢ Orchestration (appelle plusieurs DAO)                    â”‚  â”‚
    â”‚  â”‚  â€¢ TRANSACTIONS (@TransactionAttribute)                     â”‚  â”‚
    â”‚  â”‚  â€¢ Gestion d'erreurs mÃ©tier                                 â”‚  â”‚
    â”‚  â”‚  â€¢ Logs applicatifs                                         â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ @EJB injection          â”‚ @Inject
                   â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       DAO LAYER           â”‚  â”‚       DAO LAYER                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ OrderDAO (JPA)     â”‚   â”‚  â”‚  â”‚ LogDAO (MongoDB)         â”‚  â”‚
    â”‚  â”‚ UserDAO (JPA)      â”‚   â”‚  â”‚  â”‚ AnalyticsDAO (MongoDB)   â”‚  â”‚
    â”‚  â”‚ ProductDAO (JPA)   â”‚   â”‚  â”‚  â”‚ EventDAO (MongoDB)       â”‚  â”‚
    â”‚  â”‚                    â”‚   â”‚  â”‚  â”‚                          â”‚  â”‚
    â”‚  â”‚ â€¢ CRUD operations  â”‚   â”‚  â”‚  â€¢ find(), insertOne()     â”‚  â”‚
    â”‚  â”‚ â€¢ JPQL queries     â”‚   â”‚  â”‚  â€¢ aggregate()             â”‚  â”‚
    â”‚  â”‚ â€¢ Criteria API     â”‚   â”‚  â”‚  â€¢ updateMany()            â”‚  â”‚
    â”‚  â”‚                    â”‚   â”‚  â”‚                          â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                                  â”‚
                â–¼                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   MODEL LAYER          â”‚        â”‚   (Documents MongoDB)      â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚                            â”‚
    â”‚  â”‚ JPA ENTITIES     â”‚  â”‚        â”‚                            â”‚
    â”‚  â”‚ â€¢ @Entity        â”‚  â”‚        â”‚                            â”‚
    â”‚  â”‚ â€¢ Order. java     â”‚  â”‚        â”‚                            â”‚
    â”‚  â”‚ â€¢ User. java      â”‚  â”‚        â”‚                            â”‚
    â”‚  â”‚ â€¢ Product.java   â”‚  â”‚        â”‚                            â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    PERSISTENCE LAYER                           â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
    â”‚  â”‚  EntityManager   â”‚        â”‚  MongoClient             â”‚     â”‚
    â”‚  â”‚  (JPA/Hibernate) â”‚        â”‚  (MongoDB Java Driver)   â”‚     â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                               â”‚
                â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   PostgreSQL DB     â”‚          â”‚      MongoDB DB          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ users         â”‚  â”‚          â”‚  â”‚ logs collection    â”‚  â”‚
    â”‚  â”‚ orders        â”‚  â”‚          â”‚  â”‚ analytics coll.     â”‚  â”‚
    â”‚  â”‚ products      â”‚  â”‚          â”‚  â”‚ events coll.       â”‚  â”‚
    â”‚  â”‚ payments      â”‚  â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        </pre>
                    </div>
    
                    <div class="explanation">
                        <h4>ğŸ“– ResponsabilitÃ©s de chaque couche</h4>
                        <ul>
                            <li><strong>Presentation (JSP)</strong> : 
                                <ul>
                                    <li>Affiche les donnÃ©es en HTML</li>
                                    <li>Utilise JSTL pour boucles, conditions, formatage</li>
                                    <li>ZÃ‰RO logique mÃ©tier</li>
                                    <li>ZÃ‰RO accÃ¨s base de donnÃ©es</li>
                                </ul>
                            </li>
                            <li><strong>Controller (Servlet)</strong> :
                                <ul>
                                    <li>Point d'entrÃ©e HTTP</li>
                                    <li>Parse les paramÃ¨tres de requÃªte</li>
                                    <li>DÃ©lÃ¨gue au Service Layer</li>
                                    <li>Choisit quelle vue afficher</li>
                                    <li>PAS de logique mÃ©tier</li>
                                    <li>PAS d'accÃ¨s direct Ã  la base</li>
                                </ul>
                            </li>
                            <li><strong>Service (EJB)</strong> :
                                <ul>
                                    <li>Contient TOUTE la logique mÃ©tier</li>
                                    <li>Valide les donnÃ©es</li>
                                    <li>Orchestre plusieurs DAO</li>
                                    <li>GÃ¨re les transactions</li>
                                    <li>Logs les Ã©vÃ©nements importants</li>
                                </ul>
                            </li>
                            <li><strong>DAO</strong> :
                                <ul>
                                    <li>UNIQUEMENT accÃ¨s base de donnÃ©es</li>
                                    <li>OpÃ©rations CRUD (Create, Read, Update, Delete)</li>
                                    <li>RequÃªtes complexes</li>
                                    <li>Pas de logique mÃ©tier</li>
                                </ul>
                            </li>
                            <li><strong>Model (EntitÃ©s)</strong> :
                                <ul>
                                    <li>ReprÃ©sentation Java des donnÃ©es</li>
                                    <li>Annotations JPA (@Entity, @Column... )</li>
                                    <li>Getters/Setters</li>
                                    <li>Pas de logique (sauf validation basique)</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
    
                    <div class="tip-box">
                        <h4>ğŸ’¡ Pourquoi sÃ©parer en couches ?</h4>
                        <ul>
                            <li><strong>MaintenabilitÃ©</strong> : Si vous devez changer l'UI, seule la couche Presentation change</li>
                            <li><strong>TestabilitÃ©</strong> : Vous pouvez tester le Service Layer sans serveur web</li>
                            <li><strong>RÃ©utilisabilitÃ©</strong> : Le mÃªme Service peut Ãªtre appelÃ© par un Servlet ET par une API REST</li>
                            <li><strong>Ã‰volutivitÃ©</strong> : Facile d'ajouter de nouvelles fonctionnalitÃ©s</li>
                            <li><strong>Travail en Ã©quipe</strong> : Plusieurs dÃ©veloppeurs peuvent travailler sur diffÃ©rentes couches simultanÃ©ment</li>
                        </ul>
                    </div>
    
                    <h3>4. 1 Structure ComplÃ¨te du Projet</h3>
    
    <pre><code>my-polyglot-jee-app/
    â”‚
    â”œâ”€â”€ pom.xml  (Maven configuration)
    â”‚
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ main/
    â”‚   â”‚   â”œâ”€â”€ java/
    â”‚   â”‚   â”‚   â””â”€â”€ com/
    â”‚   â”‚   â”‚       â””â”€â”€ example/
    â”‚   â”‚   â”‚           â”‚
    â”‚   â”‚   â”‚           â”œâ”€â”€ entity/  (MODEL LAYER - JPA Entities)
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ User.java
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ Order.java
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ Product.java
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ Payment.java
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ CreditCardPayment.java
    â”‚   â”‚   â”‚           â”‚   â””â”€â”€ OrderStatus.java (enum)
    â”‚   â”‚   â”‚           â”‚
    â”‚   â”‚   â”‚           â”œâ”€â”€ dao/  (DAO LAYER)
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ UserDAO.java  (JPA)
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ OrderDAO.java  (JPA)
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ ProductDAO.java  (JPA)
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ LogDAO.java  (MongoDB)
    â”‚   â”‚   â”‚           â”‚   â””â”€â”€ AnalyticsDAO.java  (MongoDB)
    â”‚   â”‚   â”‚           â”‚
    â”‚   â”‚   â”‚           â”œâ”€â”€ service/  (SERVICE LAYER - EJB)
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ OrderService.java
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ UserService.java
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ ProductService.java
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ PaymentService.java
    â”‚   â”‚   â”‚           â”‚   â””â”€â”€ AnalyticsService.java
    â”‚   â”‚   â”‚           â”‚
    â”‚   â”‚   â”‚           â”œâ”€â”€ controller/  (CONTROLLER LAYER - Servlets)
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ OrderServlet.java
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ UserServlet.java
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ ProductServlet.java
    â”‚   â”‚   â”‚           â”‚   â””â”€â”€ DashboardServlet.java
    â”‚   â”‚   â”‚           â”‚
    â”‚   â”‚   â”‚           â”œâ”€â”€ dto/  (Data Transfer Objects)
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ OrderDTO.java
    â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ UserDTO.java
    â”‚   â”‚   â”‚           â”‚   â””â”€â”€ DashboardStats.java
    â”‚   â”‚   â”‚           â”‚
    â”‚   â”‚   â”‚           â””â”€â”€ util/  (Utilitaires)
    â”‚   â”‚   â”‚               â”œâ”€â”€ MongoDBConnection.java
    â”‚   â”‚   â”‚               â”œâ”€â”€ DateUtils.java
    â”‚   â”‚   â”‚               â””â”€â”€ ValidationUtils.java
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ resources/
    â”‚   â”‚   â”‚   â”œâ”€â”€ META-INF/
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ persistence. xml  (Configuration JPA)
    â”‚   â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   â””â”€â”€ ehcache.xml  (Configuration cache)
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€ webapp/
    â”‚   â”‚       â”œâ”€â”€ WEB-INF/
    â”‚   â”‚       â”‚   â”œâ”€â”€ web.xml  (Configuration Servlet)
    â”‚   â”‚       â”‚   â”‚
    â”‚   â”‚       â”‚   â””â”€â”€ views/  (PRESENTATION LAYER - JSP)
    â”‚   â”‚       â”‚       â”œâ”€â”€ orderList.jsp
    â”‚   â”‚       â”‚       â”œâ”€â”€ orderDetail.jsp
    â”‚   â”‚       â”‚       â”œâ”€â”€ orderForm.jsp
    â”‚   â”‚       â”‚       â”œâ”€â”€ userList.jsp
    â”‚   â”‚       â”‚       â”œâ”€â”€ dashboard.jsp
    â”‚   â”‚       â”‚       â””â”€â”€ error.jsp
    â”‚   â”‚       â”‚
    â”‚   â”‚       â”œâ”€â”€ css/
    â”‚   â”‚       â”‚   â””â”€â”€ style.css
    â”‚   â”‚       â”‚
    â”‚   â”‚       â”œâ”€â”€ js/
    â”‚   â”‚       â”‚   â””â”€â”€ app.js
    â”‚   â”‚       â”‚
    â”‚   â”‚       â””â”€â”€ index.jsp  (Page d'accueil)
    â”‚   â”‚
    â”‚   â””â”€â”€ test/
    â”‚       â””â”€â”€ java/
    â”‚           â””â”€â”€ com/
    â”‚               â””â”€â”€ example/
    â”‚                   â”œâ”€â”€ service/
    â”‚                   â”‚   â”œâ”€â”€ OrderServiceTest.java
    â”‚                   â”‚   â””â”€â”€ UserServiceTest.java
    â”‚                   â”‚
    â”‚                   â””â”€â”€ dao/
    â”‚                       â”œâ”€â”€ OrderDAOTest.java
    â”‚                       â””â”€â”€ LogDAOTest.java
    â”‚
    â””â”€â”€ README.md</code></pre>
    
                    <div class="note">
                        <p><strong>Note importante :</strong> Cette structure est un <strong>standard de l'industrie</strong>. Respecter cette organisation permet Ã  n'importe quel dÃ©veloppeur JEE de comprendre rapidement votre projet. </p>
                    </div>
    
                    <h3>4.2 ImplÃ©mentation ComplÃ¨te : Exemple Order Management</h3>
    
                    <p style="margin-top: 20px; font-size: 1.1em; color: #667eea; font-weight: 600;">Nous allons maintenant voir l'implÃ©mentation complÃ¨te d'une fonctionnalitÃ© "Gestion des Commandes" Ã  travers toutes les couches. </p>
    
                    <h4>Couche 1 : Model (EntitÃ© JPA)</h4>
    
    <pre><code>package com.example.entity;
    
    import javax.persistence.*;
    import java.math.BigDecimal;
    import java.time.LocalDateTime;
    import java.util.ArrayList;
    import java.util.List;
    
    /**
     * EntitÃ© reprÃ©sentant une commande
     * StockÃ©e en PostgreSQL
     */
    @Entity
    @Table(name = "orders")
    @Cacheable
    @Cache(usage = CacheConcurrencyStrategy.READ_WRITE)
    public class Order {
        
        @Id
        @GeneratedValue(strategy = GenerationType. IDENTITY)
        private Long id;
        
        // Relation Many-to-One : Plusieurs commandes pour un utilisateur
        @ManyToOne(fetch = FetchType.LAZY, optional = false)
        @JoinColumn(name = "user_id", nullable = false)
        private User user;
        
        @Column(name = "order_date", nullable = false)
        private LocalDateTime orderDate;
        
        @Column(name = "total_amount", nullable = false, precision = 10, scale = 2)
        private BigDecimal totalAmount;
        
        @Enumerated(EnumType.STRING)
        @Column(name = "status", nullable = false, length = 20)
        private OrderStatus status;
        
        @Column(name = "shipping_address", length = 500)
        private String shippingAddress;
        
        @Column(name = "notes", length = 1000)
        private String notes;
        
        // Relation One-to-Many : Une commande a plusieurs items
        @OneToMany(mappedBy = "order", cascade = CascadeType.ALL, orphanRemoval = true)
        private List<OrderItem> items = new ArrayList<>();
        
        // Constructeurs
        public Order() {
            this.orderDate = LocalDateTime.now();
            this. status = OrderStatus.PENDING;
        }
        
        public Order(User user, BigDecimal totalAmount) {
            this();
            this.user = user;
            this.totalAmount = totalAmount;
        }
        
        // MÃ©thodes helper
        public void addItem(OrderItem item) {
            items. add(item);
            item. setOrder(this);
        }
        
        public void removeItem(OrderItem item) {
            items.remove(item);
            item.setOrder(null);
        }
        
        // Getters et Setters
        public Long getId() {
            return id;
        }
        
        public void setId(Long id) {
            this.id = id;
        }
        
        public User getUser() {
            return user;
        }
        
        public void setUser(User user) {
            this.user = user;
        }
        
        public LocalDateTime getOrderDate() {
            return orderDate;
        }
        
        public void setOrderDate(LocalDateTime orderDate) {
            this.orderDate = orderDate;
        }
        
        public BigDecimal getTotalAmount() {
            return totalAmount;
        }
        
        public void setTotalAmount(BigDecimal totalAmount) {
            this.totalAmount = totalAmount;
        }
        
        public OrderStatus getStatus() {
            return status;
        }
        
        public void setStatus(OrderStatus status) {
            this.status = status;
        }
        
        public String getShippingAddress() {
            return shippingAddress;
        }
        
        public void setShippingAddress(String shippingAddress) {
            this.shippingAddress = shippingAddress;
        }
        
        public String getNotes() {
            return notes;
        }
        
        public void setNotes(String notes) {
            this.notes = notes;
        }
        
        public List<OrderItem> getItems() {
            return items;
        }
        
        public void setItems(List<OrderItem> items) {
            this.items = items;
        }
        
        @Override
        public String toString() {
            return "Order{" +
                    "id=" + id +
                    ", orderDate=" + orderDate +
                    ", totalAmount=" + totalAmount +
                    ", status=" + status +
                    '}';
        }
    }
    
    /**
     * Enum pour les statuts de commande
     */
    public enum OrderStatus {
        PENDING("En attente"),
        CONFIRMED("ConfirmÃ©e"),
        PROCESSING("En cours de traitement"),
        SHIPPED("ExpÃ©diÃ©e"),
        DELIVERED("LivrÃ©e"),
        CANCELLED("AnnulÃ©e");
        
        private final String displayName;
        
        OrderStatus(String displayName) {
            this.displayName = displayName;
        }
        
        public String getDisplayName() {
            return displayName;
        }
    }</code></pre>
    
                    <h4>Couche 2 : DAO (Data Access Object)</h4>
    
    <pre><code>package com.example.dao;
    
    import com.example.entity. Order;
    import com.example. entity.OrderStatus;
    import javax.ejb.Stateless;
    import javax.persistence.EntityManager;
    import javax.persistence.PersistenceContext;
    import javax.persistence.TypedQuery;
    import java.time.LocalDateTime;
    import java. util.List;
    
    /**
     * DAO pour gÃ©rer l'accÃ¨s aux donnÃ©es Order en PostgreSQL
     * 
     * RESPONSABILITÃ‰ : UNIQUEMENT accÃ¨s base de donnÃ©es
     * PAS de logique mÃ©tier ici ! 
     */
    @Stateless
    public class OrderDAO {
        
        @PersistenceContext(unitName = "PostgresPU")
        private EntityManager em;
        
        /**
         * CrÃ©er une nouvelle commande
         */
        public void create(Order order) {
            em.persist(order);
        }
        
        /**
         * Trouver une commande par ID
         */
        public Order findById(Long id) {
            return em.find(Order.class, id);
        }
        
        /**
         * Trouver une commande avec ses items (Ã©vite N+1)
         */
        public Order findByIdWithItems(Long id) {
            String jpql = "SELECT o FROM Order o " +
                         "LEFT JOIN FETCH o.items " +
                         "WHERE o. id = :id";
            
            TypedQuery<Order> query = em.createQuery(jpql, Order.class);
            query.setParameter("id", id);
            
            try {
                return query.getSingleResult();
            } catch (Exception e) {
                return null;
            }
        }
        
        /**
         * Trouver toutes les commandes
         */
        public List<Order> findAll() {
            String jpql = "SELECT o FROM Order o ORDER BY o.orderDate DESC";
            return em.createQuery(jpql, Order.class).getResultList();
        }
        
        /**
         * Trouver les commandes d'un utilisateur
         */
        public List<Order> findByUserId(Long userId) {
            String jpql = "SELECT o FROM Order o WHERE o.user.id = :userId " +
                         "ORDER BY o.orderDate DESC";
            
            TypedQuery<Order> query = em.createQuery(jpql, Order.class);
            query.setParameter("userId", userId);
            
            return query.getResultList();
        }
        
        /**
         * Trouver les commandes par statut
         */
        public List<Order> findByStatus(OrderStatus status) {
            String jpql = "SELECT o FROM Order o WHERE o.status = :status " +
                         "ORDER BY o.orderDate DESC";
            
            TypedQuery<Order> query = em.createQuery(jpql, Order.class);
            query.setParameter("status", status);
            
            return query.getResultList();
        }
        
        /**
         * Trouver les commandes rÃ©centes (avec limite)
         */
        public List<Order> findRecent(int limit) {
            String jpql = "SELECT o FROM Order o ORDER BY o.orderDate DESC";
            
            TypedQuery<Order> query = em.createQuery(jpql, Order.class);
            query.setMaxResults(limit);
            
            return query.getResultList();
        }
        
        /**
         * Trouver les commandes dans une pÃ©riode
         */
        public List<Order> findByDateRange(LocalDateTime startDate, LocalDateTime endDate) {
            String jpql = "SELECT o FROM Order o " +
                         "WHERE o. orderDate BETWEEN :startDate AND :endDate " +
                         "ORDER BY o.orderDate DESC";
            
            TypedQuery<Order> query = em.createQuery(jpql, Order.class);
            query.setParameter("startDate", startDate);
            query.setParameter("endDate", endDate);
            
            return query.getResultList();
        }
        
        /**
         * Compter les commandes par statut
         */
        public long countByStatus(OrderStatus status) {
            String jpql = "SELECT COUNT(o) FROM Order o WHERE o.status = :status";
            
            TypedQuery<Long> query = em.createQuery(jpql, Long.class);
            query.setParameter("status", status);
            
            return query.getSingleResult();
        }
        
        /**
         * Mettre Ã  jour une commande
         */
        public Order update(Order order) {
            return em.merge(order);
        }
        
        /**
         * Supprimer une commande
         */
        public void delete(Long id) {
            Order order = findById(id);
            if (order != null) {
                em.remove(order);
            }
        }
        
        /**
         * Supprimer une commande (objet)
         */
        public void delete(Order order) {
            if (em.contains(order)) {
                em.remove(order);
            } else {
                em.remove(em.merge(order));
            }
        }
    }</code></pre>
    
                    <h4>Couche 3 : Service (Logique MÃ©tier avec EJB)</h4>
    
    <pre><code>package com. example.service;
    
    import com. example.dao.OrderDAO;
    import com. example.dao.LogDAO;
    import com.example. dao.UserDAO;
    import com. example.entity.Order;
    import com.example.entity.OrderStatus;
    import com.example.entity.User;
    import com.example.dto.DashboardStats;
    
    import javax.ejb.EJB;
    import javax.ejb.Stateless;
    import javax.ejb.TransactionAttribute;
    import javax.ejb.TransactionAttributeType;
    import java.math.BigDecimal;
    import java.time.LocalDateTime;
    import java.util.List;
    
    /**
     * Service pour gÃ©rer la logique mÃ©tier des commandes
     * 
     * RESPONSABILITÃ‰S :
     * - Validation des donnÃ©es
     * - Orchestration (appelle plusieurs DAO)
     * - Gestion des transactions
     * - Logs des Ã©vÃ©nements importants
     * - Application des rÃ¨gles mÃ©tier
     */
    @Stateless
    public class OrderService {
        
        @EJB
        private OrderDAO orderDAO;
        
        @EJB
        private UserDAO userDAO;
        
        @EJB
        private LogDAO logDAO;  // MongoDB
        
        /**
         * CrÃ©er une nouvelle commande avec logs
         * Transaction JTA : tout ou rien
         */
        @TransactionAttribute(TransactionAttributeType.REQUIRED)
        public Order createOrder(Long userId, BigDecimal amount, String shippingAddress) {
            
            // Validation 1 : VÃ©rifier que l'utilisateur existe
            User user = userDAO.findById(userId);
            if (user == null) {
                throw new IllegalArgumentException("Utilisateur introuvable : ID " + userId);
            }
            
            // Validation 2 : VÃ©rifier que le montant est valide
            if (amount == null || amount.compareTo(BigDecimal.ZERO) <= 0) {
                throw new IllegalArgumentException("Le montant doit Ãªtre supÃ©rieur Ã  zÃ©ro");
            }
            
            // Validation 3 : VÃ©rifier l'adresse
            if (shippingAddress == null || shippingAddress.trim().isEmpty()) {
                throw new IllegalArgumentException("L'adresse de livraison est obligatoire");
            }
            
            // CrÃ©ation de la commande
            Order order = new Order(user, amount);
            order.setShippingAddress(shippingAddress);
            order.setStatus(OrderStatus. PENDING);
            
            // Sauvegarde en PostgreSQL
            orderDAO.create(order);
            
            // Log de l'Ã©vÃ©nement en MongoDB
            try {
                logDAO.logOrderCreation(
                    order.getId(),
                    user.getEmail(),
                    amount,
                    shippingAddress
                );
            } catch (Exception e) {
                // Si le log Ã©choue, on annule tout (rollback JTA)
                throw new RuntimeException("Ã‰chec du logging", e);
            }
            
            return order;
        }
        
        /**
         * RÃ©cupÃ©rer une commande par ID
         */
        public Order getOrderById(Long id) {
            Order order = orderDAO.findByIdWithItems(id);
            
            if (order == null) {
                throw new IllegalArgumentException("Commande introuvable : ID " + id);
            }
            
            return order;
        }
        
        /**
         * RÃ©cupÃ©rer toutes les commandes
         */
        public List<Order> getAllOrders() {
            return orderDAO.findAll();
        }
        
        /**
         * RÃ©cupÃ©rer les commandes d'un utilisateur
         */
        public List<Order> getUserOrders(Long userId) {
            // VÃ©rifier que l'utilisateur existe
            User user = userDAO.findById(userId);
            if (user == null) {
                throw new IllegalArgumentException("Utilisateur introuvable : ID " + userId);
            }
            
            return orderDAO.findByUserId(userId);
        }
        
        /**
         * RÃ©cupÃ©rer les commandes rÃ©centes
         */
        public List<Order> getRecentOrders(int limit) {
            if (limit <= 0 || limit > 100) {
                throw new IllegalArgumentException("La limite doit Ãªtre entre 1 et 100");
            }
            
            return orderDAO.findRecent(limit);
        }
        
        /**
         * Mettre Ã  jour le statut d'une commande
         */
        @TransactionAttribute(TransactionAttributeType.REQUIRED)
        public void updateOrderStatus(Long orderId, OrderStatus newStatus) {
            // RÃ©cupÃ©rer la commande
            Order order = orderDAO.findById(orderId);
            if (order == null) {
                throw new IllegalArgumentException("Commande introuvable : ID " + orderId);
            }
            
            // Validation : rÃ¨gles mÃ©tier de transition de statut
            OrderStatus currentStatus = order.getStatus();
            validateStatusTransition(currentStatus, newStatus);
            
            // Mise Ã  jour du statut
            order.setStatus(newStatus);
            orderDAO.update(order);
            
            // Logger le changement
            logDAO.logStatusChange(orderId, currentStatus, newStatus);
        }
        
        /**
         * Annuler une commande
         */
        @TransactionAttribute(TransactionAttributeType.REQUIRED)
        public void cancelOrder(Long orderId, String reason) {
            Order order = orderDAO.findById(orderId);
            if (order == null) {
                throw new IllegalArgumentException("Commande introuvable : ID " + orderId);
            }
            
            // RÃ¨gle mÃ©tier : On ne peut annuler que si PENDING ou CONFIRMED
            if (order.getStatus() == OrderStatus.SHIPPED || 
                order.getStatus() == OrderStatus.DELIVERED) {
                throw new IllegalStateException(
                    "Impossible d'annuler une commande dÃ©jÃ  expÃ©diÃ©e ou livrÃ©e"
                );
            }
            
            if (order.getStatus() == OrderStatus. CANCELLED) {
                throw new IllegalStateException("Cette commande est dÃ©jÃ  annulÃ©e");
            }
            
            // Annulation
            order.setStatus(OrderStatus.CANCELLED);
            order.setNotes("AnnulÃ©e : " + reason);
            orderDAO.update(order);
            
            // Logger
            logDAO.logOrderCancellation(orderId, reason);
        }
        
        /**
         * Supprimer une commande (admin uniquement)
         */
        @TransactionAttribute(TransactionAttributeType.REQUIRED)
        public void deleteOrder(Long orderId) {
            Order order = orderDAO.findById(orderId);
            if (order == null) {
                throw new IllegalArgumentException("Commande introuvable : ID " + orderId);
            }
            
            // RÃ¨gle mÃ©tier : On ne peut supprimer que les commandes annulÃ©es
            if (order. getStatus() != OrderStatus.CANCELLED) {
                throw new IllegalStateException(
                    "Seules les commandes annulÃ©es peuvent Ãªtre supprimÃ©es"
                );
            }
            
            // Suppression
            orderDAO. delete(order);
            
            // Logger
            logDAO.logOrderDeletion(orderId);
        }
        
        /**
         * Obtenir les statistiques du dashboard
         */
        public DashboardStats getDashboardStats() {
            DashboardStats stats = new DashboardStats();
            
            // Stats PostgreSQL
            stats.setPendingOrders(orderDAO. countByStatus(OrderStatus. PENDING));
            stats.setConfirmedOrders(orderDAO.countByStatus(OrderStatus. CONFIRMED));
            stats.setShippedOrders(orderDAO. countByStatus(OrderStatus. SHIPPED));
            stats.setDeliveredOrders(orderDAO. countByStatus(OrderStatus. DELIVERED));
            stats.setCancelledOrders(orderDAO.countByStatus(OrderStatus.CANCELLED));
            
            // Stats MongoDB (logs, analytics)
            stats.setErrorLogs(logDAO.countErrorLogs());
            stats.setWarningLogs(logDAO.countWarningLogs());
            stats.setTopActiveUsers(logDAO.getTopActiveUsers(5));
            
            return stats;
        }
        
        /**
         * Valider la transition de statut (rÃ¨gle mÃ©tier)
         */
        private void validateStatusTransition(OrderStatus from, OrderStatus to) {
            // DÃ©finir les transitions autorisÃ©es
            boolean valid = false;
            
            switch (from) {
                case PENDING:
                    valid = (to == OrderStatus.CONFIRMED || to == OrderStatus.CANCELLED);
                    break;
                case CONFIRMED:
                    valid = (to == OrderStatus.PROCESSING || to == OrderStatus.CANCELLED);
                    break;
                case PROCESSING:
                    valid = (to == OrderStatus.SHIPPED || to == OrderStatus.CANCELLED);
                    break;
                case SHIPPED:
                    valid = (to == OrderStatus.DELIVERED);
                    break;
                case DELIVERED:
                case CANCELLED:
                    valid = false;  // Ã‰tats finaux
                    break;
            }
            
            if (!valid) {
                throw new IllegalStateException(
                    String.format("Transition invalide : %s â†’ %s", from, to)
                );
            }
        }
    }</code></pre>
    
    <h4>Couche 4 : Controller (Servlet)</h4>

    <pre><code>package com.example.controller;
    
    import com.example.entity.Order;
    import com.example.entity.OrderStatus;
    import com. example.service.OrderService;
    import com.example.dto.DashboardStats;
    
    import javax.ejb.EJB;
    import javax.servlet.ServletException;
    import javax.servlet. annotation.WebServlet;
    import javax.servlet.http.HttpServlet;
    import javax.servlet. http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;
    import java. io.IOException;
    import java. math.BigDecimal;
    import java.util.List;
    
    /**
     * Servlet contrÃ´leur pour gÃ©rer les requÃªtes HTTP liÃ©es aux commandes
     * 
     * RESPONSABILITÃ‰S :
     * - Recevoir les requÃªtes HTTP (GET, POST)
     * - Parser les paramÃ¨tres
     * - Appeler le Service Layer
     * - Choisir la vue (JSP) Ã  afficher
     * - GÃ©rer la navigation (redirect, forward)
     * 
     * PAS DE LOGIQUE MÃ‰TIER ICI ! 
     */
    @WebServlet("/orders")
    public class OrderServlet extends HttpServlet {
        
        @EJB
        private OrderService orderService;
        
        /**
         * GÃ¨re les requÃªtes GET (affichage)
         * Exemples d'URLs :
         * - /orders? action=list â†’ Liste toutes les commandes
         * - /orders?action=view&id=123 â†’ Affiche la commande 123
         * - /orders?action=create â†’ Affiche le formulaire de crÃ©ation
         * - /orders?action=user&userId=5 â†’ Commandes de l'utilisateur 5
         */
        @Override
        protected void doGet(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            // RÃ©cupÃ©rer le paramÃ¨tre "action"
            String action = req.getParameter("action");
            
            // Si aucune action, par dÃ©faut "list"
            if (action == null || action.isEmpty()) {
                action = "list";
            }
            
            try {
                // Router vers la bonne mÃ©thode selon l'action
                switch (action) {
                    case "list":
                        listOrders(req, resp);
                        break;
                        
                    case "view":
                        viewOrder(req, resp);
                        break;
                        
                    case "create":
                        showCreateForm(req, resp);
                        break;
                        
                    case "edit":
                        showEditForm(req, resp);
                        break;
                        
                    case "user":
                        listUserOrders(req, resp);
                        break;
                        
                    case "recent":
                        listRecentOrders(req, resp);
                        break;
                        
                    default:
                        // Action inconnue â†’ Erreur 404
                        resp. sendError(HttpServletResponse. SC_NOT_FOUND, 
                                      "Action inconnue : " + action);
                }
                
            } catch (IllegalArgumentException e) {
                // Erreur de validation (ex: ID invalide)
                req.setAttribute("error", e.getMessage());
                req.getRequestDispatcher("/WEB-INF/views/error.jsp").forward(req, resp);
                
            } catch (Exception e) {
                // Erreur inattendue
                e.printStackTrace();
                req.setAttribute("error", "Erreur serveur : " + e.getMessage());
                req.getRequestDispatcher("/WEB-INF/views/error.jsp").forward(req, resp);
            }
        }
        
        /**
         * GÃ¨re les requÃªtes POST (actions)
         * Exemples :
         * - POST /orders? action=create â†’ CrÃ©e une commande
         * - POST /orders?action=updateStatus â†’ Change le statut
         * - POST /orders?action=cancel â†’ Annule une commande
         * - POST /orders?action=delete â†’ Supprime une commande
         */
        @Override
        protected void doPost(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            String action = req.getParameter("action");
            
            if (action == null || action.isEmpty()) {
                resp.sendError(HttpServletResponse.SC_BAD_REQUEST, "Action manquante");
                return;
            }
            
            try {
                switch (action) {
                    case "create":
                        createOrder(req, resp);
                        break;
                        
                    case "updateStatus":
                        updateOrderStatus(req, resp);
                        break;
                        
                    case "cancel":
                        cancelOrder(req, resp);
                        break;
                        
                    case "delete":
                        deleteOrder(req, resp);
                        break;
                        
                    default:
                        resp.sendError(HttpServletResponse.SC_NOT_FOUND, 
                                      "Action inconnue : " + action);
                }
                
            } catch (IllegalArgumentException e) {
                req.setAttribute("error", e.getMessage());
                req.getRequestDispatcher("/WEB-INF/views/error.jsp"). forward(req, resp);
                
            } catch (IllegalStateException e) {
                req.setAttribute("error", "OpÃ©ration invalide : " + e.getMessage());
                req.getRequestDispatcher("/WEB-INF/views/error.jsp"). forward(req, resp);
                
            } catch (Exception e) {
                e.printStackTrace();
                req.setAttribute("error", "Erreur serveur : " + e.getMessage());
                req. getRequestDispatcher("/WEB-INF/views/error.jsp").forward(req, resp);
            }
        }
        
        // =========================================================================
        // MÃ‰THODES GET (Affichage)
        // =========================================================================
        
        /**
         * Affiche la liste de toutes les commandes
         */
        private void listOrders(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            // Appeler le service
            List<Order> orders = orderService.getAllOrders();
            
            // Passer les donnÃ©es Ã  la JSP
            req.setAttribute("orders", orders);
            
            // Forward vers la vue
            req.getRequestDispatcher("/WEB-INF/views/orderList.jsp").forward(req, resp);
        }
        
        /**
         * Affiche les dÃ©tails d'une commande
         */
        private void viewOrder(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            // Parser le paramÃ¨tre "id"
            String idParam = req.getParameter("id");
            if (idParam == null || idParam.isEmpty()) {
                throw new IllegalArgumentException("ID de commande manquant");
            }
            
            Long orderId = Long.parseLong(idParam);
            
            // Appeler le service
            Order order = orderService. getOrderById(orderId);
            
            // Passer les donnÃ©es Ã  la JSP
            req.setAttribute("order", order);
            
            // Forward vers la vue dÃ©tail
            req.getRequestDispatcher("/WEB-INF/views/orderDetail.jsp").forward(req, resp);
        }
        
        /**
         * Affiche le formulaire de crÃ©ation
         */
        private void showCreateForm(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            // Simplement afficher le formulaire
            req.getRequestDispatcher("/WEB-INF/views/orderForm.jsp").forward(req, resp);
        }
        
        /**
         * Affiche le formulaire d'Ã©dition
         */
        private void showEditForm(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            String idParam = req.getParameter("id");
            if (idParam == null || idParam.isEmpty()) {
                throw new IllegalArgumentException("ID de commande manquant");
            }
            
            Long orderId = Long.parseLong(idParam);
            Order order = orderService.getOrderById(orderId);
            
            req.setAttribute("order", order);
            req.getRequestDispatcher("/WEB-INF/views/orderForm.jsp").forward(req, resp);
        }
        
        /**
         * Affiche les commandes d'un utilisateur
         */
        private void listUserOrders(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            String userIdParam = req.getParameter("userId");
            if (userIdParam == null || userIdParam. isEmpty()) {
                throw new IllegalArgumentException("ID utilisateur manquant");
            }
            
            Long userId = Long.parseLong(userIdParam);
            
            List<Order> orders = orderService. getUserOrders(userId);
            
            req.setAttribute("orders", orders);
            req.setAttribute("userId", userId);
            
            req.getRequestDispatcher("/WEB-INF/views/orderList.jsp").forward(req, resp);
        }
        
        /**
         * Affiche les commandes rÃ©centes
         */
        private void listRecentOrders(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            // ParamÃ¨tre optionnel : limite (par dÃ©faut 10)
            String limitParam = req.getParameter("limit");
            int limit = 10;
            
            if (limitParam != null && !limitParam.isEmpty()) {
                limit = Integer.parseInt(limitParam);
            }
            
            List<Order> orders = orderService. getRecentOrders(limit);
            
            req.setAttribute("orders", orders);
            req. setAttribute("recent", true);
            
            req.getRequestDispatcher("/WEB-INF/views/orderList.jsp").forward(req, resp);
        }
        
        // =========================================================================
        // MÃ‰THODES POST (Actions)
        // =========================================================================
        
        /**
         * CrÃ©e une nouvelle commande
         */
        private void createOrder(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            // Parser les paramÃ¨tres du formulaire
            String userIdParam = req.getParameter("userId");
            String amountParam = req.getParameter("amount");
            String shippingAddress = req.getParameter("shippingAddress");
            
            // Validation des paramÃ¨tres
            if (userIdParam == null || userIdParam. isEmpty()) {
                throw new IllegalArgumentException("ID utilisateur manquant");
            }
            if (amountParam == null || amountParam.isEmpty()) {
                throw new IllegalArgumentException("Montant manquant");
            }
            if (shippingAddress == null || shippingAddress.trim().isEmpty()) {
                throw new IllegalArgumentException("Adresse de livraison manquante");
            }
            
            Long userId = Long.parseLong(userIdParam);
            BigDecimal amount = new BigDecimal(amountParam);
            
            // Appeler le service pour crÃ©er la commande
            Order order = orderService.createOrder(userId, amount, shippingAddress);
            
            // Rediriger vers la page de dÃ©tail de la commande crÃ©Ã©e
            resp.sendRedirect(req.getContextPath() + "/orders?action=view&id=" + order.getId());
        }
        
        /**
         * Met Ã  jour le statut d'une commande
         */
        private void updateOrderStatus(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            String orderIdParam = req.getParameter("orderId");
            String statusParam = req.getParameter("status");
            
            if (orderIdParam == null || orderIdParam.isEmpty()) {
                throw new IllegalArgumentException("ID commande manquant");
            }
            if (statusParam == null || statusParam.isEmpty()) {
                throw new IllegalArgumentException("Statut manquant");
            }
            
            Long orderId = Long.parseLong(orderIdParam);
            OrderStatus newStatus = OrderStatus.valueOf(statusParam);
            
            // Appeler le service
            orderService.updateOrderStatus(orderId, newStatus);
            
            // Rediriger vers la page de dÃ©tail
            resp.sendRedirect(req.getContextPath() + "/orders?action=view&id=" + orderId);
        }
        
        /**
         * Annule une commande
         */
        private void cancelOrder(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            String orderIdParam = req.getParameter("orderId");
            String reason = req.getParameter("reason");
            
            if (orderIdParam == null || orderIdParam.isEmpty()) {
                throw new IllegalArgumentException("ID commande manquant");
            }
            if (reason == null || reason.trim().isEmpty()) {
                reason = "Aucune raison fournie";
            }
            
            Long orderId = Long.parseLong(orderIdParam);
            
            // Appeler le service
            orderService.cancelOrder(orderId, reason);
            
            // Rediriger vers la page de dÃ©tail
            resp.sendRedirect(req.getContextPath() + "/orders?action=view&id=" + orderId);
        }
        
        /**
         * Supprime une commande
         */
        private void deleteOrder(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            String orderIdParam = req.getParameter("orderId");
            
            if (orderIdParam == null || orderIdParam.isEmpty()) {
                throw new IllegalArgumentException("ID commande manquant");
            }
            
            Long orderId = Long.parseLong(orderIdParam);
            
            // Appeler le service
            orderService. deleteOrder(orderId);
            
            // Rediriger vers la liste
            resp.sendRedirect(req.getContextPath() + "/orders?action=list");
        }
    }</code></pre>
    
                    <div class="code-explanation">
                        <h5>ğŸ“ Points clÃ©s du Servlet</h5>
                        <ul>
                            <li><strong>SÃ©paration GET/POST</strong> : GET pour affichage, POST pour actions (principe REST)</li>
                            <li><strong>Routing par paramÃ¨tre "action"</strong> : Une seule URL, plusieurs actions</li>
                            <li><strong>Injection EJB</strong> : <span class="inline-code">@EJB</span> injecte automatiquement le service</li>
                            <li><strong>Gestion d'erreurs</strong> : DiffÃ©rents types d'exceptions traitÃ©es diffÃ©remment</li>
                            <li><strong>Forward vs Redirect</strong> : 
                                <ul>
                                    <li><strong>Forward</strong> : Pour afficher une vue (garde les donnÃ©es en mÃ©moire)</li>
                                    <li><strong>Redirect</strong> : AprÃ¨s une action POST (Ã©vite double soumission)</li>
                                </ul>
                            </li>
                            <li><strong>Pas de logique mÃ©tier</strong> : Le servlet dÃ©lÃ¨gue TOUT au service</li>
                        </ul>
                    </div>
    
                    <h4>Couche 5 : View (JSP avec JSTL)</h4>
    
                    <h5>A.  Liste des commandes (orderList.jsp)</h5>
    
    <pre><code>&lt;%@ page contentType="text/html;charset=UTF-8" language="java" %&gt;
    &lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
    &lt;%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %&gt;
    
    &lt;! DOCTYPE html&gt;
    &lt;html lang="fr"&gt;
    &lt;head&gt;
        &lt;meta charset="UTF-8"&gt;
        &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
        &lt;title&gt;Liste des Commandes&lt;/title&gt;
        &lt;style&gt;
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f5f5f5;
                padding: 20px;
            }
            
            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            h1 {
                color: #333;
                margin-bottom: 30px;
                padding-bottom: 15px;
                border-bottom: 3px solid #667eea;
            }
            
            .toolbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            
            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                text-decoration: none;
                font-size: 14px;
                transition: all 0.3s;
            }
            
            .btn-primary {
                background: #667eea;
                color: white;
            }
            
            . btn-primary:hover {
                background: #5568d3;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            
            th {
                background: #667eea;
                color: white;
                padding: 15px;
                text-align: left;
                font-weight: 600;
            }
            
            td {
                padding: 12px 15px;
                border-bottom: 1px solid #ddd;
            }
            
            tr:hover {
                background: #f9f9f9;
            }
            
            .status {
                padding: 5px 15px;
                border-radius: 20px;
                font-weight: bold;
                font-size: 12px;
                display: inline-block;
            }
            
            .status-pending { background: #fff3cd; color: #856404; }
            .status-confirmed { background: #d1ecf1; color: #0c5460; }
            . status-processing { background: #cce5ff; color: #004085; }
            .status-shipped { background: #d4edda; color: #155724; }
            .status-delivered { background: #d4edda; color: #155724; }
            .status-cancelled { background: #f8d7da; color: #721c24; }
            
            .actions {
                display: flex;
                gap: 10px;
            }
            
            .actions a {
                color: #667eea;
                text-decoration: none;
                font-weight: 500;
            }
            
            .actions a:hover {
                text-decoration: underline;
            }
            
            .empty-message {
                text-align: center;
                padding: 40px;
                color: #999;
                font-size: 18px;
            }
            
            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
            }
            
            .stat-card {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
            }
            
            .stat-card h3 {
                font-size: 2em;
                margin-bottom: 5px;
            }
            
            .stat-card p {
                opacity: 0.9;
            }
        &lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="container"&gt;
            &lt;h1&gt;ğŸ“¦ Gestion des Commandes&lt;/h1&gt;
            
            &lt;! -- Barre d'outils --&gt;
            &lt;div class="toolbar"&gt;
                &lt;div&gt;
                    &lt;a href="${pageContext.request.contextPath}/orders?action=list" class="btn btn-primary"&gt;
                        ğŸ”„ Actualiser
                    &lt;/a&gt;
                    &lt;a href="${pageContext.request.contextPath}/orders? action=recent&amp;limit=20" class="btn btn-primary"&gt;
                        â±ï¸ RÃ©centes
                    &lt;/a&gt;
                &lt;/div&gt;
                &lt;a href="${pageContext.request.contextPath}/orders?action=create" class="btn btn-primary"&gt;
                    â• Nouvelle Commande
                &lt;/a&gt;
            &lt;/div&gt;
            
            &lt;!-- Tableau des commandes --&gt;
            &lt;c:choose&gt;
                &lt;c:when test="${not empty orders}"&gt;
                    
                    &lt;! -- Statistiques rapides --&gt;
                    &lt;div class="stats"&gt;
                        &lt;div class="stat-card"&gt;
                            &lt;h3&gt;${orders.size()}&lt;/h3&gt;
                            &lt;p&gt;Commandes AffichÃ©es&lt;/p&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    
                    &lt;table&gt;
                        &lt;thead&gt;
                            &lt;tr&gt;
                                &lt;th&gt;ID&lt;/th&gt;
                                &lt;th&gt;Client&lt;/th&gt;
                                &lt;th&gt;Date&lt;/th&gt;
                                &lt;th&gt;Montant&lt;/th&gt;
                                &lt;th&gt;Statut&lt;/th&gt;
                                &lt;th&gt;Actions&lt;/th&gt;
                            &lt;/tr&gt;
                        &lt;/thead&gt;
                        &lt;tbody&gt;
                            &lt;! -- â­ BOUCLE JSTL : Parcourir toutes les commandes --&gt;
                            &lt;c:forEach var="order" items="${orders}"&gt;
                                &lt;tr&gt;
                                    &lt;! -- ID --&gt;
                                    &lt;td&gt;&lt;strong&gt;#${order.id}&lt;/strong&gt;&lt;/td&gt;
                                    
                                    &lt;!-- Client --&gt;
                                    &lt;td&gt;${order.user.name}&lt;/td&gt;
                                    
                                    &lt;!-- Date formatÃ©e --&gt;
                                    &lt;td&gt;
                                        &lt;fmt:formatDate value="${order.orderDate}" 
                                                       pattern="dd/MM/yyyy HH:mm"/&gt;
                                    &lt;/td&gt;
                                    
                                    &lt;!-- Montant formatÃ© en euros --&gt;
                                    &lt;td&gt;
                                        &lt;fmt:formatNumber value="${order.totalAmount}" 
                                                         type="currency" 
                                                         currencySymbol="â‚¬"/&gt;
                                    &lt;/td&gt;
                                    
                                    &lt;!-- Statut avec couleur dynamique --&gt;
                                    &lt;td&gt;
                                        &lt;c:choose&gt;
                                            &lt;c:when test="${order.status == 'PENDING'}"&gt;
                                                &lt;span class="status status-pending"&gt;En attente&lt;/span&gt;
                                            &lt;/c:when&gt;
                                            &lt;c:when test="${order.status == 'CONFIRMED'}"&gt;
                                                &lt;span class="status status-confirmed"&gt;ConfirmÃ©e&lt;/span&gt;
                                            &lt;/c:when&gt;
                                            &lt;c:when test="${order.status == 'PROCESSING'}"&gt;
                                                &lt;span class="status status-processing"&gt;En cours&lt;/span&gt;
                                            &lt;/c:when&gt;
                                            &lt;c:when test="${order.status == 'SHIPPED'}"&gt;
                                                &lt;span class="status status-shipped"&gt;ExpÃ©diÃ©e&lt;/span&gt;
                                            &lt;/c:when&gt;
                                            &lt;c:when test="${order.status == 'DELIVERED'}"&gt;
                                                &lt;span class="status status-delivered"&gt;LivrÃ©e&lt;/span&gt;
                                            &lt;/c:when&gt;
                                            &lt;c:when test="${order. status == 'CANCELLED'}"&gt;
                                                &lt;span class="status status-cancelled"&gt;AnnulÃ©e&lt;/span&gt;
                                            &lt;/c:when&gt;
                                            &lt;c:otherwise&gt;
                                                ${order.status}
                                            &lt;/c:otherwise&gt;
                                        &lt;/c:choose&gt;
                                    &lt;/td&gt;
                                    
                                    &lt;!-- Actions --&gt;
                                    &lt;td&gt;
                                        &lt;div class="actions"&gt;
                                            &lt;a href="${pageContext.request.contextPath}/orders?action=view&amp;id=${order.id}"&gt;
                                                ğŸ‘ï¸ Voir
                                            &lt;/a&gt;
                                            
                                            &lt;! -- Afficher "Annuler" seulement si pas dÃ©jÃ  annulÃ©e --&gt;
                                            &lt;c:if test="${order.status != 'CANCELLED' && order.status != 'DELIVERED'}"&gt;
                                                &lt;a href="#" onclick="cancelOrder(${order.id}); return false;" style="color: #dc3545;"&gt;
                                                    âŒ Annuler
                                                &lt;/a&gt;
                                            &lt;/c:if&gt;
                                        &lt;/div&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                            &lt;/c:forEach&gt;
                        &lt;/tbody&gt;
                    &lt;/table&gt;
                    
                &lt;/c:when&gt;
                
                &lt;! -- â­ CONDITION : Si aucune commande --&gt;
                &lt;c:otherwise&gt;
                    &lt;div class="empty-message"&gt;
                        ğŸ“­ Aucune commande trouvÃ©e. 
                        &lt;br&gt;&lt;br&gt;
                        &lt;a href="${pageContext.request.contextPath}/orders?action=create" class="btn btn-primary"&gt;
                            CrÃ©er la premiÃ¨re commande
                        &lt;/a&gt;
                    &lt;/div&gt;
                &lt;/c:otherwise&gt;
            &lt;/c:choose&gt;
        &lt;/div&gt;
        
        &lt;! -- JavaScript pour l'annulation --&gt;
        &lt;script&gt;
            function cancelOrder(orderId) {
                const reason = prompt("Raison de l'annulation :");
                
                if (reason !== null && reason.trim() !== "") {
                    // CrÃ©er un formulaire et le soumettre
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '${pageContext.request.contextPath}/orders?action=cancel';
                    
                    const orderIdInput = document.createElement('input');
                    orderIdInput.type = 'hidden';
                    orderIdInput.name = 'orderId';
                    orderIdInput. value = orderId;
                    
                    const reasonInput = document.createElement('input');
                    reasonInput.type = 'hidden';
                    reasonInput.name = 'reason';
                    reasonInput.value = reason;
                    
                    form.appendChild(orderIdInput);
                    form. appendChild(reasonInput);
                    document.body.appendChild(form);
                    form.submit();
                }
            }
        &lt;/script&gt;
    &lt;/body&gt;
    &lt;/html&gt;</code></pre>
    
                    <h5>B. DÃ©tail d'une commande (orderDetail.jsp)</h5>
    
    <pre><code>&lt;%@ page contentType="text/html;charset=UTF-8" language="java" %&gt;
    &lt;%@ taglib prefix="c" uri="http://java. sun.com/jsp/jstl/core" %&gt;
    &lt;%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %&gt;
    
    &lt;!DOCTYPE html&gt;
    &lt;html lang="fr"&gt;
    &lt;head&gt;
        &lt;meta charset="UTF-8"&gt;
        &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
        &lt;title&gt;Commande #${order.id}&lt;/title&gt;
        &lt;style&gt;
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f5f5f5;
                padding: 20px;
            }
            
            .container {
                max-width: 900px;
                margin: 0 auto;
                background: white;
                padding: 40px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            . header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 3px solid #667eea;
            }
            
            h1 {
                color: #333;
                font-size: 2em;
            }
            
            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                text-decoration: none;
                font-size: 14px;
                display: inline-block;
                transition: all 0.3s;
            }
            
            . btn-secondary {
                background: #6c757d;
                color: white;
            }
            
            .btn-secondary:hover {
                background: #5a6268;
            }
            
            .info-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                margin: 30px 0;
            }
            
            .info-box {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                border-left: 4px solid #667eea;
            }
            
            .info-box h3 {
                color: #667eea;
                font-size: 14px;
                text-transform: uppercase;
                margin-bottom: 10px;
            }
            
            .info-box p {
                color: #333;
                font-size: 16px;
                font-weight: 500;
            }
            
            .status {
                padding: 8px 20px;
                border-radius: 20px;
                font-weight: bold;
                font-size: 14px;
                display: inline-block;
            }
            
            .status-pending { background: #fff3cd; color: #856404; }
            .status-confirmed { background: #d1ecf1; color: #0c5460; }
            .status-processing { background: #cce5ff; color: #004085; }
            .status-shipped { background: #d4edda; color: #155724; }
            . status-delivered { background: #d4edda; color: #155724; }
            .status-cancelled { background: #f8d7da; color: #721c24; }
            
            . actions-section {
                background: #fff3e0;
                padding: 20px;
                border-radius: 8px;
                margin: 30px 0;
            }
            
            .actions-section h3 {
                margin-bottom: 15px;
                color: #e65100;
            }
            
            .action-buttons {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }
            
            .btn-warning {
                background: #ffc107;
                color: #333;
            }
            
            .btn-warning:hover {
                background: #e0a800;
            }
            
            .btn-danger {
                background: #dc3545;
                color: white;
            }
            
            . btn-danger:hover {
                background: #c82333;
            }
            
            .btn-success {
                background: #28a745;
                color: white;
            }
            
            . btn-success:hover {
                background: #218838;
            }
            
            .section-title {
                color: #667eea;
                font-size: 1.5em;
                margin: 30px 0 15px 0;
                padding-bottom: 10px;
                border-bottom: 2px solid #e0e0e0;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }
            
            th {
                background: #f8f9fa;
                padding: 12px;
                text-align: left;
                border-bottom: 2px solid #dee2e6;
            }
            
            td {
                padding: 12px;
                border-bottom: 1px solid #dee2e6;
            }
        &lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="container"&gt;
            &lt;! -- Header --&gt;
            &lt;div class="header"&gt;
                &lt;h1&gt;ğŸ“¦ Commande #${order.id}&lt;/h1&gt;
                &lt;a href="${pageContext.request. contextPath}/orders?action=list" class="btn btn-secondary"&gt;
                    â† Retour Ã  la liste
                &lt;/a&gt;
            &lt;/div&gt;
            
            &lt;!-- Informations principales --&gt;
            &lt;div class="info-grid"&gt;
                &lt;div class="info-box"&gt;
                    &lt;h3&gt;ğŸ‘¤ Client&lt;/h3&gt;
                    &lt;p&gt;${order. user.name}&lt;/p&gt;
                    &lt;p style="font-size: 14px; color: #666;"&gt;${order.user.email}&lt;/p&gt;
                &lt;/div&gt;
                
                &lt;div class="info-box"&gt;
                    &lt;h3&gt;ğŸ“… Date de commande&lt;/h3&gt;
                    &lt;p&gt;
                        &lt;fmt:formatDate value="${order.orderDate}" 
                                       pattern="dd MMMM yyyy 'Ã ' HH:mm" 
                                       locale="fr_FR"/&gt;
                    &lt;/p&gt;
                &lt;/div&gt;
                
                &lt;div class="info-box"&gt;
                    &lt;h3&gt;ğŸ’° Montant Total&lt;/h3&gt;
                    &lt;p style="font-size: 24px; color: #28a745;"&gt;
                        &lt;fmt:formatNumber value="${order.totalAmount}" 
                                         type="currency" 
                                         currencySymbol="â‚¬"/&gt;
                    &lt;/p&gt;
                &lt;/div&gt;
                
                &lt;div class="info-box"&gt;
                    &lt;h3&gt;ğŸ“Š Statut&lt;/h3&gt;
                    &lt;p&gt;
                        &lt;c:choose&gt;
                            &lt;c:when test="${order.status == 'PENDING'}"&gt;
                                &lt;span class="status status-pending"&gt;â³ En attente&lt;/span&gt;
                            &lt;/c:when&gt;
                            &lt;c:when test="${order. status == 'CONFIRMED'}"&gt;
                                &lt;span class="status status-confirmed"&gt;âœ… ConfirmÃ©e&lt;/span&gt;
                            &lt;/c:when&gt;
                            &lt;c:when test="${order.status == 'PROCESSING'}"&gt;
                                &lt;span class="status status-processing"&gt;âš™ï¸ En cours&lt;/span&gt;
                            &lt;/c:when&gt;
                            &lt;c:when test="${order.status == 'SHIPPED'}"&gt;
                                &lt;span class="status status-shipped"&gt;ğŸšš ExpÃ©diÃ©e&lt;/span&gt;
                            &lt;/c:when&gt;
                            &lt;c:when test="${order.status == 'DELIVERED'}"&gt;
                                &lt;span class="status status-delivered"&gt;ğŸ‰ LivrÃ©e&lt;/span&gt;
                            &lt;/c:when&gt;
                            &lt;c:when test="${order.status == 'CANCELLED'}"&gt;
                                &lt;span class="status status-cancelled"&gt;âŒ AnnulÃ©e&lt;/span&gt;
                            &lt;/c:when&gt;
                        &lt;/c:choose&gt;
                    &lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;! -- Adresse de livraison --&gt;
            &lt;div class="info-box" style="margin-top: 20px;"&gt;
                &lt;h3&gt;ğŸ“ Adresse de livraison&lt;/h3&gt;
                &lt;p&gt;${order.shippingAddress}&lt;/p&gt;
            &lt;/div&gt;
            
            &lt;!-- Notes (si prÃ©sentes) --&gt;
            &lt;c:if test="${not empty order. notes}"&gt;
                &lt;div class="info-box" style="margin-top: 20px; border-left-color: #ffc107;"&gt;
                    &lt;h3&gt;ğŸ“ Notes&lt;/h3&gt;
                    &lt;p&gt;${order.notes}&lt;/p&gt;
                &lt;/div&gt;
            &lt;/c:if&gt;
            
            &lt;! -- Articles de la commande --&gt;
            &lt;c:if test="${not empty order.items}"&gt;
                &lt;h2 class="section-title"&gt;ğŸ›’ Articles&lt;/h2&gt;
                &lt;table&gt;
                    &lt;thead&gt;
                        &lt;tr&gt;
                            &lt;th&gt;Produit&lt;/th&gt;
                            &lt;th&gt;QuantitÃ©&lt;/th&gt;
                            &lt;th&gt;Prix unitaire&lt;/th&gt;
                            &lt;th&gt;Total&lt;/th&gt;
                        &lt;/tr&gt;
                    &lt;/thead&gt;
                    &lt;tbody&gt;
                        &lt;c:forEach var="item" items="${order.items}"&gt;
                            &lt;tr&gt;
                                &lt;td&gt;${item.product.name}&lt;/td&gt;
                                &lt;td&gt;${item.quantity}&lt;/td&gt;
                                &lt;td&gt;
                                    &lt;fmt:formatNumber value="${item.unitPrice}" 
                                                     type="currency" 
                                                     currencySymbol="â‚¬"/&gt;
                                &lt;/td&gt;
                                &lt;td&gt;
                                    &lt;fmt:formatNumber value="${item.quantity * item.unitPrice}" 
                                                     type="currency" 
                                                     currencySymbol="â‚¬"/&gt;
                                &lt;/td&gt;
                            &lt;/tr&gt;
                        &lt;/c:forEach&gt;
                    &lt;/tbody&gt;
                &lt;/table&gt;
            &lt;/c:if&gt;
            
            &lt;!-- Actions possibles --&gt;
            &lt;c:if test="${order.status != 'CANCELLED' && order.status != 'DELIVERED'}"&gt;
                &lt;div class="actions-section"&gt;
                    &lt;h3&gt;âš¡ Actions disponibles&lt;/h3&gt;
                    &lt;div class="action-buttons"&gt;
                        
                        &lt;! -- Confirmer (si PENDING) --&gt;
                        &lt;c:if test="${order.status == 'PENDING'}"&gt;
                            &lt;form method="POST" action="${pageContext.request.contextPath}/orders" style="display: inline;"&gt;
                                &lt;input type="hidden" name="action" value="updateStatus"&gt;
                                &lt;input type="hidden" name="orderId" value="${order.id}"&gt;
                                &lt;input type="hidden" name="status" value="CONFIRMED"&gt;
                                &lt;button type="submit" class="btn btn-success"&gt;âœ… Confirmer&lt;/button&gt;
                            &lt;/form&gt;
                        &lt;/c:if&gt;
                        
                        &lt;!-- Passer en traitement (si CONFIRMED) --&gt;
                        &lt;c:if test="${order.status == 'CONFIRMED'}"&gt;
                            &lt;form method="POST" action="${pageContext.request.contextPath}/orders" style="display: inline;"&gt;
                                &lt;input type="hidden" name="action" value="updateStatus"&gt;
                                &lt;input type="hidden" name="orderId" value="${order. id}"&gt;
                                &lt;input type="hidden" name="status" value="PROCESSING"&gt;
                                &lt;button type="submit" class="btn btn-success"&gt;âš™ï¸ Mettre en traitement&lt;/button&gt;
                            &lt;/form&gt;
                        &lt;/c:if&gt;
                        
                        &lt;!-- ExpÃ©dier (si PROCESSING) --&gt;
                        &lt;c:if test="${order.status == 'PROCESSING'}"&gt;
                            &lt;form method="POST" action="${pageContext.request.contextPath}/orders" style="display: inline;"&gt;
                                &lt;input type="hidden" name="action" value="updateStatus"&gt;
                                &lt;input type="hidden" name="orderId" value="${order. id}"&gt;
                                &lt;input type="hidden" name="status" value="SHIPPED"&gt;
                                &lt;button type="submit" class="btn btn-success"&gt;ğŸšš Marquer comme expÃ©diÃ©e&lt;/button&gt;
                            &lt;/form&gt;
                        &lt;/c:if&gt;
                        
                        &lt;!-- Livrer (si SHIPPED) --&gt;
                        &lt;c:if test="${order.status == 'SHIPPED'}"&gt;
                            &lt;form method="POST" action="${pageContext.request.contextPath}/orders" style="display: inline;"&gt;
                                &lt;input type="hidden" name="action" value="updateStatus"&gt;
                                &lt;input type="hidden" name="orderId" value="${order.id}"&gt;
                                &lt;input type="hidden" name="status" value="DELIVERED"&gt;
                                &lt;button type="submit" class="btn btn-success"&gt;ğŸ‰ Marquer comme livrÃ©e&lt;/button&gt;
                            &lt;/form&gt;
                        &lt;/c:if&gt;
                        
                        &lt;!-- Annuler (si pas SHIPPED ni DELIVERED) --&gt;
                        &lt;c:if test="${order.status != 'SHIPPED' && order.status != 'DELIVERED'}"&gt;
                            &lt;button onclick="cancelOrder()" class="btn btn-danger"&gt;âŒ Annuler la commande&lt;/button&gt;
                        &lt;/c:if&gt;
                        
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/c:if&gt;
        &lt;/div&gt;
        
        &lt;script&gt;
            function cancelOrder() {
                const reason = prompt("Raison de l'annulation :");
                
                if (reason !== null && reason. trim() !== "") {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '${pageContext.request.contextPath}/orders? action=cancel';
                    
                    const orderIdInput = document.createElement('input');
                    orderIdInput.type = 'hidden';
                    orderIdInput.name = 'orderId';
                    orderIdInput.value = '${order.id}';
                    
                    const reasonInput = document. createElement('input');
                    reasonInput.type = 'hidden';
                    reasonInput.name = 'reason';
                    reasonInput.value = reason;
                    
                    form.appendChild(orderIdInput);
                    form.appendChild(reasonInput);
                    document.body.appendChild(form);
                    form.submit();
                }
            }
        &script&gt;
    &lt;/body&gt;
    &lt;/html&gt;</code></pre>
    
                    <div class="code-explanation">
                        <h5>ğŸ“ Points clÃ©s du JSP</h5>
                        <ul>
                            <li><strong>&lt;c:forEach&gt;</strong> : Boucle sur les collections (orders, items...  )</li>
                            <li><strong>&lt;c:if&gt; et &lt;c:choose&gt;</strong> : Conditions (afficher/cacher selon l'Ã©tat)</li>
                            <li><strong>&lt;fmt:formatDate&gt;</strong> : Formater les dates (pattern personnalisable)</li>
                            <li><strong>&lt;fmt:formatNumber&gt;</strong> : Formater les nombres (prix en euros)</li>
                            <li><strong>${expression}</strong> : Expression Language pour accÃ©der aux donnÃ©es</li>
                            <li><strong>Aucun scriptlet Java</strong> : Tout en JSTL/EL (bonne pratique)</li>
                            <li><strong>Logique UI uniquement</strong> : Affichage, pas de calculs complexes</li>
                        </ul>
                    </div>
    
                </div>
    
                <!-- ============================================ -->
                <!-- TP FINAL COMPLET -->
                <!-- ============================================ -->
                <div id="tp" class="tp-section">
                    <h2>ğŸ› ï¸ TP FINAL : Dashboard d'Analyse de Logs avec Polyglot Persistence</h2>
    
                    <div class="objectifs">
                        <h3>ğŸ¯ Objectifs du TP</h3>
                        <p>Ce TP final vous permet de mettre en pratique <strong>TOUS</strong> les concepts vus dans ce document :</p>
                        <ul>
                            <li>âœ… JPA avancÃ© avec relations complexes</li>
                            <li>âœ… MongoDB avec agrÃ©gations</li>
                            <li>âœ… Polyglot Persistence (PostgreSQL + MongoDB)</li>
                            <li>âœ… Transactions JTA ou Saga Pattern</li>
                            <li>âœ… Architecture MVC complÃ¨te</li>
                            <li>âœ… EJB pour la logique mÃ©tier</li>
                            <li>âœ… JSP/JSTL pour l'affichage</li>
                        </ul>
                    </div>
    
                    <h3>ğŸ“‹ Ã‰noncÃ© du Projet</h3>
                    
                    <div class="intro-box">
                        <p><strong>Contexte :</strong> Vous travaillez pour une entreprise e-commerce.   Le systÃ¨me gÃ©nÃ¨re Ã©normÃ©ment de logs (connexions utilisateur, commandes, erreurs, Ã©vÃ©nements.. .).  Votre mission est de crÃ©er un <strong>Dashboard d'Analyse et de Monitoring</strong>.</p>
    
                        <p><strong>Architecture technique :</strong></p>
                        <ul>
                            <li><strong>PostgreSQL</strong> : Stocke les donnÃ©es mÃ©tier (users, orders, products)</li>
                            <li><strong>MongoDB</strong> : Stocke les logs applicatifs (events, errors, analytics)</li>
                            <li><strong>Application JEE</strong> : GÃ¨re le tout avec MVC</li>
                        </ul>
                    </div>
    
                    <h3>ğŸ¨ FonctionnalitÃ©s Ã  ImplÃ©menter</h3>
    
                    <ol class="step-by-step" style="list-style: none; margin-left: 0;">
                        <li><strong>Gestion des Commandes</strong>
                            <ul>
                                <li>CrÃ©er une commande (INSERT PostgreSQL)</li>
                                <li>Logger l'Ã©vÃ©nement dans MongoDB</li>
                                <li>Garantir la cohÃ©rence (tout ou rien)</li>
                                <li>Afficher la liste des commandes</li>
                                <li>Voir les dÃ©tails d'une commande</li>
                            </ul>
                        </li>
                        <li><strong>Dashboard Analytics</strong>
                            <ul>
                                <li>Nombre de commandes par statut (PostgreSQL)</li>
                                <li>Nombre d'erreurs dans les logs (MongoDB)</li>
                                <li>Top 5 utilisateurs les plus actifs (MongoDB aggregation)</li>
                                <li>RÃ©partition des Ã©vÃ©nements par type (MongoDB aggregation)</li>
                                <li>Graphique des erreurs sur 24h (bonus)</li>
                            </ul>
                        </li>
                        <li><strong>Consultation des Logs</strong>
                            <ul>
                                <li>Afficher les derniers logs</li>
                                <li>Filtrer par niveau (INFO, WARNING, ERROR)</li>
                                <li>Rechercher par service</li>
                                <li>Pagination des rÃ©sultats</li>
                            </ul>
                        </li>
                    </ol>
    
                    <h3>ğŸ“ Structure du Projet Ã  CrÃ©er</h3>
    
    <pre style="background: #f5f5f5; color: #333; padding: 20px; border-radius: 10px;"><code>logmaster-jee/
    â”œâ”€â”€ pom.xml
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ main/
    â”‚   â”‚   â”œâ”€â”€ java/com/logmaster/
    â”‚   â”‚   â”‚   â”œâ”€â”€ entity/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ User.java
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Order.java
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Product.java
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ OrderStatus.java
    â”‚   â”‚   â”‚   â”œâ”€â”€ dao/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserDAO.java
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderDAO.java
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductDAO.java
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ LogDAO.java  (MongoDB)
    â”‚   â”‚   â”‚   â”œâ”€â”€ service/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderService.java
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LogService.java
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ DashboardService.java
    â”‚   â”‚   â”‚   â”œâ”€â”€ controller/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderServlet.java
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DashboardServlet.java
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ LogServlet.java
    â”‚   â”‚   â”‚   â””â”€â”€ dto/
    â”‚   â”‚   â”‚       â””â”€â”€ DashboardStats.java
    â”‚   â”‚   â”œâ”€â”€ resources/
    â”‚   â”‚   â”‚   â””â”€â”€ META-INF/persistence.xml
    â”‚   â”‚   â””â”€â”€ webapp/
    â”‚   â”‚       â”œâ”€â”€ WEB-INF/
    â”‚   â”‚       â”‚   â”œâ”€â”€ web.xml
    â”‚   â”‚       â”‚   â””â”€â”€ views/
    â”‚   â”‚       â”‚       â”œâ”€â”€ dashboard.jsp
    â”‚   â”‚       â”‚       â”œâ”€â”€ orderList.jsp
    â”‚   â”‚       â”‚       â”œâ”€â”€ orderDetail.jsp
    â”‚   â”‚       â”‚       â”œâ”€â”€ logList.jsp
    â”‚   â”‚       â”‚       â””â”€â”€ error.jsp
    â”‚   â”‚       â”œâ”€â”€ css/style.css
    â”‚   â”‚       â””â”€â”€ index.jsp
    â”‚   â””â”€â”€ test/
    â””â”€â”€ README.md</code></pre>
    
                    <div class="step">
                        <h4>Ã‰tape 1 : Configuration (20 min)</h4>
    
                        <p><strong>1.1 pom.xml - DÃ©pendances Maven</strong></p>
    <pre><code>&lt;project&gt;
        &lt;modelVersion&gt;4.0. 0&lt;/modelVersion&gt;
        &lt;groupId&gt;com.logmaster&lt;/groupId&gt;
        &lt;artifactId&gt;logmaster-jee&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;packaging&gt;war&lt;/packaging&gt;
        
        &lt;properties&gt;
            &lt;maven.compiler.source&gt;11&lt;/maven.compiler.source&gt;
            &lt;maven.compiler.target&gt;11&lt;/maven.compiler. target&gt;
            &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build. sourceEncoding&gt;
        &lt;/properties&gt;
        
        &lt;dependencies&gt;
            &lt;! -- JEE API --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;javax&lt;/groupId&gt;
                &lt;artifactId&gt;javaee-api&lt;/artifactId&gt;
                &lt;version&gt;8.0. 1&lt;/version&gt;
                &lt;scope&gt;provided&lt;/scope&gt;
            &lt;/dependency&gt;
            
            &lt;!-- PostgreSQL JDBC Driver --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.postgresql&lt;/groupId&gt;
                &lt;artifactId&gt;postgresql&lt;/artifactId&gt;
                &lt;version&gt;42.6.0&lt;/version&gt;
            &lt;/dependency&gt;
            
            &lt;!-- MongoDB Java Driver --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
                &lt;artifactId&gt;mongodb-driver-sync&lt;/artifactId&gt;
                &lt;version&gt;4.11.1&lt;/version&gt;
            &lt;/dependency&gt;
            
            &lt;!-- JSTL --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;javax.servlet. jsp.jstl&lt;/groupId&gt;
                &lt;artifactId&gt;jstl-api&lt;/artifactId&gt;
                &lt;version&gt;1.2&lt;/version&gt;
            &lt;/dependency&gt;
            
            &lt;dependency&gt;
                &lt;groupId&gt;org.glassfish.web&lt;/groupId&gt;
                &lt;artifactId&gt;jstl-impl&lt;/artifactId&gt;
                &lt;version&gt;1.2&lt;/version&gt;
            &lt;/dependency&gt;
            
            &lt;! -- JUnit pour les tests --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;junit&lt;/groupId&gt;
                &lt;artifactId&gt;junit&lt;/artifactId&gt;
                &lt;version&gt;4.13.2&lt;/version&gt;
                &lt;scope&gt;test&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
        
        &lt;build&gt;
            &lt;finalName&gt;logmaster&lt;/finalName&gt;
        &lt;/build&gt;
    &lt;/project&gt;</code></pre>
    
                        <p><strong>1.2 persistence.xml</strong></p>
    <pre><code>&lt;?xml version="1. 0" encoding="UTF-8"? &gt;
    &lt;persistence version="2.2" 
                 xmlns="http://xmlns.jcp.org/xml/ns/persistence"&gt;
        
        &lt;persistence-unit name="LogMasterPU" transaction-type="JTA"&gt;
            &lt;provider&gt;org.hibernate.jpa.HibernatePersistenceProvider&lt;/provider&gt;
            &lt;jta-data-source&gt;java:/PostgresDS&lt;/jta-data-source&gt;
            
            &lt;! -- Lister toutes les entitÃ©s --&gt;
            &lt;class&gt;com.logmaster. entity.User&lt;/class&gt;
            &lt;class&gt;com.logmaster.entity.Order&lt;/class&gt;
            &lt;class&gt;com.logmaster.entity.Product&lt;/class&gt;
            
            &lt;properties&gt;
                &lt;property name="hibernate.dialect" 
                         value="org.hibernate.dialect. PostgreSQLDialect"/&gt;
                &lt;property name="hibernate.hbm2ddl.auto" value="update"/&gt;
                &lt;property name="hibernate.show_sql" value="true"/&gt;
                &lt;property name="hibernate.format_sql" value="true"/&gt;
                
                &lt;!-- Cache L2 (optionnel) --&gt;
                &lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;
                &lt;property name="hibernate.cache.region.factory_class" 
                         value="org.hibernate.cache.jcache.JCacheRegionFactory"/&gt;
            &lt;/properties&gt;
        &lt;/persistence-unit&gt;
        
    &lt;/persistence&gt;</code></pre>
    
                        <p><strong>1.3 Installer et configurer les bases de donnÃ©es</strong></p>
    
                        <div class="note">
                            <p><strong>PostgreSQL :</strong></p>
    <pre><code>-- CrÃ©er la base de donnÃ©es
    CREATE DATABASE logmaster_db;
    
    -- CrÃ©er un utilisateur
    CREATE USER logmaster_user WITH PASSWORD 'password123';
    GRANT ALL PRIVILEGES ON DATABASE logmaster_db TO logmaster_user;</code></pre>
    
                            <p><strong>MongoDB :</strong></p>
    <pre><code># DÃ©marrer MongoDB (si installÃ© localement)
    mongod --dbpath /data/db
    
    # Ou utiliser Docker
    docker run -d -p 27017:27017 --name mongodb mongo:latest</code></pre>
                        </div>
                    </div>
    
                    <div class="step">
                        <h4>Ã‰tape 2 : CrÃ©er les EntitÃ©s JPA (30 min)</h4>
                        
                        <p>Utilisez les entitÃ©s prÃ©sentÃ©es prÃ©cÃ©demment dans ce document :</p>
                        <ul>
                            <li><strong>User. java</strong> : ID, name, email, password, orderList</li>
                            <li><strong>Order.java</strong> : ID, user, totalAmount, orderDate, status, shippingAddress</li>
                            <li><strong>Product. java</strong> : ID, name, price, stock, category</li>
                            <li><strong>OrderStatus. java</strong> : Enum (PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED)</li>
                        </ul>
                        
                        <p><strong>Conseil :</strong> Ajoutez les annotations de cache (<span class="inline-code">@Cacheable</span>) et optimisez les relations avec <span class="inline-code">FetchType.LAZY</span>.</p>
                    </div>
    
                    <div class="step">
                        <h4>Ã‰tape 3 : ImplÃ©menter les DAO (40 min)</h4><p><strong>3.1 OrderDAO (PostgreSQL)</strong></p>
                        <p>ImplÃ©mentez toutes les mÃ©thodes CRUD vues prÃ©cÃ©demment :</p>
                        <ul>
                            <li><span class="inline-code">create(Order)</span></li>
                            <li><span class="inline-code">findById(Long)</span></li>
                            <li><span class="inline-code">findByIdWithItems(Long)</span> (avec JOIN FETCH)</li>
                            <li><span class="inline-code">findAll()</span></li>
                            <li><span class="inline-code">findByUserId(Long)</span></li>
                            <li><span class="inline-code">findByStatus(OrderStatus)</span></li>
                            <li><span class="inline-code">findRecent(int limit)</span></li>
                            <li><span class="inline-code">countByStatus(OrderStatus)</span></li>
                        </ul>
    
                        <p><strong>3.2 LogDAO (MongoDB)</strong></p>
                        <p>ImplÃ©mentez les mÃ©thodes pour gÃ©rer les logs :</p>
    
    <pre><code>@Stateless
    public class LogDAO {
        
        private MongoClient mongoClient;
        private MongoDatabase database;
        private MongoCollection&lt;Document&gt; logsCollection;
        
        @PostConstruct
        public void init() {
            mongoClient = MongoClients.create("mongodb://localhost:27017");
            database = mongoClient.getDatabase("logmaster_db");
            logsCollection = database.getCollection("application_logs");
            
            // CrÃ©er des index pour optimiser les requÃªtes
            logsCollection.createIndex(new Document("timestamp", -1));
            logsCollection. createIndex(new Document("level", 1));
            logsCollection.createIndex(new Document("service", 1));
        }
        
        /**
         * Logger la crÃ©ation d'une commande
         */
        public void logOrderCreation(Long orderId, String userEmail, 
                                      BigDecimal amount, String address) {
            Document log = new Document()
                .append("timestamp", new Date())
                .append("level", "INFO")
                .append("event_type", "ORDER_CREATED")
                .append("service", "order-service")
                .append("message", "New order created")
                .append("metadata", new Document()
                    .append("order_id", orderId)
                    .append("user_email", userEmail)
                    .append("amount", amount. doubleValue())
                    .append("shipping_address", address));
            
            logsCollection. insertOne(log);
        }
        
        /**
         * Logger un changement de statut
         */
        public void logStatusChange(Long orderId, OrderStatus oldStatus, 
                                    OrderStatus newStatus) {
            Document log = new Document()
                .append("timestamp", new Date())
                .append("level", "INFO")
                .append("event_type", "ORDER_STATUS_CHANGED")
                .append("service", "order-service")
                .append("message", String.format("Order status changed: %s â†’ %s", 
                                                oldStatus, newStatus))
                .append("metadata", new Document()
                    . append("order_id", orderId)
                    .append("old_status", oldStatus.toString())
                    .append("new_status", newStatus.toString()));
            
            logsCollection.insertOne(log);
        }
        
        /**
         * Logger une annulation
         */
        public void logOrderCancellation(Long orderId, String reason) {
            Document log = new Document()
                .append("timestamp", new Date())
                .append("level", "WARNING")
                .append("event_type", "ORDER_CANCELLED")
                .append("service", "order-service")
                .append("message", "Order cancelled: " + reason)
                .append("metadata", new Document()
                    .append("order_id", orderId)
                    .append("reason", reason));
            
            logsCollection.insertOne(log);
        }
        
        /**
         * Logger une suppression
         */
        public void logOrderDeletion(Long orderId) {
            Document log = new Document()
                .append("timestamp", new Date())
                . append("level", "WARNING")
                .append("event_type", "ORDER_DELETED")
                .append("service", "order-service")
                .append("message", "Order permanently deleted")
                .append("metadata", new Document("order_id", orderId));
            
            logsCollection.insertOne(log);
        }
        
        /**
         * Logger une erreur
         */
        public void logError(String service, String message, String stackTrace) {
            Document log = new Document()
                .append("timestamp", new Date())
                . append("level", "ERROR")
                .append("event_type", "SYSTEM_ERROR")
                .append("service", service)
                .append("message", message)
                .append("stack_trace", stackTrace);
            
            logsCollection.insertOne(log);
        }
        
        /**
         * RÃ©cupÃ©rer les logs rÃ©cents
         */
        public List&lt;Document&gt; getRecentLogs(int limit) {
            return logsCollection.find()
                .sort(descending("timestamp"))
                .limit(limit)
                .into(new ArrayList&lt;&gt;());
        }
        
        /**
         * RÃ©cupÃ©rer les logs par niveau
         */
        public List&lt;Document&gt; getLogsByLevel(String level, int limit) {
            return logsCollection. find(eq("level", level))
                . sort(descending("timestamp"))
                .limit(limit)
                .into(new ArrayList&lt;&gt;());
        }
        
        /**
         * RÃ©cupÃ©rer les logs par service
         */
        public List&lt;Document&gt; getLogsByService(String service, int limit) {
            return logsCollection. find(eq("service", service))
                .sort(descending("timestamp"))
                .limit(limit)
                .into(new ArrayList&lt;&gt;());
        }
        
        /**
         * Compter les logs par niveau
         */
        public long countByLevel(String level) {
            return logsCollection.countDocuments(eq("level", level));
        }
        
        /**
         * Compter les erreurs
         */
        public long countErrorLogs() {
            return countByLevel("ERROR");
        }
        
        /**
         * Compter les warnings
         */
        public long countWarningLogs() {
            return countByLevel("WARNING");
        }
        
        /**
         * Top utilisateurs actifs (par event_type ORDER_CREATED)
         */
        public List&lt;Document&gt; getTopActiveUsers(int limit) {
            List&lt;Document&gt; pipeline = Arrays.asList(
                // Filtrer seulement les crÃ©ations de commandes
                new Document("$match", new Document("event_type", "ORDER_CREATED")),
                
                // Grouper par email utilisateur
                new Document("$group", new Document()
                    .append("_id", "$metadata.user_email")
                    . append("order_count", new Document("$sum", 1))),
                
                // Trier par nombre de commandes dÃ©croissant
                new Document("$sort", new Document("order_count", -1)),
                
                // Limiter
                new Document("$limit", limit)
            );
            
            return logsCollection.aggregate(pipeline). into(new ArrayList&lt;&gt;());
        }
        
        /**
         * Statistiques des Ã©vÃ©nements par type
         */
        public List&lt;Document&gt; getEventStatistics() {
            List&lt;Document&gt; pipeline = Arrays.asList(
                // Grouper par event_type
                new Document("$group", new Document()
                    . append("_id", "$event_type")
                    .append("count", new Document("$sum", 1))),
                
                // Trier par count dÃ©croissant
                new Document("$sort", new Document("count", -1))
            );
            
            return logsCollection.aggregate(pipeline). into(new ArrayList&lt;&gt;());
        }
        
        /**
         * Erreurs des derniÃ¨res 24h par service
         */
        public List&lt;Document&gt; getErrorsByServiceLast24h() {
            Date twentyFourHoursAgo = new Date(System.currentTimeMillis() - 86400000);
            
            List&lt;Document&gt; pipeline = Arrays.asList(
                // Filtrer erreurs des derniÃ¨res 24h
                new Document("$match", new Document()
                    .append("level", "ERROR")
                    .append("timestamp", new Document("$gte", twentyFourHoursAgo))),
                
                // Grouper par service
                new Document("$group", new Document()
                    .append("_id", "$service")
                    .append("error_count", new Document("$sum", 1))
                    .append("last_error", new Document("$max", "$timestamp"))),
                
                // Trier
                new Document("$sort", new Document("error_count", -1))
            );
            
            return logsCollection.aggregate(pipeline).into(new ArrayList&lt;&gt;());
        }
        
        /**
         * Distribution des logs par heure (derniÃ¨res 24h)
         */
        public List&lt;Document&gt; getLogsDistributionByHour() {
            Date twentyFourHoursAgo = new Date(System.currentTimeMillis() - 86400000);
            
            List&lt;Document&gt; pipeline = Arrays.asList(
                // Filtrer derniÃ¨res 24h
                new Document("$match", new Document("timestamp", 
                    new Document("$gte", twentyFourHoursAgo))),
                
                // Ajouter un champ "hour" extrait du timestamp
                new Document("$addFields", new Document("hour", 
                    new Document("$hour", "$timestamp"))),
                
                // Grouper par heure et niveau
                new Document("$group", new Document()
                    .append("_id", new Document()
                        .append("hour", "$hour")
                        .append("level", "$level"))
                    . append("count", new Document("$sum", 1))),
                
                // Trier
                new Document("$sort", new Document("_id.hour", 1))
            );
            
            return logsCollection.aggregate(pipeline).into(new ArrayList&lt;&gt;());
        }
        
        @PreDestroy
        public void cleanup() {
            if (mongoClient != null) {
                mongoClient.close();
            }
        }
    }</code></pre>
                    </div>
    
                    <div class="step">
                        <h4>Ã‰tape 4 : ImplÃ©menter les Services (50 min)</h4>
                        
                        <p><strong>4.1 OrderService</strong> : Utilisez l'implÃ©mentation complÃ¨te vue prÃ©cÃ©demment (avec gestion des transactions JTA).</p>
                        
                        <p><strong>4.2 DashboardService</strong> : Service pour agrÃ©ger les statistiques</p>
    
    <pre><code>@Stateless
    public class DashboardService {
        
        @EJB
        private OrderDAO orderDAO;
        
        @EJB
        private LogDAO logDAO;
        
        /**
         * Obtenir toutes les statistiques du dashboard
         */
        public DashboardStats getDashboardStats() {
            DashboardStats stats = new DashboardStats();
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // STATISTIQUES POSTGRESQL
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            stats.setPendingOrders(orderDAO.countByStatus(OrderStatus.PENDING));
            stats.setConfirmedOrders(orderDAO.countByStatus(OrderStatus.CONFIRMED));
            stats.setProcessingOrders(orderDAO.countByStatus(OrderStatus.PROCESSING));
            stats.setShippedOrders(orderDAO.countByStatus(OrderStatus.SHIPPED));
            stats.setDeliveredOrders(orderDAO.countByStatus(OrderStatus.DELIVERED));
            stats.setCancelledOrders(orderDAO.countByStatus(OrderStatus.CANCELLED));
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // STATISTIQUES MONGODB
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            stats.setErrorCount(logDAO.countErrorLogs());
            stats.setWarningCount(logDAO.countWarningLogs());
            stats.setTopActiveUsers(logDAO.getTopActiveUsers(5));
            stats.setEventStatistics(logDAO.getEventStatistics());
            stats.setErrorsByService(logDAO.getErrorsByServiceLast24h());
            stats.setRecentLogs(logDAO.getRecentLogs(10));
            
            return stats;
        }
    }
    
    /**
     * DTO pour les statistiques du dashboard
     */
    public class DashboardStats {
        
        // Stats PostgreSQL
        private long pendingOrders;
        private long confirmedOrders;
        private long processingOrders;
        private long shippedOrders;
        private long deliveredOrders;
        private long cancelledOrders;
        
        // Stats MongoDB
        private long errorCount;
        private long warningCount;
        private List&lt;Document&gt; topActiveUsers;
        private List&lt;Document&gt; eventStatistics;
        private List&lt;Document&gt; errorsByService;
        private List&lt;Document&gt; recentLogs;
        
        // Constructeur
        public DashboardStats() {}
        
        // MÃ©thode utilitaire : Total des commandes
        public long getTotalOrders() {
            return pendingOrders + confirmedOrders + processingOrders + 
                   shippedOrders + deliveredOrders + cancelledOrders;
        }
        
        // MÃ©thode utilitaire : Taux de succÃ¨s (livrÃ©es / total)
        public double getSuccessRate() {
            long total = getTotalOrders();
            if (total == 0) return 0.0;
            return (double) deliveredOrders / total * 100. 0;
        }
        
        // MÃ©thode utilitaire : Taux d'annulation
        public double getCancellationRate() {
            long total = getTotalOrders();
            if (total == 0) return 0.0;
            return (double) cancelledOrders / total * 100.0;
        }
        
        // Getters et Setters (tous)
        public long getPendingOrders() { return pendingOrders; }
        public void setPendingOrders(long pendingOrders) { this.pendingOrders = pendingOrders; }
        
        public long getConfirmedOrders() { return confirmedOrders; }
        public void setConfirmedOrders(long confirmedOrders) { this.confirmedOrders = confirmedOrders; }
        
        public long getProcessingOrders() { return processingOrders; }
        public void setProcessingOrders(long processingOrders) { this.processingOrders = processingOrders; }
        
        public long getShippedOrders() { return shippedOrders; }
        public void setShippedOrders(long shippedOrders) { this.shippedOrders = shippedOrders; }
        
        public long getDeliveredOrders() { return deliveredOrders; }
        public void setDeliveredOrders(long deliveredOrders) { this.deliveredOrders = deliveredOrders; }
        
        public long getCancelledOrders() { return cancelledOrders; }
        public void setCancelledOrders(long cancelledOrders) { this.cancelledOrders = cancelledOrders; }
        
        public long getErrorCount() { return errorCount; }
        public void setErrorCount(long errorCount) { this.errorCount = errorCount; }
        
        public long getWarningCount() { return warningCount; }
        public void setWarningCount(long warningCount) { this.warningCount = warningCount; }
        
        public List&lt;Document&gt; getTopActiveUsers() { return topActiveUsers; }
        public void setTopActiveUsers(List&lt;Document&gt; topActiveUsers) { this.topActiveUsers = topActiveUsers; }
        
        public List&lt;Document&gt; getEventStatistics() { return eventStatistics; }
        public void setEventStatistics(List&lt;Document&gt; eventStatistics) { this.eventStatistics = eventStatistics; }
        
        public List&lt;Document&gt; getErrorsByService() { return errorsByService; }
        public void setErrorsByService(List&lt;Document&gt; errorsByService) { this.errorsByService = errorsByService; }
        
        public List&lt;Document&gt; getRecentLogs() { return recentLogs; }
        public void setRecentLogs(List&lt;Document&gt; recentLogs) { this.recentLogs = recentLogs; }
    }</code></pre>
                    </div>
    
                    <div class="step">
                        <h4>Ã‰tape 5 : ImplÃ©menter les Servlets (40 min)</h4>
                        
                        <p><strong>5.1 DashboardServlet</strong> : Servlet pour afficher le dashboard</p>
    
    <pre><code>@WebServlet("/dashboard")
    public class DashboardServlet extends HttpServlet {
        
        @EJB
        private DashboardService dashboardService;
        
        @Override
        protected void doGet(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            try {
                // RÃ©cupÃ©rer toutes les statistiques
                DashboardStats stats = dashboardService. getDashboardStats();
                
                // Passer au JSP
                req.setAttribute("stats", stats);
                
                // Forward vers la vue
                req.getRequestDispatcher("/WEB-INF/views/dashboard.jsp").forward(req, resp);
                
            } catch (Exception e) {
                e.printStackTrace();
                req.setAttribute("error", "Erreur lors du chargement du dashboard: " + e.getMessage());
                req.getRequestDispatcher("/WEB-INF/views/error.jsp").forward(req, resp);
            }
        }
    }</code></pre>
    
                        <p><strong>5.2 OrderServlet</strong> : Utilisez l'implÃ©mentation complÃ¨te vue prÃ©cÃ©demment. </p>
                        
                        <p><strong>5.3 LogServlet</strong> : Servlet pour consulter les logs</p>
    
    <pre><code>@WebServlet("/logs")
    public class LogServlet extends HttpServlet {
        
        @EJB
        private LogDAO logDAO;
        
        @Override
        protected void doGet(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            String action = req.getParameter("action");
            
            if (action == null || action.isEmpty()) {
                action = "list";
            }
            
            try {
                switch (action) {
                    case "list":
                        listLogs(req, resp);
                        break;
                        
                    case "filter":
                        filterLogs(req, resp);
                        break;
                        
                    default:
                        resp.sendError(HttpServletResponse.SC_NOT_FOUND);
                }
                
            } catch (Exception e) {
                e.printStackTrace();
                req.setAttribute("error", e.getMessage());
                req.getRequestDispatcher("/WEB-INF/views/error.jsp"). forward(req, resp);
            }
        }
        
        private void listLogs(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            // ParamÃ¨tre limit (par dÃ©faut 50)
            String limitParam = req.getParameter("limit");
            int limit = (limitParam != null) ? Integer. parseInt(limitParam) : 50;
            
            // RÃ©cupÃ©rer les logs rÃ©cents
            List<Document> logs = logDAO.getRecentLogs(limit);
            
            req.setAttribute("logs", logs);
            req.getRequestDispatcher("/WEB-INF/views/logList.jsp").forward(req, resp);
        }
        
        private void filterLogs(HttpServletRequest req, HttpServletResponse resp) 
                throws ServletException, IOException {
            
            String level = req.getParameter("level");
            String service = req.getParameter("service");
            String limitParam = req.getParameter("limit");
            int limit = (limitParam != null) ? Integer.parseInt(limitParam) : 50;
            
            List<Document> logs;
            
            if (level != null && ! level.isEmpty()) {
                logs = logDAO.getLogsByLevel(level, limit);
                req.setAttribute("filterType", "niveau");
                req.setAttribute("filterValue", level);
            } else if (service != null && !service.isEmpty()) {
                logs = logDAO. getLogsByService(service, limit);
                req.setAttribute("filterType", "service");
                req.setAttribute("filterValue", service);
            } else {
                logs = logDAO.getRecentLogs(limit);
            }
            
            req.setAttribute("logs", logs);
            req.getRequestDispatcher("/WEB-INF/views/logList.jsp").forward(req, resp);
        }
    }</code></pre>
                    </div>
    
                    <div class="step">
                        <h4>Ã‰tape 6 : CrÃ©er les Vues JSP (60 min)</h4>
                        
                        <p><strong>6.1 dashboard.jsp</strong> : Vue principale du dashboard</p>
    
    <pre><code>&lt;%@ page contentType="text/html;charset=UTF-8" language="java" %&gt;
    &lt;%@ taglib prefix="c" uri="http://java. sun.com/jsp/jstl/core" %&gt;
    &lt;%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %&gt;
    
    &lt;! DOCTYPE html&gt;
    &lt;html lang="fr"&gt;
    &lt;head&gt;
        &lt;meta charset="UTF-8"&gt;
        &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
        &lt;title&gt;LogMaster Dashboard&lt;/title&gt;
        &lt;style&gt;
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Segoe UI', sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 20px;
            }
            
            .container {
                max-width: 1400px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                padding: 30px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            }
            
            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 40px;
                padding-bottom: 20px;
                border-bottom: 3px solid #667eea;
            }
            
            h1 {
                color: #333;
                font-size: 2.5em;
            }
            
            .nav-links {
                display: flex;
                gap: 15px;
            }
            
            .nav-links a {
                padding: 10px 20px;
                background: #667eea;
                color: white;
                text-decoration: none;
                border-radius: 5px;
                transition: all 0.3s;
            }
            
            . nav-links a:hover {
                background: #5568d3;
                transform: translateY(-2px);
            }
            
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
            }
            
            .stat-card {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px;
                border-radius: 10px;
                text-align: center;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                transition: transform 0.3s;
            }
            
            .stat-card:hover {
                transform: translateY(-5px);
            }
            
            .stat-card h3 {
                font-size: 2. 5em;
                margin-bottom: 10px;
            }
            
            .stat-card p {
                opacity: 0.9;
                font-size: 1.1em;
            }
            
            .section {
                margin: 40px 0;
            }
            
            .section h2 {
                color: #667eea;
                font-size: 1.8em;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #e0e0e0;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            th {
                background: #667eea;
                color: white;
                padding: 15px;
                text-align: left;
            }
            
            td {
                padding: 12px 15px;
                border-bottom: 1px solid #ddd;
            }
            
            tr:hover {
                background: #f5f5f5;
            }
            
            .log-level {
                padding: 5px 12px;
                border-radius: 15px;
                font-weight: bold;
                font-size: 12px;
            }
            
            .log-info { background: #d1ecf1; color: #0c5460; }
            . log-warning { background: #fff3cd; color: #856404; }
            .log-error { background: #f8d7da; color: #721c24; }
            
            .empty-state {
                text-align: center;
                padding: 40px;
                color: #999;
            }
        &lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="container"&gt;
            &lt;header&gt;
                &lt;h1&gt;ğŸš€ LogMaster Dashboard&lt;/h1&gt;
                &lt;div class="nav-links"&gt;
                    &lt;a href="${pageContext.request.contextPath}/dashboard"&gt;ğŸ  Dashboard&lt;/a&gt;
                    &lt;a href="${pageContext.request.contextPath}/orders? action=list"&gt;ğŸ“¦ Commandes&lt;/a&gt;
                    &lt;a href="${pageContext.request.contextPath}/logs?action=list"&gt;ğŸ“‹ Logs&lt;/a&gt;
                &lt;/div&gt;
            &lt;/header&gt;
            
            &lt;! -- STATISTIQUES COMMANDES --&gt;
            &lt;div class="section"&gt;
                &lt;h2&gt;ğŸ“Š Statistiques des Commandes (PostgreSQL)&lt;/h2&gt;
                
                &lt;div class="stats-grid"&gt;
                    &lt;div class="stat-card"&gt;
                        &lt;h3&gt;${stats.totalOrders}&lt;/h3&gt;
                        &lt;p&gt;Total Commandes&lt;/p&gt;
                    &lt;/div&gt;
                    
                    &lt;div class="stat-card"&gt;
                        &lt;h3&gt;${stats.pendingOrders}&lt;/h3&gt;
                        &lt;p&gt;â³ En Attente&lt;/p&gt;
                    &lt;/div&gt;
                    
                    &lt;div class="stat-card"&gt;
                        &lt;h3&gt;${stats. confirmedOrders}&lt;/h3&gt;
                        &lt;p&gt;âœ… ConfirmÃ©es&lt;/p&gt;
                    &lt;/div&gt;
                    
                    &lt;div class="stat-card"&gt;
                        &lt;h3&gt;${stats.shippedOrders}&lt;/h3&gt;
                        &lt;p&gt;ğŸšš ExpÃ©diÃ©es&lt;/p&gt;
                    &lt;/div&gt;
                    
                    &lt;div class="stat-card"&gt;
                        &lt;h3&gt;${stats.deliveredOrders}&lt;/h3&gt;
                        &lt;p&gt;ğŸ‰ LivrÃ©es&lt;/p&gt;
                    &lt;/div&gt;
                    
                    &lt;div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);"&gt;
                        &lt;h3&gt;${stats.cancelledOrders}&lt;/h3&gt;
                        &lt;p&gt;âŒ AnnulÃ©es&lt;/p&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="stats-grid"&gt;
                    &lt;div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%);"&gt;
                        &lt;h3&gt;&lt;fmt:formatNumber value="${stats.successRate}" maxFractionDigits="1"/&gt;%&lt;/h3&gt;
                        &lt;p&gt;Taux de SuccÃ¨s&lt;/p&gt;
                    &lt;/div&gt;
                    
                    &lt;div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);"&gt;
                        &lt;h3&gt;&lt;fmt:formatNumber value="${stats.cancellationRate}" maxFractionDigits="1"/&gt;%&lt;/h3&gt;
                        &lt;p&gt;Taux d'Annulation&lt;/p&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;!-- STATISTIQUES LOGS --&gt;
            &lt;div class="section"&gt;
                &lt;h2&gt;ğŸ“ˆ Statistiques des Logs (MongoDB)&lt;/h2&gt;
                
                &lt;div class="stats-grid"&gt;
                    &lt;div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);"&gt;
                        &lt;h3&gt;${stats.errorCount}&lt;/h3&gt;
                        &lt;p&gt;âŒ Erreurs&lt;/p&gt;
                    &lt;/div&gt;
                    
                    &lt;div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);"&gt;
                        &lt;h3&gt;${stats.warningCount}&lt;/h3&gt;
                        &lt;p&gt;âš ï¸ Avertissements&lt;/p&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;!-- TOP UTILISATEURS ACTIFS --&gt;
            &lt;div class="section"&gt;
                &lt;h2&gt;ğŸ‘¥ Top 5 Utilisateurs Actifs (MongoDB Aggregation)&lt;/h2&gt;
                
                &lt;c:choose&gt;
                    &lt;c:when test="${not empty stats.topActiveUsers}"&gt;
                        &lt;table&gt;
                            &lt;thead&gt;
                                &lt;tr&gt;
                                    &lt;th&gt;Position&lt;/th&gt;
                                    &lt;th&gt;Utilisateur&lt;/th&gt;
                                    &lt;th&gt;Nombre de Commandes&lt;/th&gt;
                                &lt;/tr&gt;
                            &lt;/thead&gt;
                            &lt;tbody&gt;
                                &lt;c:forEach var="user" items="${stats.topActiveUsers}" varStatus="status"&gt;
                                    &lt;tr&gt;
                                        &lt;td&gt;&lt;strong&gt;#${status.index + 1}&lt;/strong&gt;&lt;/td&gt;
                                        &lt;td&gt;${user._id}&lt;/td&gt;
                                        &lt;td&gt;${user.order_count} commandes&lt;/td&gt;
                                    &lt;/tr&gt;
                                &lt;/c:forEach&gt;
                            &lt;/tbody&gt;
                        &lt;/table&gt;
                    &lt;/c:when&gt;
                    &lt;c:otherwise&gt;
                        &lt;div class="empty-state"&gt;Aucune donnÃ©e disponible&lt;/div&gt;
                    &lt;/c:otherwise&gt;
                &lt;/c:choose&gt;
            &lt;/div&gt;
            
            &lt;!-- STATISTIQUES Ã‰VÃ‰NEMENTS --&gt;
            &lt;div class="section"&gt;
                &lt;h2&gt;ğŸ“Š RÃ©partition des Ã‰vÃ©nements (MongoDB Aggregation)&lt;/h2&gt;
                
                &lt;c:choose&gt;
                    &lt;c:when test="${not empty stats.eventStatistics}"&gt;
                        &lt;table&gt;
                            &lt;thead&gt;
                                &lt;tr&gt;
                                    &lt;th&gt;Type d'Ã‰vÃ©nement&lt;/th&gt;
                                    &lt;th&gt;Nombre&lt;/th&gt;
                                &lt;/tr&gt;
                            &lt;/thead&gt;
                            &lt;tbody&gt;
                                &lt;c:forEach var="event" items="${stats.eventStatistics}"&gt;
                                    &lt;tr&gt;
                                        &lt;td&gt;${event._id}&lt;/td&gt;
                                        &lt;td&gt;&lt;strong&gt;${event.count}&lt;/strong&gt;&lt;/td&gt;
                                    &lt;/tr&gt;
                                &lt;/c:forEach&gt;
                            &lt;/tbody&gt;
                        &lt;/table&gt;
                    &lt;/c:when&gt;
                    &lt;c:otherwise&gt;
                        &lt;div class="empty-state"&gt;Aucune donnÃ©e disponible&lt;/div&gt;
                    &lt;/c:otherwise&gt;
                &lt;/c:choose&gt;
            &lt;/div&gt;
            
            &lt;!-- LOGS RÃ‰CENTS --&gt;
            &lt;div class="section"&gt;
                &lt;h2&gt;ğŸ“‹ Logs RÃ©cents&lt;/h2&gt;
                
                &lt;c:choose&gt;
                    &lt;c:when test="${not empty stats.recentLogs}"&gt;
                        &lt;table&gt;
                            &lt;thead&gt;
                                &lt;tr&gt;
                                    &lt;th&gt;Timestamp&lt;/th&gt;
                                    &lt;th&gt;Niveau&lt;/th&gt;
                                    &lt;th&gt;Service&lt;/th&gt;
                                    &lt;th&gt;Message&lt;/th&gt;
                                &lt;/tr&gt;
                            &lt;/thead&gt;
                            &lt;tbody&gt;
                                &lt;c:forEach var="log" items="${stats.recentLogs}"&gt;
                                    &lt;tr&gt;
                                        &lt;td&gt;
                                            &lt;fmt:formatDate value="${log.timestamp}" 
                                                           pattern="dd/MM/yyyy HH:mm:ss"/&gt;
                                        &lt;/td&gt;
                                        &lt;td&gt;
                                            &lt;c:choose&gt;
                                                &lt;c:when test="${log.level == 'ERROR'}"&gt;
                                                    &lt;span class="log-level log-error"&gt;ERROR&lt;/span&gt;
                                                &lt;/c:when&gt;
                                                &lt;c:when test="${log.level == 'WARNING'}"&gt;
                                                    &lt;span class="log-level log-warning"&gt;WARNING&lt;/span&gt;
                                                &lt;/c:when&gt;
                                                &lt;c:otherwise&gt;
                                                    &lt;span class="log-level log-info"&gt;INFO&lt;/span&gt;
                                                &lt;/c:otherwise&gt;
                                            &lt;/c:choose&gt;
                                        &lt;/td&gt;
                                        &lt;td&gt;${log.service}&lt;/td&gt;
                                        &lt;td&gt;${log.message}&lt;/td&gt;
                                    &lt;/tr&gt;
                                &lt;/c:forEach&gt;
                            &lt;/tbody&gt;
                        &lt;/table&gt;
                        
                        &lt;div style="text-align: center; margin-top: 20px;"&gt;
                            &lt;a href="${pageContext.request.contextPath}/logs? action=list" 
                               style="padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 5px;"&gt;
                                Voir tous les logs â†’
                            &lt;/a&gt;
                        &lt;/div&gt;
                    &lt;/c:when&gt;
                    &lt;c:otherwise&gt;
                        &lt;div class="empty-state"&gt;Aucun log disponible&lt;/div&gt;
                    &lt;/c:otherwise&gt;
                &lt;/c:choose&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
    &lt;/html&gt;</code></pre>
    
                        <p><strong>6. 2 orderList.jsp et orderDetail.jsp</strong> : Utilisez les implÃ©mentations complÃ¨tes vues prÃ©cÃ©demment. </p>
                        
                        <p><strong>6.3 logList.jsp</strong> : Vue pour afficher la liste des logs avec filtres</p>
    <pre><code>&lt;! -- Structure similaire Ã  orderList.jsp avec filtres par niveau/service --&gt;
    &lt;! -- Ajoutez des formulaires de filtre et utilisez &lt;c:forEach&gt; pour parcourir les logs --&gt;</code></pre>
                    </div>
    
                    <div class="step">
                        <h4>Ã‰tape 7 : Tester l'Application (30 min)</h4>
                        
                        <div class="tip-box">
                            <h4>ğŸ§ª ScÃ©narios de Test</h4>
                            <ol>
                                <li><strong>Test de crÃ©ation de commande</strong>
                                    <ul>
                                        <li>CrÃ©er une commande via le formulaire</li>
                                        <li>VÃ©rifier qu'elle apparaÃ®t dans PostgreSQL (table orders)</li>
                                        <li>VÃ©rifier qu'un log existe dans MongoDB (collection application_logs)</li>
                                        <li>VÃ©rifier qu'elle apparaÃ®t sur le dashboard</li>
                                    </ul>
                                </li>
                                <li><strong>Test de changement de statut</strong>
                                    <ul>
                                        <li>Passer une commande de PENDING Ã  CONFIRMED</li>
                                        <li>VÃ©rifier que le log STATUS_CHANGED est crÃ©Ã© dans MongoDB</li>
                                    </ul>
                                </li>
                                <li><strong>Test d'annulation</strong>
                                    <ul>
                                        <li>Annuler une commande avec une raison</li>
                                        <li>VÃ©rifier que le statut change en PostgreSQL</li>
                                        <li>VÃ©rifier que le log CANCELLED existe dans MongoDB</li>
                                    </ul>
                                </li>
                                <li><strong>Test du dashboard</strong>
                                    <ul>
                                        <li>CrÃ©er plusieurs commandes avec diffÃ©rents statuts</li>
                                        <li>RafraÃ®chir le dashboard</li>
                                        <li>VÃ©rifier que les compteurs sont corrects</li>
                                        <li>VÃ©rifier que les agrÃ©gations MongoDB fonctionnent (top users, event stats)</li>
                                    </ul>
                                </li>
                                <li><strong>Test de cohÃ©rence (Transaction)</strong>
                                    <ul>
                                        <li>ArrÃªter MongoDB</li>
                                        <li>Essayer de crÃ©er une commande</li>
                                        <li>VÃ©rifier que la commande N'est PAS crÃ©Ã©e en PostgreSQL (rollback)</li>
                                        <li>RedÃ©marrer MongoDB et vÃ©rifier que tout fonctionne Ã  nouveau</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                    </div>
    
                    <h3>ğŸ Extensions Possibles (Bonus)</h3>
                    
                    <div class="example-box">
                        <h4>Pour aller plus loin</h4>
                        <ul>
                            <li><strong>Authentification</strong> : Ajouter un systÃ¨me de login (users, roles, sessions)</li>
                            <li><strong>API REST</strong> : Exposer les fonctionnalitÃ©s via JAX-RS pour une application mobile</li>
                            <li><strong>Graphiques</strong> : IntÃ©grer Chart.js pour visualiser les statistiques</li>
                            <li><strong>WebSockets</strong> : Mise Ã  jour en temps rÃ©el du dashboard</li>
                            <li><strong>Elasticsearch</strong> : Ajouter une recherche full-text dans les logs</li>
                            <li><strong>Redis</strong> : Ajouter un cache pour les requÃªtes frÃ©quentes</li>
                            <li><strong>Docker</strong> : Containeriser l'application (PostgreSQL + MongoDB + WildFly)</li>
                            <li><strong>Tests unitaires</strong> : JUnit + Mockito pour tester les services</li>
                            <li><strong>CI/CD</strong> : Pipeline Jenkins/GitHub Actions</li>
                        </ul>
                    </div>
    
                </div>
    
                <!-- ============================================ -->
                <!-- QUIZ FINAL -->
                <!-- ============================================ -->
                <div id="quiz" class="quiz">
                    <h2>ğŸ“ Quiz de RÃ©vision Final</h2>
                    
                    <p style="margin-bottom: 20px; font-size: 1.1em;">Testez vos connaissances sur l'ensemble du cours !</p>
                    
                    <div class="quiz-question">
                        <h4>Question 1 : Quelle annotation JPA permet d'Ã©viter le problÃ¨me N+1 ?</h4>
                        <div class="quiz-options">
                            <label><input type="radio" name="q1" value="a"> A) @OneToMany</label>
                            <label><input type="radio" name="q1" value="b"> B) JOIN FETCH en JPQL</label>
                            <label><input type="radio" name="q1" value="c"> C) @LazyLoad</label>
                            <label><input type="radio" name="q1" value="d"> D) @Cache</label>
                        </div>
                        <p style="color: green; margin-top: 10px;"><strong>RÃ©ponse : B</strong> - JOIN FETCH charge les relations en une seule requÃªte SQL avec jointure, Ã©vitant ainsi le problÃ¨me N+1 (1 requÃªte parent + N requÃªtes enfants).</p>
                    </div>
    
                    <div class="quiz-question">
                        <h4>Question 2 : Quelle stratÃ©gie d'hÃ©ritage JPA offre les meilleures performances ?</h4>
                        <div class="quiz-options">
                            <label><input type="radio" name="q2" value="a"> A) JOINED</label>
                            <label><input type="radio" name="q2" value="b"> B) TABLE_PER_CLASS</label>
                            <label><input type="radio" name="q2" value="c"> C) SINGLE_TABLE</label>
                            <label><input type="radio" name="q2" value="d"> D) MAPPED_SUPERCLASS</label>
                        </div>
                        <p style="color: green; margin-top: 10px;"><strong>RÃ©ponse : C</strong> - SINGLE_TABLE stocke toute la hiÃ©rarchie dans une table avec un discriminateur, Ã©vitant les jointures coÃ»teuses.</p>
                    </div>
    
                    <div class="quiz-question">
                        <h4>Question 3 : MongoDB utilise quel format pour stocker les documents ?</h4>
                        <div class="quiz-options">
                            <label><input type="radio" name="q3" value="a"> A) XML</label>
                            <label><input type="radio" name="q3" value="b"> B) BSON (Binary JSON)</label>
                            <label><input type="radio" name="q3" value="c"> C) CSV</label>
                            <label><input type="radio" name="q3" value="d"> D) Protocol Buffers</label>
                        </div>
                        <p style="color: green; margin-top: 10px;"><strong>RÃ©ponse : B</strong> - BSON (Binary JSON) est le format binaire optimisÃ© utilisÃ© par MongoDB, plus rapide que JSON texte.</p>
                    </div>
    
                    <div class="quiz-question">
                        <h4>Question 4 : Quelle opÃ©ration MongoDB permet de faire des agrÃ©gations complexes ?</h4>
                        <div class="quiz-options">
                            <label><input type="radio" name="q4" value="a"> A) find()</label>
                            <label><input type="radio" name="q4" value="b"> B) aggregate()</label>
                            <label><input type="radio" name="q4" value="c"> C) query()</label>
                            <label><input type="radio" name="q4" value="d"> D) mapReduce()</label>
                        </div>
                        <p style="color: green; margin-top: 10px;"><strong>RÃ©ponse : B</strong> - aggregate() avec un pipeline ($match, $group, $sort, etc.) permet des transformations de donnÃ©es complexes.</p>
                    </div>
    
                    <div class="quiz-question">
                        <h4>Question 5 : Quelle annotation EJB garantit une transaction ? </h4>
                        <div class="quiz-options">
                            <label><input type="radio" name="q5" value="a"> A) @Transactional</label>
                            <label><input type="radio" name="q5" value="b"> B) @TransactionAttribute</label>
                            <label><input type="radio" name="q5" value="c"> C) @JTA</label>
                            <label><input type="radio" name="q5" value="d"> D) @Atomic</label>
                        </div>
                        <p style="color: green; margin-top: 10px;"><strong>RÃ©ponse : B</strong> - @TransactionAttribute(REQUIRED) sur une mÃ©thode EJB garantit qu'elle s'exÃ©cute dans une transaction JTA. </p>
                    </div>
    
                    <div class="quiz-question">
                        <h4>Question 6 : Quand utiliser Embedding vs Referencing en MongoDB ?</h4>
                        <div class="quiz-options">
                            <label><input type="radio" name="q6" value="a"> A) Toujours embedding pour la performance</label>
                            <label><input type="radio" name="q6" value="b"> B) Embedding si One-to-Few et donnÃ©es toujours accÃ©dÃ©es ensemble, Referencing si Many-to-Many ou donnÃ©es volumineuses</label>
                            <label><input type="radio" name="q6" value="c"> C) Toujours referencing pour Ã©viter la duplication</label>
                            <label><input type="radio" name="q6" value="d"> D) Ã‡a ne fait aucune diffÃ©rence</label>
                        </div>
                        <p style="color: green; margin-top: 10px;"><strong>RÃ©ponse : B</strong> - Le choix dÃ©pend du cas d'usage : embedding pour performance et cohÃ©rence atomique (One-to-Few), referencing pour Ã©viter duplication et limitation de taille (Many-to-Many, donnÃ©es volumineuses).</p>
                    </div>
    
                    <div class="quiz-question">
                        <h4>Question 7 : Quel pattern permet de gÃ©rer les transactions distribuÃ©es sans XA ?</h4>
                        <div class="quiz-options">
                            <label><input type="radio" name="q7" value="a"> A) Two-Phase Commit</label>
                            <label><input type="radio" name="q7" value="b"> B) Saga Pattern</label>
                            <label><input type="radio" name="q7" value="c"> C) Factory Pattern</label>
                            <label><input type="radio" name="q7" value="d"> D) Singleton Pattern</label>
                        </div>
                        <p style="color: green; margin-top: 10px;"><strong>RÃ©ponse : B</strong> - Saga Pattern dÃ©compose une transaction distribuÃ©e en transactions locales avec compensations en cas d'Ã©chec, idÃ©al quand XA n'est pas supportÃ© (comme MongoDB).</p>
                    </div>
    
                    <div class="quiz-question">
                        <h4>Question 8 : Quelle balise JSTL permet de boucler sur une collection ?</h4>
                        <div class="quiz-options">
                            <label><input type="radio" name="q8" value="a"> A) &lt;c:loop&gt;</label>
                            <label><input type="radio" name="q8" value="b"> B) &lt;c:forEach&gt;</label>
                            <label><input type="radio" name="q8" value="c"> C) &lt;c:iterate&gt;</label>
                            <label><input type="radio" name="q8" value="d"> D) &lt;c:while&gt;</label>
                        </div>
                        <p style="color: green; margin-top: 10px;"><strong>RÃ©ponse : B</strong> - &lt;c:forEach var="item" items="${collection}"&gt; est la balise JSTL standard pour itÃ©rer sur des collections.</p>
                    </div>
    
                    <div class="quiz-question">
                        <h4>Question 9 : Quel est l'avantage principal de Polyglot Persistence ?</h4>
                        <div class="quiz-options">
                            <label><input type="radio" name="q9" value="a"> A) SimplicitÃ© de dÃ©veloppement</label>
                            <label><input type="radio" name="q9" value="b"> B) Utiliser le bon outil pour chaque besoin (SQL pour ACID, NoSQL pour flexibilitÃ©/volume)</label>
                            <label><input type="radio" name="q9" value="c"> C) Moins de code Ã  Ã©crire</label>
                            <label><input type="radio" name="q9" value="d"> D) CoÃ»t rÃ©duit</label>
                        </div>
                        <p style="color: green; margin-top: 10px;"><strong>RÃ©ponse : B</strong> - Polyglot Persistence permet d'optimiser chaque type de donnÃ©es : PostgreSQL pour transactions critiques, MongoDB pour logs/analytics, Redis pour cache, etc.</p>
                    </div>
    
                    <div class="quiz-question">
                        <h4>Question 10 : Quelle couche contient la logique mÃ©tier en architecture MVC/JEE ?</h4>
                        <div class="quiz-options">
                            <label><input type="radio" name="q10" value="a"> A) Controller (Servlet)</label>
                            <label><input type="radio" name="q10" value="b"> B) View (JSP)</label>
                            <label><input type="radio" name="q10" value="c"> C) Service Layer (EJB)</label>
                            <label><input type="radio" name="q10" value="d"> D) DAO</label>
                        </div>
                        <p style="color: green; margin-top: 10px;"><strong>RÃ©ponse : C</strong> - La Service Layer (EJB) contient TOUTE la logique mÃ©tier : validation, orchestration, rÃ¨gles business, gestion des transactions.</p>
                    </div>
    
                </div>
    
                <!-- RÃ‰SUMÃ‰ FINAL -->
                <div class="section">
                    <h2>ğŸ“ RÃ©sumÃ© Final : Ce que Vous Avez Appris</h2>
                    
                    <div class="tech-stack">
                        <div class="tech-card">
                            <h4>JPA AvancÃ©</h4>
                            <p>Relations bidirectionnelles, hÃ©ritage (SINGLE_TABLE, JOINED, TABLE_PER_CLASS), caching L1/L2, JPQL avec JOIN FETCH, Criteria API type-safe</p>
                        </div>
                        
                        <div class="tech-card">
                            <h4>MongoDB</h4>
                            <p>Documents BSON, opÃ©rations CRUD, Aggregation Pipeline ($match, $group, $sort), Embedding vs Referencing, index pour performance</p>
                        </div>
                        
                        <div class="tech-card">
                            <h4>Polyglot Persistence</h4>
                            <p>Combiner SQL (PostgreSQL) et NoSQL (MongoDB) dans une mÃªme application, chaque DB pour son usage optimal</p>
                        </div>
                        
                        <div class="tech-card">
                            <h4>Transactions DistribuÃ©es</h4>
                            <p>JTA avec @TransactionAttribute, Two-Phase Commit (2PC), Saga Pattern avec compensations, gestion de la cohÃ©rence</p>
                        </div>
                        
                        <div class="tech-card">
                            <h4>Architecture MVC</h4>
                            <p>SÃ©paration Servlet (Controller) / EJB (Service) / DAO (Data Access) / JSP (View), injection @EJB, forward vs redirect</p>
                        </div>
                        
                        <div class="tech-card">
                            <h4>JSTL & EL</h4>
                            <p>&lt;c:forEach&gt;, &lt;c:if&gt;, &lt;c:choose&gt;, &lt;fmt:formatDate&gt;, &lt;fmt:formatNumber&gt;, Expression Language ${}, aucun scriptlet Java</p>
                        </div>
                    </div>
    
                    <div class="concept-box" style="margin-top: 40px;">
                        <h4>ğŸ¯ Points ClÃ©s Ã  Retenir Absolument</h4>
                        <ul>
                            <li><strong>JPA N+1</strong> : Toujours utiliser JOIN FETCH ou @EntityGraph pour Ã©viter les requÃªtes multiples</li>
                            <li><strong>MongoDB Aggregation</strong> : Pipeline avec $match, $group, $sort pour analytics puissantes</li>
                            <li><strong>Transactions</strong> : @TransactionAttribute(REQUIRED) sur EJB pour garantir ACID</li>
                            <li><strong>Polyglot</strong> : SQL pour donnÃ©es critiques/structurÃ©es, NoSQL pour logs/analytics/flexibilitÃ©</li>
                            <li><strong>MVC</strong> : SÃ©parer STRICTEMENT Controller/Service/DAO/View (maintenabilitÃ©)</li>
                            <li><strong>Saga Pattern</strong> : Alternative Ã  2PC quand XA non supportÃ© (MongoDB)</li>
                            <li><strong>JSTL</strong> : JAMAIS de scriptlets &lt;% %&gt; en JSP, toujours JSTL/EL</li>
                            <li><strong>Cache JPA</strong> : L1 automatique (session), L2 optionnel (partagÃ©) pour performance</li>
                            <li><strong>Embedding vs Referencing</strong> : Embedding si One-to-Few et accÃ¨s ensemble, Referencing si Many-to-Many</li>
                            <li><strong>Index MongoDB</strong> : CrÃ©er des index sur champs frÃ©quemment recherchÃ©s (timestamp, level, service)</li>
                        </ul>
                    </div>
    
                    <div class="tip-box" style="margin-top: 30px;">
                        <h4>ğŸ’¡ Conseils pour l'Examen / Projet</h4>
                        <ul>
                            <li><strong>Pratiquez le TP final</strong> : C'est un projet complet qui couvre TOUS les concepts</li>
                            <li><strong>Dessinez les architectures</strong> : SchÃ©mas MVC, diagrammes de flux, modÃ¨les de donnÃ©es</li>
                            <li><strong>Expliquez les choix</strong> : Pourquoi Polyglot ?  Pourquoi Saga ? Pourquoi cet index ?</li>
                            <li><strong>Testez en conditions rÃ©elles</strong> : ArrÃªtez une base, forcez des erreurs, vÃ©rifiez les rollbacks</li>
                            <li><strong>Commentez votre code</strong> : Expliquez la logique mÃ©tier, les rÃ¨gles de validation</li>
                            <li><strong>Monitoring</strong> : Ajoutez des logs (System.out ou Logger) Ã  chaque Ã©tape importante</li>
                            <li><strong>Gestion d'erreurs</strong> : try-catch avec messages clairs, pages d'erreur informatives</li>
                        </ul>
                    </div>
                </div>
    
            </div>
    
            <footer>
                <p>&copy; 2025 - Persistence AvancÃ©e & IntÃ©gration JEE</p>
            </footer>
        </div>
    </body>
    </html>
                        
                    